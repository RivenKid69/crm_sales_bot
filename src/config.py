"""
Конфигурация: состояния, интенты, база знаний, шаблоны
"""

# =============================================================================
# ИНТЕНТЫ: КОРНИ СЛОВ (быстрая проверка)
# =============================================================================

INTENT_ROOTS = {
    "greeting": [
        "привет", "здравств", "добр", "хай", "приветств", "салют", "хелло", "хэлло"
    ],
    "price_question": [
        "цен", "стоим", "стоит", "прайс", "почём", "тариф", "расценк", "ценник",
        "бюджет", "деньг", "рубл", "₽", "руб"
    ],
    "objection_price": [
        "дорог", "дешевл", "скидк", "бесплатн", "денег нет", "не потянем"
    ],
    "objection_no_time": [
        "нет времен", "занят", "не сейчас", "позж", "потом", "перезвон"
    ],
    "objection_competitor": [
        "битрикс", "амо", "amocrm", "amo crm", "мегаплан", "salesforce",
        "уже есть", "уже пользу", "используем"
    ],
    "question_features": [
        "функци", "возможност", "умеет", "может", "интеграц", "что делает",
        "как работает", "что включ"
    ],
    "question_integrations": [
        "интеграц", "подключ", "связ", "синхрониз", "1с", "телефон", "почт",
        "whatsapp", "telegram", "битрикс24"
    ],
    "agreement": [
        "интересн", "давайте", "расскажите", "хочу", "готов", "согласен",
        "подходит", "нравится", "да,", "да!", "ок", "хорошо", "годится"
    ],
    "rejection": [
        "не интересн", "не нужн", "не надо", "нет,", "нет!", "отстань",
        "не хочу", "не буд", "отказ", "пока не"
    ],
    "contact_provided": [
        "@", "mail", "почта", "gmail", "yandex", "телефон", "позвон", "номер"
    ],
}

# =============================================================================
# ИНТЕНТЫ: ПОЛНЫЕ ФРАЗЫ (для pymorphy2 fallback)
# =============================================================================

INTENT_PHRASES = {
    "greeting": [
        "привет", "здравствуйте", "добрый день", "доброе утро", "добрый вечер",
        "хай", "приветствую", "салют"
    ],
    "price_question": [
        "сколько стоит", "какая цена", "прайс", "почём", "стоимость",
        "какой ценник", "по деньгам", "какие тарифы", "какие расценки",
        "сколько это будет стоить", "во сколько обойдётся", "какой бюджет нужен"
    ],
    "objection_price": [
        "дорого", "слишком дорого", "дешевле есть", "нет бюджета",
        "не потянем", "денег нет", "дороговато"
    ],
    "objection_no_time": [
        "нет времени", "занят", "не сейчас", "перезвоните позже",
        "давайте потом", "сейчас не могу"
    ],
    "objection_competitor": [
        "уже есть crm", "используем битрикс", "у нас амо", "есть система",
        "уже пользуемся", "работаем в другой"
    ],
    "question_features": [
        "что умеете", "какие функции", "какие возможности", "что может",
        "что включено", "что входит", "как работает"
    ],
    "question_integrations": [
        "какие интеграции", "с чем интегрируется", "подключается ли",
        "есть интеграция с", "работает с 1с"
    ],
    "agreement": [
        "интересно", "давайте", "расскажите", "хочу попробовать", "да",
        "согласен", "подходит", "нравится", "готов", "хочу демо"
    ],
    "rejection": [
        "не интересно", "не нужно", "нет", "отстаньте", "не хочу",
        "не буду", "отказываюсь", "не надо"
    ],
}

# Веса для разных методов классификации
CLASSIFIER_CONFIG = {
    "root_match_weight": 1.0,      # Вес совпадения по корню
    "phrase_match_weight": 2.0,    # Вес точного совпадения фразы
    "lemma_match_weight": 1.5,     # Вес совпадения по лемме
    "high_confidence_threshold": 0.7,  # Порог для быстрого возврата
    "min_confidence": 0.3,         # Минимальная уверенность для unclear
}

# =============================================================================
# СОСТОЯНИЯ И ПЕРЕХОДЫ
# =============================================================================

SALES_STATES = {
    "greeting": {
        "goal": "Поздороваться и узнать чем помочь",
        "required_data": [],
        "transitions": {
            # Переход в qualification только когда клиент сам начинает разговор
            "price_question": "qualification",
            "question_features": "qualification",
            "question_integrations": "qualification",
            "agreement": "qualification",
            "info_provided": "qualification",
            "objection_competitor": "qualification",
            # На rejection сразу мягко закрываем
            "rejection": "soft_close",
        },
        "rules": {
            # На приветствие просто здороваемся
            "greeting": "greet_back",
            # На непонятное — спрашиваем чем помочь
            "unclear": "ask_how_to_help",
        }
    },

    "qualification": {
        "goal": "Узнать размер компании и боль клиента",
        "required_data": ["company_size", "pain_point"],
        "transitions": {
            "data_complete": "presentation",
            "rejection": "soft_close"
        },
        "rules": {
            "price_question": "deflect_and_continue"
        }
    },
    
    "presentation": {
        "goal": "Показать ценность продукта",
        "required_data": [],
        "transitions": {
            "agreement": "close",
            "objection_price": "handle_objection",
            "rejection": "soft_close"
        },
        "rules": {
            "price_question": "answer_with_facts"
        }
    },
    
    "handle_objection": {
        "goal": "Отработать возражение",
        "required_data": [],
        "transitions": {
            "agreement": "close",
            "rejection": "soft_close"
        },
        "rules": {}
    },
    
    "close": {
        "goal": "Взять контакт или назначить демо",
        "required_data": ["contact_info"],
        "transitions": {
            "data_complete": "success",
            "rejection": "soft_close"
        },
        "rules": {}
    },
    
    "success": {
        "goal": "Завершить успешно",
        "is_final": True
    },
    
    "soft_close": {
        "goal": "Вежливо завершить",
        "is_final": True
    }
}

# =============================================================================
# БАЗА ЗНАНИЙ
# =============================================================================

KNOWLEDGE = {
    "pricing": {
        "basic": {"name": "Базовый", "price": 990, "users": "1-5"},
        "team": {"name": "Команда", "price": 790, "users": "6-25"},
        "business": {"name": "Бизнес", "price": 590, "users": "26+"}
    },
    "features": [
        "Воронка продаж",
        "Автоматические напоминания", 
        "История клиента",
        "Отчёты"
    ],
    "discount_annual": 20
}

# =============================================================================
# ШАБЛОНЫ ПРОМПТОВ
# =============================================================================

SYSTEM_PROMPT = """Ты менеджер по продажам CRM-системы.

СТРОГО: Отвечай ТОЛЬКО на русском языке. Никогда не переключайся на другие языки.

Правила общения:
- Говори на "вы", дружелюбно, без давления
- Отвечай кратко: 2-3 предложения максимум
- Задавай только ОДИН вопрос за раз"""

PROMPT_TEMPLATES = {
    "greet_back": """{system}

Задача: Просто поздороваться в ответ и спросить чем можете помочь.
НЕ задавай вопросов о компании или команде — просто узнай что интересует клиента.

Клиент: "{user_message}"

Ответ на русском (1-2 коротких предложения):""",

    "ask_how_to_help": """{system}

Задача: Вежливо спросить чем можете помочь.
НЕ задавай конкретных вопросов — просто узнай что интересует клиента.

Диалог:
{history}

Клиент: "{user_message}"

Ответ на русском (1-2 коротких предложения):""",

    "greeting": """{system}

Задача: Поздороваться и спросить чем можете помочь.
Клиент: "{user_message}"

Ответ на русском (1-2 предложения):""",

    "qualification": """{system}

Задача: Узнать сколько человек работает с клиентами.
Клиент проявил интерес к продукту.

Диалог:
{history}

Клиент: "{user_message}"

Задай ОДИН короткий вопрос о размере команды.
Ответ на русском (1-2 предложения, без приветствия):""",

    "deflect_and_continue": """{system}

Ситуация: Клиент спросил о цене, но мы не знаем размер его команды.
Задача: Мягко уйти от цены, спросить сколько человек будет работать в системе.

Диалог:
{history}

Клиент: "{user_message}"

Задай ОДИН вопрос о размере команды (не о проблемах).
Ответ на русском (1-2 предложения, без приветствия):""",

    "continue_current_goal": """{system}

Уже знаем о клиенте: {collected_data}
Нужно узнать: {missing_data}

Диалог:
{history}

Клиент: "{user_message}"

Если нужно узнать company_size — спроси сколько человек в команде.
Если нужно узнать pain_point — спроси какую задачу хотят решить или что не устраивает сейчас.
Задай только ОДИН вопрос.
Ответ на русском (1-2 предложения, без приветствия):""",

    "presentation": """{system}

Информация о клиенте:
- Размер команды: {company_size} человек
- Проблема: {pain_point}

Наш продукт: {facts}

Задача: Кратко покажи как наш продукт решает именно ЕГО проблему.

Диалог:
{history}

Клиент: "{user_message}"

Ответ на русском (3-4 предложения, без приветствия):""",

    "handle_objection": """{system}

Ситуация: Клиент говорит что дорого.
Информация о клиенте:
- Проблема: {pain_point}
- Размер: {company_size} человек

Наш продукт: {facts}

Задача: Отработай возражение. Используй технику:
- Сравни с ценой проблемы ("сколько теряете на...")
- Или раздели на день/человека
- Упомяни скидку 20% за год

Диалог:
{history}

Клиент: "{user_message}"

Ответ на русском (2-3 предложения, без давления):""",

    "answer_with_facts": """{system}

Клиент спрашивает о продукте. Вот точные данные:
{facts}

Диалог:
{history}

Клиент: "{user_message}"

Ответь точно по фактам, на русском (2-3 предложения):""",

    "soft_close": """{system}

Ситуация: Клиент не заинтересован.
Задача: Вежливо завершить разговор, поблагодарить за время, оставить дверь открытой.

Клиент: "{user_message}"

Ответ на русском (1-2 предложения):""",

    "close": """{system}

Ситуация: Клиент заинтересован.
Задача: Предложить конкретный следующий шаг — демо или тестовый период. Попросить контакт.

Диалог:
{history}

Клиент: "{user_message}"

Ответ на русском (2-3 предложения):"""
}