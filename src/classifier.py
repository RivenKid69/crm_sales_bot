"""
Гибридный классификатор интентов + извлечение данных

Архитектура:
1. Нормализация текста (TextNormalizer)
2. Быстрая проверка по корням слов (INTENT_ROOTS)
3. Если confidence < threshold → fallback на pymorphy2 (лемматизация)
4. Извлечение данных (company_size, pain_point, contact_info) через regex
"""

import re
import difflib
from typing import Dict, List, Tuple, Optional


# =============================================================================
# СЛОВАРИ ДЛЯ НОРМАЛИЗАЦИИ ТЕКСТА
# =============================================================================

# Словарь опечаток и разговорных форм → нормализованные варианты
TYPO_FIXES: Dict[str, str] = {
    # =================================================================
    # ЦЕНОВЫЕ СЛОВА
    # =================================================================
    "ценик": "ценник",
    "ценика": "ценника",
    "цена": "цена",
    "скока": "сколько",
    "скоко": "сколько",
    "скольк": "сколько",
    "почом": "почем",
    "почем": "почем",
    "скидон": "скидка",
    "скидос": "скидка",
    "прайс": "прайс",
    "прайслист": "прайс",
    "прайсик": "прайс",
    "тарифчик": "тариф",
    "тарифы": "тарифы",
    "стоимость": "стоимость",
    "стоит": "стоит",
    "денег": "денег",
    "деняг": "денег",
    "бабла": "денег",
    "бабло": "деньги",
    "бабок": "денег",

    # =================================================================
    # ПРИВЕТСТВИЯ И ПРОЩАНИЯ
    # =================================================================
    "прив": "привет",
    "превед": "привет",
    "приф": "привет",
    "прива": "привет",
    "привки": "привет",
    "хай": "привет",
    "хаюшки": "привет",
    "хеллоу": "привет",
    "здрасте": "здравствуйте",
    "здрасьте": "здравствуйте",
    "здаров": "здравствуйте",
    "здарова": "здравствуйте",
    "дратути": "здравствуйте",
    "доброго": "добрый",
    "добр": "добрый",
    "утречко": "утро",
    "вечерочек": "вечер",
    "денечек": "день",
    "пок": "пока",
    "покеда": "пока",
    "покедова": "пока",
    "бай": "пока",
    "бб": "пока",
    "удачки": "удачи",

    # =================================================================
    # РАЗГОВОРНЫЕ И СЛЕНГОВЫЕ
    # =================================================================
    "че": "что",
    "чо": "что",
    "шо": "что",
    "чего": "что",
    "чет": "что-то",
    "чето": "что-то",
    "чот": "что-то",
    "щас": "сейчас",
    "счас": "сейчас",
    "ща": "сейчас",
    "седня": "сегодня",
    "сегдня": "сегодня",
    "тока": "только",
    "ток": "только",
    "токо": "только",
    "тоже": "тоже",
    "тож": "тоже",
    "ваще": "вообще",
    "вапще": "вообще",
    "вобще": "вообще",
    "вопщем": "в общем",
    "короч": "короче",
    "кароч": "короче",
    "норм": "нормально",
    "нормик": "нормально",
    "ок": "хорошо",
    "окей": "хорошо",
    "океюшки": "хорошо",
    "лан": "ладно",
    "ладн": "ладно",
    "ладушки": "ладно",
    "спс": "спасибо",
    "спсб": "спасибо",
    "пасиб": "спасибо",
    "пасибо": "спасибо",
    "спасиб": "спасибо",
    "плз": "пожалуйста",
    "плиз": "пожалуйста",
    "пжлст": "пожалуйста",
    "пжл": "пожалуйста",
    "пж": "пожалуйста",
    "дап": "да",
    "ага": "да",
    "угу": "да",
    "неа": "нет",
    "непа": "нет",
    "нету": "нет",
    "ну": "ну",
    "нуну": "ну",
    "типо": "типа",
    "типа": "типа",
    "оч": "очень",
    "ооч": "очень",
    "оооч": "очень",
    "канеш": "конечно",
    "канешна": "конечно",
    "конеш": "конечно",
    "наверн": "наверное",
    "наврн": "наверное",
    "мб": "может быть",
    "возм": "возможно",
    "возмжно": "возможно",

    # =================================================================
    # БИЗНЕС-ТЕРМИНЫ
    # =================================================================
    "црм": "crm",
    "срм": "crm",
    "црм": "crm",
    "црмка": "crm",
    "цээрэм": "crm",
    "битрик": "битрикс",
    "битрикс24": "битрикс",
    "амо": "амо",
    "амоцрм": "амо crm",
    "эксель": "excel",
    "эксел": "excel",
    "ексель": "excel",
    "табличка": "таблица",
    "табличку": "таблицу",
    "менеджр": "менеджер",
    "манагер": "менеджер",
    "сейлз": "менеджер по продажам",
    "сэйлз": "менеджер по продажам",
    "продажник": "менеджер по продажам",
    "клиентов": "клиентов",
    "клиентоф": "клиентов",
    "заявка": "заявка",
    "заявочка": "заявка",
    "лид": "лид",
    "лидик": "лид",
    "лидов": "лидов",
    "сделка": "сделка",
    "сделочка": "сделка",
    "контракт": "контракт",
    "договор": "договор",
    "дкп": "договор",

    # =================================================================
    # ЧИСЛИТЕЛЬНЫЕ И ЕДИНИЦЫ
    # =================================================================
    "чел": "человек",
    "челов": "человек",
    "человеек": "человек",
    "человк": "человек",
    "чвек": "человек",
    "сотр": "сотрудник",
    "сотрудн": "сотрудник",
    "штук": "штук",
    "шт": "штук",
    "руб": "рублей",
    "р": "рублей",
    "тыс": "тысяч",
    "к": "тысяч",
    "кк": "миллион",
    "млн": "миллион",
    "лям": "миллион",
    "мес": "месяц",
    "мсц": "месяц",

    # =================================================================
    # ВОПРОСИТЕЛЬНЫЕ
    # =================================================================
    "скажите": "скажите",
    "подскажте": "подскажите",
    "падскажите": "подскажите",
    "подскжите": "подскажите",
    "расскажте": "расскажите",
    "раскажите": "расскажите",

    # =================================================================
    # ОТРИЦАНИЯ И ВОЗРАЖЕНИЯ
    # =================================================================
    "дорга": "дорого",
    "дорага": "дорого",
    "доргао": "дорого",
    "дешево": "дешево",
    "дешивле": "дешевле",
    "интерсно": "интересно",
    "интиресно": "интересно",
    "неинтересно": "не интересно",
    "неинтерсно": "не интересно",
    "ненужно": "не нужно",
    "ненадо": "не надо",

    # =================================================================
    # СЛИПШИЕСЯ СЛОВА (основные)
    # =================================================================
    "сколькостоит": "сколько стоит",
    "какаяцена": "какая цена",
    "какойценник": "какой ценник",
    "скинутьпрайс": "скинуть прайс",
    "естьскидки": "есть скидки",
    "подскажитецену": "подскажите цену",
    "чтопочем": "что почем",
    "какиетарифы": "какие тарифы",
    "какстоимость": "как стоимость",
    "естьдемо": "есть демо",
    "хочудемо": "хочу демо",
    "хочупопробовать": "хочу попробовать",
    "давайтепопробуем": "давайте попробуем",
    "расскажитеподробнее": "расскажите подробнее",
    "ненужноспасибо": "не нужно спасибо",
    "нетспасибо": "нет спасибо",
    "даинтересно": "да интересно",
    "добрыйдень": "добрый день",
    "доброеутро": "доброе утро",
    "добрыйвечер": "добрый вечер",

    # =================================================================
    # РАСКЛАДКА КЛАВИАТУРЫ (латиница → кириллица)
    # =================================================================
    "ghbdtn": "привет",
    "ghbd": "привет",
    "plfhfcndeqnt": "здравствуйте",
    "lj,hsq ltym": "добрый день",
    "crjkmrj cnjbn": "сколько стоит",
    "wtyf": "цена",
    "ghfqc": "прайс",
    "ljhjuj": "дорого",
    "bynthtcyj": "интересно",
    "yt ye;yj": "не нужно",
    "cgfcb,j": "спасибо",
    "lf": "да",
    "ytn": "нет",

    # =================================================================
    # ЭМОЦИИ И ОЦЕНКИ
    # =================================================================
    "збс": "отлично",
    "зашибись": "отлично",
    "заебись": "отлично",
    "заебато": "отлично",
    "четко": "чётко",
    "чётко": "хорошо",
    "чоткий": "чёткий",
    "ништяк": "хорошо",
    "огонь": "отлично",
    "бомба": "отлично",
    "пушка": "отлично",
    "топ": "отлично",
    "топчик": "отлично",
    "кайф": "хорошо",
    "кайфово": "хорошо",
    "изи": "легко",
    "изян": "легко",
    "хз": "не знаю",
    "хез": "не знаю",
    "хрен знает": "не знаю",
    "фиг знает": "не знаю",
    "бля": "",
    "блин": "",
    "блять": "",
    "нафиг": "",
    "нахрен": "",
    "пофиг": "неважно",
    "пофигу": "неважно",
    "похрен": "неважно",
    "похер": "неважно",
    "гавно": "плохо",
    "говно": "плохо",
    "отстой": "плохо",
    "хреново": "плохо",
    "хрень": "плохо",
    "фигня": "ерунда",
    "херня": "ерунда",
    "чушь": "ерунда",
    "бред": "ерунда",

    # =================================================================
    # СОГЛАСИЕ И ПОДТВЕРЖДЕНИЕ
    # =================================================================
    "дак": "да",
    "дада": "да",
    "даа": "да",
    "ну да": "да",
    "ага": "да",
    "агась": "да",
    "угумс": "да",
    "угу": "да",
    "ыгы": "да",
    "йеп": "да",
    "йес": "да",
    "еп": "да",
    "ес": "да",
    "есс": "да",
    "ессно": "естественно",
    "вроде да": "да",
    "думаю да": "да",
    "наверно да": "да",
    "скорее да": "да",
    "типо да": "да",
    "точняк": "точно",
    "точняра": "точно",
    "инфа сотка": "точно",
    "стопудово": "точно",
    "стопроц": "точно",
    "сто проц": "сто процентов",
    "сотка": "сто процентов",
    "базара нет": "конечно",
    "без базара": "конечно",
    "безусловн": "безусловно",
    "однозначн": "однозначно",

    # =================================================================
    # ОТРИЦАНИЕ
    # =================================================================
    "ноуп": "нет",
    "нет нет": "нет",
    "неее": "нет",
    "нееа": "нет",
    "не-а": "нет",
    "не а": "нет",
    "неа": "нет",
    "нее": "нет",
    "нет уж": "нет",
    "ни в коем случае": "нет",
    "ни за что": "нет",
    "нифига": "нет",
    "нихера": "нет",
    "нихрена": "нет",
    "врятли": "вряд ли",
    "врядли": "вряд ли",
    "врятле": "вряд ли",
    "наврядли": "вряд ли",
    "наврятли": "вряд ли",
    "сомневаюс": "сомневаюсь",
    "сомневаюсь": "сомневаюсь",
    "не уверен": "не уверен",
    "хз": "не знаю",
    "незнаю": "не знаю",
    "не знаю": "не знаю",
    "непонятно": "не понятно",

    # =================================================================
    # ВОПРОСЫ И УТОЧНЕНИЯ
    # =================================================================
    "ачо": "а что",
    "ачё": "а что",
    "ашо": "а что",
    "ащо": "а что",
    "чего": "что",
    "чегой": "что",
    "чегой-то": "что-то",
    "чегото": "что-то",
    "кагбе": "как бы",
    "кагбы": "как бы",
    "как бы": "как бы",
    "типо": "типа",
    "типа того": "типа того",
    "ну типо": "ну типа",
    "воти": "вот и",
    "воть": "вот",
    "воот": "вот",
    "вооот": "вот",
    "эт": "это",
    "эта": "это",
    "эт": "это",
    "ента": "это",
    "енто": "это",
    "ето": "это",
    "ну это": "ну это",
    "нут": "ну",
    "нуну": "ну ну",
    "какбе": "как бы",
    "кароче": "короче",
    "вобщем": "в общем",
    "вобщемто": "в общем-то",
    "в общемто": "в общем-то",
    "короч говоря": "короче говоря",
    "если чо": "если что",
    "если шо": "если что",
    "если чё": "если что",
    "есличо": "если что",
    "кста": "кстати",
    "кстате": "кстати",

    # =================================================================
    # ВРЕМЯ И СРОКИ
    # =================================================================
    "завтро": "завтра",
    "завтрева": "завтра",
    "седня": "сегодня",
    "сёдня": "сегодня",
    "щас": "сейчас",
    "ща": "сейчас",
    "счас": "сейчас",
    "сичас": "сейчас",
    "прям щас": "прямо сейчас",
    "прямсейчас": "прямо сейчас",
    "вчера": "вчера",
    "вчира": "вчера",
    "надысь": "на днях",
    "намедни": "на днях",
    "позавчера": "позавчера",
    "позавчира": "позавчера",
    "попозже": "попозже",
    "попозжа": "попозже",
    "позжа": "позже",
    "чуть позже": "чуть позже",
    "черезчас": "через час",
    "черезнеделю": "через неделю",
    "на след неделе": "на следующей неделе",
    "на следнеделе": "на следующей неделе",
    "на след. неделе": "на следующей неделе",
    "вследующем": "в следующем",

    # =================================================================
    # КОЛИЧЕСТВО И РАЗМЕРЫ
    # =================================================================
    "пару": "пара",
    "парочку": "пару",
    "штуки": "штуки",
    "штучки": "штуки",
    "штучек": "штук",
    "несколко": "несколько",
    "нескольк": "несколько",
    "неско": "несколько",
    "много": "много",
    "дофига": "много",
    "дохрена": "много",
    "дохера": "много",
    "мало": "мало",
    "немного": "немного",
    "чуть чуть": "чуть-чуть",
    "чутка": "чуть-чуть",
    "чутьчуть": "чуть-чуть",
    "немножко": "немного",
    "маленько": "немного",
    "множко": "немного",
    "полно": "много",
    "полным полно": "очень много",
    "куча": "много",
    "тонна": "много",
    "туча": "много",
    "уйма": "много",
    "вагон": "много",
    "целый вагон": "очень много",
    "масса": "много",

    # =================================================================
    # ДЕЙСТВИЯ И ГЛАГОЛЫ
    # =================================================================
    "хотелосб": "хотелось бы",
    "хотелосьб": "хотелось бы",
    "хотелосьбы": "хотелось бы",
    "нуна": "нужна",
    "нуну": "нужно",
    "нуну бы": "нужно бы",
    "нада": "надо",
    "надо": "надо",
    "надоб": "надо бы",
    "надо бы": "надо бы",
    "дайти": "дайте",
    "дайти": "дайте",
    "скажите": "скажите",
    "скажити": "скажите",
    "покажыте": "покажите",
    "покажити": "покажите",
    "расскажыте": "расскажите",
    "раскажите": "расскажите",
    "раскажте": "расскажите",
    "обьясните": "объясните",
    "обясните": "объясните",
    "пришлити": "пришлите",
    "вышлите": "вышлите",
    "вышлити": "вышлите",
    "отправти": "отправьте",
    "отпрвте": "отправьте",
    "скинти": "скиньте",
    "скиньти": "скиньте",
    "кинти": "киньте",
    "киньти": "киньте",
    "записыте": "запишите",
    "запишити": "запишите",
    "запиши": "запиши",
    "записуй": "записывай",
    "перезвоните": "перезвоните",
    "перезвоните": "перезвоните",
    "перезвони": "перезвони",
    "набери": "набери",
    "наберу": "наберу",
    "напишу": "напишу",
    "напиш": "напишу",
    "звякну": "позвоню",
    "звякни": "позвони",
    "созвонимс": "созвонимся",
    "созвонимся": "созвонимся",
    "пообщаемс": "пообщаемся",
    "погодь": "подожди",
    "погодите": "подождите",
    "погодь-ка": "подожди-ка",
    "подожь": "подожди",
    "постой": "подожди",
    "постойте": "подождите",
    "погоди": "подожди",
    "сек": "секунду",
    "секунд": "секунду",
    "мин": "минуту",
    "минут": "минуту",
    "минутк": "минутку",

    # =================================================================
    # БИЗНЕС И ПРОДУКТ (расширенные)
    # =================================================================
    "продажники": "менеджеры по продажам",
    "сэйлзы": "менеджеры по продажам",
    "сейлзы": "менеджеры по продажам",
    "манагеры": "менеджеры",
    "менагеры": "менеджеры",
    "менеджера": "менеджеры",
    "рукли": "руководители",
    "ропы": "руководители отдела продаж",
    "роп": "руководитель отдела продаж",
    "директора": "директоры",
    "дир": "директор",
    "генди": "генеральный директор",
    "гендир": "генеральный директор",
    "кормдир": "коммерческий директор",
    "комдир": "коммерческий директор",
    "замдир": "заместитель директора",
    "бухи": "бухгалтеры",
    "бухгалтера": "бухгалтеры",
    "юристы": "юристы",
    "юрики": "юристы",
    "айтишники": "IT-специалисты",
    "программеры": "программисты",
    "прогеры": "программисты",
    "кодеры": "программисты",
    "девелоперы": "разработчики",
    "дизы": "дизайнеры",
    "маркетологи": "маркетологи",
    "маркетолухи": "маркетологи",
    "пиарщики": "PR-специалисты",
    "сммщики": "SMM-специалисты",
    "сммщик": "SMM-специалист",
    "логисты": "логисты",
    "закупщики": "специалисты по закупкам",
    "эйчары": "HR-специалисты",
    "эйчар": "HR-специалист",
    "хрюши": "HR-специалисты",

    # Системы и инструменты
    "амка": "AmoCRM",
    "амо crm": "AmoCRM",
    "амосрм": "AmoCRM",
    "бит24": "Битрикс24",
    "б24": "Битрикс24",
    "битрикс 24": "Битрикс24",
    "битрикс24": "Битрикс24",
    "мегаплн": "Мегаплан",
    "мегаплан": "Мегаплан",
    "сейлсфорс": "Salesforce",
    "салесфорс": "Salesforce",
    "пайпдрайв": "Pipedrive",
    "хабспот": "HubSpot",
    "зохо": "Zoho",
    "свояcrm": "своя CRM",
    "самопис": "самописная система",
    "самописка": "самописная система",
    "экселька": "Excel",
    "эксельки": "Excel",
    "эксель": "Excel",
    "гугл доки": "Google Docs",
    "гугл докс": "Google Docs",
    "гугл шитс": "Google Sheets",
    "гугл таблица": "Google Sheets",
    "гугл таблицы": "Google Sheets",
    "ноушн": "Notion",
    "ноушен": "Notion",
    "трелло": "Trello",
    "асана": "Asana",
    "джира": "Jira",
    "слак": "Slack",
    "слэк": "Slack",
    "зум": "Zoom",
    "телега": "Telegram",
    "тг": "Telegram",
    "вотсап": "WhatsApp",
    "ватсап": "WhatsApp",
    "ватсапп": "WhatsApp",
    "вацап": "WhatsApp",
    "воцап": "WhatsApp",
    "инста": "Instagram",
    "вк": "VK",
    "вконтакте": "VK",
    "вконтакт": "VK",
    "контактик": "VK",
    "фб": "Facebook",
    "фейсбук": "Facebook",

    # Деньги и финансы
    "деньга": "деньги",
    "денюжка": "деньги",
    "денюшка": "деньги",
    "бабло": "деньги",
    "бабки": "деньги",
    "бабос": "деньги",
    "баблишко": "деньги",
    "капуста": "деньги",
    "лавэ": "деньги",
    "лаве": "деньги",
    "кэш": "деньги",
    "кеш": "деньги",
    "налик": "наличные",
    "наличка": "наличные",
    "безнал": "безналичный расчёт",
    "безналом": "безналичным расчётом",
    "картой": "картой",
    "переводом": "переводом",
    "предоплата": "предоплата",
    "предоплатой": "предоплатой",
    "постоплата": "постоплата",
    "постоплатой": "постоплатой",
    "рассрочка": "рассрочка",
    "рассрочкой": "рассрочкой",
    "кредит": "кредит",
    "лизинг": "лизинг",
    "рубасы": "рубли",
    "рублишки": "рубли",
    "рублики": "рубли",
    "тугрики": "деньги",
    "косарь": "тысяча рублей",
    "косарей": "тысяч рублей",
    "штука": "тысяча рублей",
    "штуки": "тысячи рублей",
    "штук": "тысяч рублей",
    "лям": "миллион",
    "ляма": "миллиона",
    "лямов": "миллионов",
    "лямчик": "миллион",
    "мульт": "миллион",
    "мультик": "миллион",
    "ярд": "миллиард",
    "ярдов": "миллиардов",

    # =================================================================
    # ТРАНСЛИТ (латиница → кириллица)
    # =================================================================
    "privet": "привет",
    "prevet": "привет",
    "hello": "привет",
    "hi": "привет",
    "hey": "привет",
    "skolko": "сколько",
    "skolko stoit": "сколько стоит",
    "cena": "цена",
    "price": "прайс",
    "prays": "прайс",
    "dorogo": "дорого",
    "deshevo": "дешево",
    "interesno": "интересно",
    "ne interesno": "не интересно",
    "ne nado": "не надо",
    "ne nuzhno": "не нужно",
    "da": "да",
    "net": "нет",
    "ok": "хорошо",
    "okay": "хорошо",
    "good": "хорошо",
    "cool": "круто",
    "nice": "хорошо",
    "super": "супер",
    "spasibo": "спасибо",
    "thanks": "спасибо",
    "thx": "спасибо",
    "tnx": "спасибо",
    "pozhaluysta": "пожалуйста",
    "please": "пожалуйста",
    "pls": "пожалуйста",
    "sorry": "извините",
    "demo": "демо",
    "test": "тест",
    "free": "бесплатно",
    "trial": "пробный период",
    "crm": "CRM",
    "manager": "менеджер",
    "sales": "продажи",
    "lead": "лид",
    "client": "клиент",
    "customer": "клиент",
    "deal": "сделка",
    "pipeline": "воронка",
    "funnel": "воронка",

    # =================================================================
    # РАСШИРЕННАЯ РАСКЛАДКА КЛАВИАТУРЫ (EN→RU)
    # =================================================================
    # Приветствия
    "ghbdtn": "привет",
    "ghbdtnbr": "приветик",
    "ljhjq ltym": "добрый день",
    "ljhjt enhj": "доброе утро",
    "ljhjq dtxth": "добрый вечер",
    "plfhfdcndeqnt": "здравствуйте",
    "plfhjdf": "здорова",
    "rfr ltkf": "как дела",

    # Вопросы о цене
    "wtyf": "цена",
    "crjkmrj cnjbn": "сколько стоит",
    "ghfqc": "прайс",
    "nfhba": "тариф",
    "nfhbas": "тарифы",
    "crblrf": "скидка",
    "ltitdkt": "дешевле",

    # Возражения
    "ljhjuj": "дорого",
    "yt yflj": "не надо",
    "yt ye;yj": "не нужно",
    "yt bynthtcyj": "не интересно",
    "pfyzn": "занят",
    "ytn dhtvtyb": "нет времени",
    "ytn ,bl;tnf": "нет бюджета",

    # Согласие
    "lf": "да",
    "ytn": "нет",
    "jrfq": "окей",
    "kflyj": "ладно",
    "cjukfcty": "согласен",
    "bynthtcyj": "интересно",
    "lfdfqnt": "давайте",
    "gjrfpbnt": "покажите",
    "hfccrf;bnt": "расскажите",
    "ltvj": "демо",

    # Другое
    "cgfcb,j": "спасибо",
    "gj;fkeqcnf": "пожалуйста",
    "gjrf": "пока",
    "ljcdblfybz": "до свидания",

    # =================================================================
    # ЭМОДЗИ-СЛОВА И СОКРАЩЕНИЯ
    # =================================================================
    "лол": "смешно",
    "lol": "смешно",
    "ржу": "смешно",
    "ржунемогу": "очень смешно",
    "кек": "смешно",
    "kek": "смешно",
    "ору": "смешно",
    "орнул": "засмеялся",
    "сасный": "классный",
    "красава": "молодец",
    "красавчик": "молодец",
    "красавец": "молодец",
    "респект": "уважение",
    "респ": "уважение",
    "рофл": "шутка",
    "изи катка": "легко",
    "имба": "круто",
    "чилл": "расслабься",
    "чилить": "отдыхать",
    "жиза": "жизненно",
    "лайк": "нравится",
    "лайкосик": "нравится",
    "фейл": "ошибка",
    "зафейлил": "ошибся",
    "войс": "голосовое сообщение",
    "скрин": "скриншот",
    "скриншот": "скриншот",
    "скриншотик": "скриншот",
    "ссыль": "ссылка",
    "ссылочка": "ссылка",
    "линк": "ссылка",
    "урл": "ссылка",
    "юрл": "ссылка",
    "qr": "QR-код",
    "кюар": "QR-код",
}

# Паттерны для разбиения слипшихся слов (regex)
SPLIT_PATTERNS: List[Tuple[str, str]] = [
    # =================================================================
    # ВОПРОСЫ О ЦЕНЕ И ХАРАКТЕРИСТИКАХ
    # =================================================================
    (r'сколько(\w)', r'сколько \1'),
    (r'какая(\w)', r'какая \1'),
    (r'какой(\w)', r'какой \1'),
    (r'какие(\w)', r'какие \1'),
    (r'какую(\w)', r'какую \1'),
    (r'каких(\w)', r'каких \1'),
    (r'почему(\w)', r'почему \1'),
    (r'почём(\w)', r'почём \1'),
    (r'зачем(\w)', r'зачем \1'),
    (r'откуда(\w)', r'откуда \1'),
    (r'куда(\w{3,})', r'куда \1'),
    (r'когда(\w)', r'когда \1'),
    (r'где(\w{3,})', r'где \1'),
    (r'кто(\w{3,})', r'кто \1'),

    # =================================================================
    # ГЛАГОЛЫ ДЕЙСТВИЙ
    # =================================================================
    (r'есть(\w)', r'есть \1'),
    (r'хочу(\w)', r'хочу \1'),
    (r'хотим(\w)', r'хотим \1'),
    (r'хотел(\w)', r'хотел \1'),
    (r'хотелось(\w)', r'хотелось \1'),
    (r'нужно(\w)', r'нужно \1'),
    (r'нужна(\w)', r'нужна \1'),
    (r'нужны(\w)', r'нужны \1'),
    (r'можно(\w)', r'можно \1'),
    (r'можете(\w)', r'можете \1'),
    (r'могу(\w)', r'могу \1'),
    (r'давайте(\w)', r'давайте \1'),
    (r'давай(\w{3,})', r'давай \1'),
    (r'скинуть(\w)', r'скинуть \1'),
    (r'скиньте(\w)', r'скиньте \1'),
    (r'расскажите(\w)', r'расскажите \1'),
    (r'расскажи(\w)', r'расскажи \1'),
    (r'подскажите(\w)', r'подскажите \1'),
    (r'подскажи(\w)', r'подскажи \1'),
    (r'покажите(\w)', r'покажите \1'),
    (r'покажи(\w)', r'покажи \1'),
    (r'объясните(\w)', r'объясните \1'),
    (r'объясни(\w)', r'объясни \1'),
    (r'пришлите(\w)', r'пришлите \1'),
    (r'отправьте(\w)', r'отправьте \1'),
    (r'вышлите(\w)', r'вышлите \1'),
    (r'запишите(\w)', r'запишите \1'),
    (r'запиши(\w)', r'запиши \1'),
    (r'позвоните(\w)', r'позвоните \1'),
    (r'перезвоните(\w)', r'перезвоните \1'),
    (r'напишите(\w)', r'напишите \1'),
    (r'скажите(\w)', r'скажите \1'),
    (r'уточните(\w)', r'уточните \1'),

    # =================================================================
    # МОДАЛЬНЫЕ И ВСПОМОГАТЕЛЬНЫЕ
    # =================================================================
    (r'буду(\w)', r'буду \1'),
    (r'будем(\w)', r'будем \1'),
    (r'будет(\w)', r'будет \1'),
    (r'будут(\w)', r'будут \1'),
    (r'было(\w{3,})', r'было \1'),
    (r'была(\w{3,})', r'была \1'),
    (r'были(\w{3,})', r'были \1'),
    (r'надо(\w{3,})', r'надо \1'),
    (r'пора(\w{3,})', r'пора \1'),
    (r'стоит(\w{3,})', r'стоит \1'),

    # =================================================================
    # ПРИВЕТСТВИЯ И ПРОЩАНИЯ
    # =================================================================
    (r'добрый(\w)', r'добрый \1'),
    (r'доброе(\w)', r'доброе \1'),
    (r'доброго(\w)', r'доброго \1'),
    (r'привет(\w{3,})', r'привет \1'),
    (r'здравствуйте(\w)', r'здравствуйте \1'),
    (r'здрасте(\w)', r'здрасте \1'),
    (r'пока(\w{3,})', r'пока \1'),  # минимум 3, чтобы не ломать "показать"
    (r'досвидания(\w)', r'до свидания \1'),

    # =================================================================
    # ОТРИЦАНИЯ
    # =================================================================
    (r'не(\w{3,})', r'не \1'),  # минимум 3 буквы после "не"
    (r'нет(\w{3,})', r'нет \1'),
    (r'ни(\w{3,})', r'ни \1'),
    (r'без(\w{3,})', r'без \1'),

    # =================================================================
    # СОЮЗЫ И ПРЕДЛОГИ
    # =================================================================
    (r'что(\w{3,})', r'что \1'),
    (r'как(\w{3,})', r'как \1'),
    (r'так(\w{3,})', r'так \1'),
    (r'чтобы(\w)', r'чтобы \1'),
    (r'потому(\w)', r'потому \1'),
    (r'поэтому(\w)', r'поэтому \1'),
    (r'если(\w{3,})', r'если \1'),
    (r'когда(\w)', r'когда \1'),
    (r'пока(\w{4,})', r'пока \1'),
    (r'чем(\w{3,})', r'чем \1'),
    (r'или(\w{3,})', r'или \1'),
    (r'либо(\w{3,})', r'либо \1'),
    (r'также(\w)', r'также \1'),
    (r'тоже(\w{3,})', r'тоже \1'),
    (r'вот(\w{3,})', r'вот \1'),
    (r'это(\w{3,})', r'это \1'),
    (r'этот(\w{3,})', r'этот \1'),
    (r'эта(\w{3,})', r'эта \1'),

    # =================================================================
    # НАРЕЧИЯ ВРЕМЕНИ И МЕСТА
    # =================================================================
    (r'сейчас(\w)', r'сейчас \1'),
    (r'потом(\w{3,})', r'потом \1'),
    (r'завтра(\w)', r'завтра \1'),
    (r'сегодня(\w)', r'сегодня \1'),
    (r'вчера(\w)', r'вчера \1'),
    (r'здесь(\w)', r'здесь \1'),
    (r'тут(\w{3,})', r'тут \1'),
    (r'там(\w{3,})', r'там \1'),
    (r'везде(\w)', r'везде \1'),
    (r'всегда(\w)', r'всегда \1'),
    (r'никогда(\w)', r'никогда \1'),
    (r'иногда(\w)', r'иногда \1'),

    # =================================================================
    # ОЦЕНОЧНЫЕ И ЭМОЦИОНАЛЬНЫЕ
    # =================================================================
    (r'очень(\w)', r'очень \1'),
    (r'слишком(\w)', r'слишком \1'),
    (r'просто(\w{3,})', r'просто \1'),
    (r'только(\w)', r'только \1'),
    (r'уже(\w{3,})', r'уже \1'),
    (r'ещё(\w{3,})', r'ещё \1'),
    (r'еще(\w{3,})', r'еще \1'),
    (r'вообще(\w)', r'вообще \1'),
    (r'конечно(\w)', r'конечно \1'),
    (r'наверное(\w)', r'наверное \1'),
    (r'возможно(\w)', r'возможно \1'),
    (r'обязательно(\w)', r'обязательно \1'),
    (r'действительно(\w)', r'действительно \1'),

    # =================================================================
    # СОГЛАСИЕ И ПОДТВЕРЖДЕНИЕ
    # =================================================================
    # НЕ добавляем (r'да(\w)', r'да \1') - ломает "давайте" → "да вайте"
    (r'ладно(\w)', r'ладно \1'),
    (r'хорошо(\w)', r'хорошо \1'),
    (r'отлично(\w)', r'отлично \1'),
    (r'супер(\w{3,})', r'супер \1'),
    (r'окей(\w)', r'окей \1'),
    (r'согласен(\w)', r'согласен \1'),
    (r'понял(\w{3,})', r'понял \1'),
    (r'понятно(\w)', r'понятно \1'),

    # =================================================================
    # БИЗНЕС-ТЕРМИНЫ
    # =================================================================
    (r'прайс(\w)', r'прайс \1'),
    (r'тариф(\w{3,})', r'тариф \1'),
    (r'цена(\w)', r'цена \1'),
    (r'стоимость(\w)', r'стоимость \1'),
    (r'скидка(\w)', r'скидка \1'),
    (r'демо(\w{3,})', r'демо \1'),
    (r'тест(\w{3,})', r'тест \1'),
    (r'пробный(\w)', r'пробный \1'),
    (r'бесплатно(\w)', r'бесплатно \1'),
    (r'интеграция(\w)', r'интеграция \1'),
    (r'функция(\w)', r'функция \1'),
    (r'возможность(\w)', r'возможность \1'),
    (r'поддержка(\w)', r'поддержка \1'),

    # =================================================================
    # ЧАСТЫЕ СЛИПАНИЯ (конкретные фразы)
    # =================================================================
    # Эти обрабатываются в TYPO_FIXES, но дублируем для надёжности
    (r'добрыйдень', r'добрый день'),
    (r'доброеутро', r'доброе утро'),
    (r'добрыйвечер', r'добрый вечер'),
    (r'сколькостоит', r'сколько стоит'),
    (r'какаяцена', r'какая цена'),
    (r'естьскидки', r'есть скидки'),
    (r'хочупопробовать', r'хочу попробовать'),
    (r'давайтепопробуем', r'давайте попробуем'),
    (r'неинтересно', r'не интересно'),
    (r'ненужно', r'не нужно'),
    (r'ненадо', r'не надо'),
    (r'нетспасибо', r'нет спасибо'),
    (r'дазапишите', r'да запишите'),
    (r'даинтересно', r'да интересно'),
    (r'хочудемо', r'хочу демо'),
    (r'расскажитеподробнее', r'расскажите подробнее'),
    (r'покажитекакработает', r'покажите как работает'),
    (r'скинутьпрайс', r'скинуть прайс'),
    (r'какиетарифы', r'какие тарифы'),
    (r'естьдемо', r'есть демо'),
    (r'естьпробный', r'есть пробный'),
    (r'сколькоменеджеров', r'сколько менеджеров'),
    (r'сколькочеловек', r'сколько человек'),
    (r'вашисистемы', r'ваши системы'),
    (r'вашпродукт', r'ваш продукт'),
    (r'вашаcrm', r'ваша crm'),
    (r'какподключить', r'как подключить'),
    (r'какначать', r'как начать'),
    (r'какработает', r'как работает'),
    (r'чтовходит', r'что входит'),
    (r'чтоумеет', r'что умеет'),
    (r'чтоможет', r'что может'),
    (r'какиефункции', r'какие функции'),
    (r'какиевозможности', r'какие возможности'),
    (r'естьинтеграция', r'есть интеграция'),
    (r'работаетс1с', r'работает с 1с'),
    (r'интеграциястелефонией', r'интеграция с телефонией'),
]


class TextNormalizer:
    """
    Нормализатор текста для русскоязычных сообщений

    Обрабатывает:
    - Регистр и пробелы
    - Ё → Е
    - Повторяющиеся буквы
    - Опечатки и сленг
    - Слипшиеся слова
    """

    def __init__(self):
        self.typo_fixes = TYPO_FIXES
        self.split_patterns = SPLIT_PATTERNS
        # Предкомпилированные regex для производительности
        self._compiled_splits = [(re.compile(p), r) for p, r in self.split_patterns]
        # Regex для повторяющихся БУКВ (3+ подряд → 2), НЕ цифр!
        self._repeated_chars = re.compile(r'([а-яёa-z])\1{2,}', re.IGNORECASE)
        # Regex для множественных пробелов
        self._multiple_spaces = re.compile(r'\s+')

    def normalize(self, text: str) -> str:
        """
        Полная нормализация текста

        Этапы:
        1. lower() + strip()
        2. Ё → Е
        3. Убрать повторяющиеся буквы: "приииивет" → "привет"
        4. Убрать лишние пробелы
        5. Исправить слипшиеся слова
        6. Исправить опечатки

        Args:
            text: Исходный текст

        Returns:
            Нормализованный текст
        """
        if not text:
            return ""

        # 1. Базовая нормализация
        result = text.lower().strip()

        # 2. Ё → Е
        result = result.replace('ё', 'е')

        # 3. Убираем повторяющиеся буквы (3+ → 1, потом слово проверим)
        # Сначала сжимаем до 2 букв, потом до 1 если слово не в словаре
        result = self._reduce_repeated_chars(result)

        # 4. Нормализуем пробелы
        result = self._multiple_spaces.sub(' ', result).strip()

        # 5. Разбиваем слипшиеся слова (regex паттерны)
        result = self._apply_split_patterns(result)

        # 6. Исправляем опечатки (по словарю)
        result = self._fix_typos(result)

        # Финальная очистка пробелов
        result = self._multiple_spaces.sub(' ', result).strip()

        return result

    def _reduce_repeated_chars(self, text: str) -> str:
        """
        Убираем повторяющиеся буквы

        "приииивет" → "привет"
        "скооолько" → "сколько"
        "даааа" → "да"
        """
        # Сначала сжимаем 3+ повторов до 2
        result = self._repeated_chars.sub(r'\1\1', text)

        # Затем пробуем сжать до 1, если это даёт валидное слово
        words = result.split()
        normalized_words = []

        for word in words:
            # Пробуем варианты с одинарными буквами (только буквы, не цифры!)
            single_char = re.sub(r'([а-яёa-z])\1+', r'\1', word, flags=re.IGNORECASE)

            # Если слово в словаре опечаток — берём его
            if single_char in self.typo_fixes:
                normalized_words.append(single_char)
            elif word in self.typo_fixes:
                normalized_words.append(word)
            else:
                # Пробуем single_char как более вероятный вариант
                # для русских слов двойные буквы редки
                normalized_words.append(single_char)

        return ' '.join(normalized_words)

    def _apply_split_patterns(self, text: str) -> str:
        """Применяем паттерны разбиения слипшихся слов"""
        result = text

        # Сначала проверяем полные слова в словаре
        words = result.split()
        fixed_words = []

        for word in words:
            # Если слово целиком есть в словаре опечаток — подставляем
            if word in self.typo_fixes:
                fixed_words.append(self.typo_fixes[word])
            else:
                fixed_words.append(word)

        result = ' '.join(fixed_words)

        # Затем применяем regex паттерны
        for pattern, replacement in self._compiled_splits:
            result = pattern.sub(replacement, result)

        return result

    def _fix_typos(self, text: str) -> str:
        """Исправляем опечатки по словарю"""
        words = text.split()
        fixed_words = []

        for word in words:
            # Убираем пунктуацию для поиска
            clean_word = re.sub(r'[^\w]', '', word)

            if clean_word in self.typo_fixes:
                # Сохраняем пунктуацию
                prefix = ''
                suffix = ''
                if word and not word[0].isalnum():
                    prefix = word[0]
                if word and not word[-1].isalnum():
                    suffix = word[-1]
                fixed_words.append(prefix + self.typo_fixes[clean_word] + suffix)
            else:
                fixed_words.append(word)

        return ' '.join(fixed_words)

    def fuzzy_match(self, word: str, targets: List[str], threshold: float = 0.75) -> Optional[str]:
        """
        Нечёткий поиск ближайшего слова

        Args:
            word: Искомое слово
            targets: Список целевых слов
            threshold: Минимальный порог схожести (0.0-1.0)

        Returns:
            Ближайшее слово если similarity >= threshold, иначе None
        """
        if not word or not targets:
            return None

        best_match = None
        best_ratio = 0.0

        for target in targets:
            ratio = difflib.SequenceMatcher(None, word.lower(), target.lower()).ratio()
            if ratio > best_ratio and ratio >= threshold:
                best_ratio = ratio
                best_match = target

        return best_match

    def suggest_correction(self, word: str, threshold: float = 0.7) -> Optional[str]:
        """
        Предлагает исправление для неизвестного слова

        Использует fuzzy matching по словарю опечаток
        """
        return self.fuzzy_match(word, list(self.typo_fixes.keys()), threshold)

try:
    from pymorphy3 import MorphAnalyzer
    PYMORPHY_AVAILABLE = True
except ImportError:
    try:
        from pymorphy2 import MorphAnalyzer
        PYMORPHY_AVAILABLE = True
    except ImportError:
        PYMORPHY_AVAILABLE = False
        MorphAnalyzer = None
        print("[WARNING] pymorphy2/pymorphy3 не установлен. Fallback на лемматизацию недоступен.")

from config import (
    INTENT_ROOTS,
    INTENT_PHRASES,
    CLASSIFIER_CONFIG
)


# =============================================================================
# ПРИОРИТЕТНЫЕ ПАТТЕРНЫ (проверяются ПЕРЕД обычной классификацией)
# =============================================================================
# Эти паттерны решают проблему когда "не интересно" ловится как "agreement"
# из-за корня "интересн", хотя по смыслу это rejection

PRIORITY_PATTERNS: List[Tuple[str, str, float]] = [
    # (pattern, intent, confidence)
    # ВАЖНО: Порядок паттернов имеет значение! Первый совпавший выигрывает.

    # =================================================================
    # CALLBACK REQUEST (запрос обратного звонка)
    # =================================================================
    (r'(?:перезвон|позвон)\w*\s*(?:мне|нам)', "callback_request", 0.95),
    (r'(?:можете|можно)\s*(?:перезвон|позвон)', "callback_request", 0.9),
    (r'(?:жду|ожидаю)\s*(?:звонк|вашего?\s*звонк)', "callback_request", 0.9),
    (r'(?:свяжитесь|связаться)\s*(?:со?\s*мной|с\s*нами)', "callback_request", 0.9),
    (r'(?:набери|наберите)\s*(?:меня|мне|нас)', "callback_request", 0.9),
    (r'вот\s*(?:мой\s*)?(?:номер|телефон|контакт)', "callback_request", 0.85),
    (r'(?:звони|звоните)\s*(?:на|по)\s*(?:этот|этому)', "callback_request", 0.85),
    (r'запиши\w*\s*(?:мой\s*)?(?:номер|телефон)', "callback_request", 0.85),

    # =================================================================
    # DEMO REQUEST (запрос демо)
    # =================================================================
    (r'(?:хочу|хотим|нужн\w*|дайте|покажите)\s*демо', "demo_request", 0.95),
    (r'(?:можно|можете)\s*(?:показать|провести)\s*демо', "demo_request", 0.9),
    (r'демо\s*(?:версию?|доступ|период)', "demo_request", 0.9),
    (r'(?:запишите|запиши)\s*(?:на|меня\s*на)\s*демо', "demo_request", 0.95),
    (r'(?:хочу|хотим)\s*посмотреть\s*(?:как\s*работает|систему|продукт)', "demo_request", 0.85),
    (r'(?:покажите|покажи)\s*(?:как\s*работает|в\s*действии|на\s*примере)', "demo_request", 0.9),
    (r'(?:можно|хочу)\s*(?:попробовать|потестить|потестировать)', "demo_request", 0.9),
    (r'(?:есть|дайте)\s*(?:пробн\w*|тестов\w*)\s*(?:период|версию?|доступ)', "demo_request", 0.9),
    (r'(?:trial|триал|тест\w*\s*драйв)', "demo_request", 0.9),
    (r'бесплатн\w*\s*(?:период|доступ|версию?)', "demo_request", 0.85),

    # =================================================================
    # CONSULTATION REQUEST (запрос консультации)
    # =================================================================
    (r'(?:нужн\w*|хочу|хотим)\s*консультаци', "consultation_request", 0.9),
    (r'(?:можно|можете)\s*проконсультировать', "consultation_request", 0.9),
    (r'(?:хотел|хотела)\s*бы\s*(?:обсудить|поговорить|посоветоваться)', "consultation_request", 0.85),
    (r'(?:нужен|нужна)\s*(?:совет|помощь|консультант)', "consultation_request", 0.85),
    (r'(?:посоветуйте|порекомендуйте|подскажите)\s*(?:что|как|какой)', "consultation_request", 0.85),
    (r'(?:помогите|помоги)\s*(?:разобраться|понять|выбрать)', "consultation_request", 0.85),
    (r'(?:у\s*меня|есть)\s*(?:вопрос|вопросы)\s*(?:по|о|про)', "consultation_request", 0.8),

    # =================================================================
    # COMPARISON (сравнение с конкурентами)
    # =================================================================
    (r'(?:чем\s*)?(?:лучше|хуже|отличаетесь?)\s*(?:от|чем)\s*(?:\w+)', "comparison", 0.9),
    (r'(?:сравн\w*|разниц\w*)\s*(?:с|между|от)\s*(?:амо|битрикс|мегаплан)', "comparison", 0.9),
    (r'(?:почему|зачем)\s*(?:вы|вас|ваш\w*)\s*(?:а\s*не|вместо)', "comparison", 0.85),
    (r'(?:амо|битрикс|мегаплан|salesforce)\s*(?:или|vs|против)\s*(?:вы|вас|ваш)', "comparison", 0.9),
    (r'(?:вы|ваш\w*)\s*(?:или|vs|против)\s*(?:амо|битрикс|мегаплан)', "comparison", 0.9),
    (r'(?:преимуществ\w*|плюс\w*)\s*(?:перед|над|по\s*сравнению)', "comparison", 0.85),
    (r'(?:минус\w*|недостатк\w*)\s*(?:по\s*сравнению|относительно)', "comparison", 0.85),
    (r'(?:что\s*)?(?:есть|умеет)\s*(?:у\s*вас|ваш\w*)\s*(?:чего\s*нет|что\s*нет)\s*(?:у|в)', "comparison", 0.9),

    # =================================================================
    # PRICING DETAILS (детали по ценообразованию)
    # =================================================================
    (r'(?:из\s*чего|как)\s*складывается\s*(?:цена|стоимость)', "pricing_details", 0.9),
    (r'(?:что\s*)?входит\s*в\s*(?:стоимость|цену|тариф|пакет)', "pricing_details", 0.9),
    (r'(?:есть|дайте)\s*(?:прайс|прайс-лист|расчёт|расчет)', "pricing_details", 0.9),
    (r'(?:скидк\w*|акци\w*)\s*(?:есть|какие|бывают)', "pricing_details", 0.85),
    (r'(?:минимальн\w*|базов\w*)\s*(?:пакет|тариф|цена|стоимость)', "pricing_details", 0.85),
    (r'(?:сколько|какая\s*цена)\s*(?:за|на)\s*(?:одного|одно|1)\s*(?:пользовател|рабочее\s*место|лицензи)', "pricing_details", 0.9),
    (r'(?:оплата|платёж)\s*(?:помесячн\w*|ежемесячн\w*|годов\w*|разов\w*)', "pricing_details", 0.85),
    (r'(?:рассрочк\w*|кредит\w*|отсрочк\w*)\s*(?:есть|возможн\w*|даёте)', "pricing_details", 0.85),
    (r'(?:условия|способ\w*)\s*оплат', "pricing_details", 0.8),

    # =================================================================
    # PRODUCT QUESTIONS (вопросы о продукте)
    # =================================================================
    (r'что\s+такое', "question_features", 0.9),
    (r'что\s+это\s+за', "question_features", 0.9),
    (r'что\s+за\s+\w+', "question_features", 0.85),
    (r'рас+каж\w*\s+(?:о|про|об)\b', "question_features", 0.9),
    (r'подробн\w*\s+(?:о|про|об)\b', "question_features", 0.85),
    (r'\w+\s+что\s+это', "question_features", 0.85),
    (r'хо[чт]\w*\s+узнать\s+(?:о|про|об)\b', "question_features", 0.85),
    (r'что\s+(?:вы\s+)?предлага', "question_features", 0.85),
    (r'чем\s+(?:вы\s+)?заним', "question_features", 0.9),
    (r'(?:ваша\s+)?компани[яю]\s+(?:делает|заним)', "question_features", 0.9),
    (r'чем\s+(?:вы\s+)?(?:делаете|занят)', "question_features", 0.9),
    # Дополнительные вопросы о продукте
    (r'(?:как|каким\s*образом)\s*(?:это\s*)?работает', "question_features", 0.85),
    (r'(?:какие|что\s*за)\s*(?:функци\w*|возможност\w*|фич\w*)', "question_features", 0.85),
    (r'(?:умеет|может|способн\w*)\s*(?:ли|ваш\w*)', "question_features", 0.8),
    (r'(?:для\s*чего|зачем)\s*(?:это|нужн\w*|использу)', "question_features", 0.85),
    (r'(?:кому|для\s*кого)\s*(?:подходит|предназначен|это)', "question_features", 0.85),
    (r'(?:есть\s*ли|имеется?\s*ли)\s*\w+', "question_features", 0.8),
    (r'(?:поддержива\w*|работает\s*ли)\s*(?:с|на|в)\s*\w+', "question_features", 0.8),

    # =================================================================
    # CLARIFICATION (уточнение — "нет" + позитивный контекст)
    # =================================================================
    (r'нет,?\s*кое[\s\-]?(?:что|чего)', "agreement", 0.9),
    (r'нет,?\s*(?:мне|нам)\s*(?:нужн|интересн|хоч)', "agreement", 0.9),
    (r'нет,?\s*я\s*хо[чт]', "agreement", 0.9),
    (r'нет,?\s*но\s', "agreement", 0.85),
    (r'нет,?\s*не\s*вс[еёо]', "agreement", 0.85),
    (r'нет,?\s*(?:только|конкретн|именно|определ)', "agreement", 0.9),
    (r'нет,?\s*друг', "agreement", 0.85),
    (r'нет,?\s*(?:расскажите|покажите|объясните)', "agreement", 0.9),
    # Дополнительные уточнения
    (r'нет,?\s*(?:подожди|подождите|стоп|погоди)', "agreement", 0.85),
    (r'нет,?\s*(?:я\s*имел|имею)\s*в\s*виду', "agreement", 0.9),
    (r'нет,?\s*(?:не\s*так|не\s*то|не\s*это)', "agreement", 0.85),
    (r'нет,?\s*(?:вопрос\s*)?(?:в\s*другом|о\s*другом)', "agreement", 0.85),
    (r'нет,?\s*(?:а\s*)?(?:можно|можете)\s*\w+', "agreement", 0.85),

    # =================================================================
    # REJECTION (отказы с отрицанием)
    # =================================================================
    (r'не\s*интересн', "rejection", 0.9),
    (r'неинтересн', "rejection", 0.9),
    (r'не\s*нужн', "rejection", 0.9),
    (r'ненужн', "rejection", 0.9),
    (r'не\s*надо', "rejection", 0.9),
    (r'ненадо', "rejection", 0.9),
    (r'не\s*хо[чт]', "rejection", 0.85),
    (r'не\s*буд', "rejection", 0.85),
    (r'нет,?\s*спасибо', "rejection", 0.9),
    (r'спасибо,?\s*не\s*(?:надо|нужн)', "rejection", 0.9),
    # Дополнительные отказы
    (r'(?:это\s*)?(?:спам|реклама|развод)', "rejection", 0.95),
    (r'(?:отписать|удалить|исключить)\s*(?:меня|нас|мой)', "rejection", 0.95),
    (r'(?:больше\s*)?(?:не\s*пишите|не\s*звоните|не\s*беспокойте)', "rejection", 0.95),
    (r'(?:уберите|удалите)\s*(?:мой|меня|наш)', "rejection", 0.9),
    (r'(?:в\s*бан|заблокиру|блокиру)', "rejection", 0.95),
    (r'(?:отстань|отвали|отвяжи|достал|надоел)', "rejection", 0.95),
    (r'(?:прекрати|хватит|стоп)\s*(?:писать|звонить|спамить)', "rejection", 0.95),
    (r'(?:не\s*)?(?:актуальн\w*\s*)?(?:больше\s*)?не\s*(?:актуальн|релевантн)', "rejection", 0.85),
    (r'(?:мимо|не\s*по\s*адресу|не\s*туда)', "rejection", 0.85),
    (r'(?:вы\s*)?(?:ошиблись|не\s*тот|не\s*туда|не\s*ко\s*мне)', "rejection", 0.85),
    (r'у\s*(?:меня|нас)\s*(?:всё|все)\s*(?:есть|хорошо|норм)', "rejection", 0.8),
    (r'(?:справля|обход)\w*\s*(?:сами|без\s*вас|своими)', "rejection", 0.8),

    # =================================================================
    # OBJECTION_PRICE (возражения по цене)
    # =================================================================
    (r'нет\s*бюджет', "objection_price", 0.9),
    (r'бюджет\w*\s*нет', "objection_price", 0.9),
    (r'без\s*бюджет', "objection_price", 0.85),
    (r'не\s*залож\w*\s*(?:в\s*)?бюджет', "objection_price", 0.85),
    (r'денег\s*нет', "objection_price", 0.9),
    (r'нет\s*денег', "objection_price", 0.9),
    (r'не\s*потян', "objection_price", 0.85),
    # Дополнительные ценовые возражения
    (r'(?:слишком|очень|чересчур)\s*(?:дорого|дороговато)', "objection_price", 0.9),
    (r'(?:цена|ценник|прайс)\s*(?:кусается|кусачий|жирный|высокий)', "objection_price", 0.9),
    (r'(?:для\s*нас|нам)\s*(?:дорого|дороговато|накладно)', "objection_price", 0.9),
    (r'(?:не\s*)?по\s*карман', "objection_price", 0.85),
    (r'(?:финанс\w*|средств)\s*(?:нет|не\s*хватает|ограничен)', "objection_price", 0.85),
    (r'(?:урезали|сократили|нет)\s*(?:бюджет|финансирован)', "objection_price", 0.85),
    (r'(?:экономим|режем|сокращаем)\s*(?:расход|затрат|бюджет)', "objection_price", 0.85),
    (r'(?:у\s*конкурент|другие)\w*\s*дешевл', "objection_price", 0.85),
    (r'(?:видел|нашёл|есть)\s*(?:дешевл|подешевл)', "objection_price", 0.85),
    (r'(?:много|слишком)\s*(?:хотите|просите|берёте)', "objection_price", 0.85),
    (r'(?:неоправданн|завышенн)\w*\s*(?:цена|стоимость)', "objection_price", 0.85),
    (r'(?:не\s*)?(?:стоит|окуп\w*|отобь)\w*\s*(?:таких|этих|своих)\s*денег', "objection_price", 0.85),
    (r'(?:можно|можете|давайте)\s*(?:дешевл|скидк|подешевл)', "objection_price", 0.8),

    # =================================================================
    # OBJECTION_NO_TIME (возражения по времени)
    # =================================================================
    (r'нет\s*времен', "objection_no_time", 0.9),
    (r'сейчас\s*не\s*мог', "objection_no_time", 0.85),
    # Дополнительные временные возражения
    (r'(?:занят|загружен|запара|завал|аврал)', "objection_no_time", 0.85),
    (r'(?:некогда|не\s*до\s*этого|не\s*до\s*вас)', "objection_no_time", 0.85),
    (r'(?:позвоните|напишите|свяжитесь)\s*(?:позже|потом|завтра|в\s*другой)', "objection_no_time", 0.85),
    (r'(?:давайте|может)\s*(?:позже|потом|в\s*другой|на\s*след)', "objection_no_time", 0.85),
    (r'(?:сейчас\s*)?(?:горят|горящ\w*)\s*(?:дедлайн|сроки|задачи)', "objection_no_time", 0.85),
    (r'(?:конец|начало)\s*(?:года|квартала|месяца|отчётност)', "objection_no_time", 0.8),
    (r'(?:после\s*)?(?:праздник|отпуск|выходн|нового\s*года)', "objection_no_time", 0.8),
    (r'(?:разгреб|освобож|выберу|найду)\w*\s*(?:время|момент|окно)', "objection_no_time", 0.8),
    (r'(?:сезон|высокий\s*сезон|пик\s*нагрузки)', "objection_no_time", 0.8),
    (r'(?:руки|голова)\s*(?:не\s*доход|забит)', "objection_no_time", 0.8),
    (r'(?:сейчас\s*)?(?:тяжёл\w*|сложн\w*)\s*(?:период|время|момент)', "objection_no_time", 0.8),

    # =================================================================
    # OBJECTION_COMPETITOR (уже есть конкурент)
    # =================================================================
    (r'(?:уже\s*)?(?:есть|используем|работаем\s*в|сидим\s*на)\s*(?:crm|црм|система)', "objection_competitor", 0.85),
    (r'(?:уже\s*)?(?:есть|используем|работаем\s*в|сидим\s*на)\s*(?:амо|битрикс|мегаплан|salesforce|pipedrive)', "objection_competitor", 0.9),
    (r'(?:внедрили|подключили|купили|перешли\s*на)\s*(?:crm|црм|амо|битрикс|мегаплан)', "objection_competitor", 0.9),
    (r'(?:нас\s*)?устраивает\s*(?:текущ\w*|нынешн\w*|наш\w*)', "objection_competitor", 0.85),
    (r'(?:менять|переходить|мигрировать)\s*(?:не\s*)?(?:хотим|планируем|собираемся)', "objection_competitor", 0.85),
    (r'(?:уже\s*)?(?:вложили|потратили|заплатили)\s*(?:деньги|много|немало)', "objection_competitor", 0.85),
    (r'(?:команда|все|сотрудники)\s*(?:привыкли|обучены|знают)', "objection_competitor", 0.8),
    (r'(?:у\s*нас|есть)\s*(?:своя|собственн\w*|самописн\w*)', "objection_competitor", 0.85),

    # =================================================================
    # OBJECTION_THINK (надо подумать)
    # =================================================================
    (r'(?:надо|нужно|дайте)\s*(?:подумать|посовещаться|обсудить)', "objection_think", 0.85),
    (r'(?:должен|должны|нужно)\s*(?:обсудить|посоветоваться|согласовать)', "objection_think", 0.85),
    (r'(?:с\s*)?(?:руководств\w*|начальств\w*|директор\w*)\s*(?:обсуди|согласу|посовету)', "objection_think", 0.85),
    (r'(?:решение|вопрос)\s*(?:принима\w*|решае\w*)\s*(?:не\s*)?(?:я|мы)', "objection_think", 0.8),
    (r'(?:это\s*)?(?:не\s*)?(?:в\s*)?(?:моей|нашей)\s*(?:компетенции|власти)', "objection_think", 0.85),
    (r'(?:нужно\s*)?(?:время\s*)?(?:на\s*)?(?:раздум\w*|обдум\w*|размышлен)', "objection_think", 0.8),
    (r'(?:дайте|дай)\s*(?:подумать|время|пару\s*дней)', "objection_think", 0.85),
    (r'(?:перезвон|вернусь|свяжусь)\w*\s*(?:сам|позже|потом|когда\s*решу)', "objection_think", 0.8),
    (r'(?:пока\s*)?(?:не\s*готов|не\s*готовы)\s*(?:к|принять|дать)', "objection_think", 0.8),

    # =================================================================
    # AGREEMENT (согласие)
    # =================================================================
    (r'давай\w*\s*попробу', "agreement", 0.9),
    (r'хочу\s*попробо', "agreement", 0.9),
    (r'да,?\s*интересн', "agreement", 0.9),
    (r'да,?\s*давайте', "agreement", 0.9),
    (r'расскажите\s*подробн', "agreement", 0.85),
    (r'хо[чт]\w*\s*демо', "agreement", 0.9),
    # Дополнительные согласия
    (r'(?:^|\s)да[,!.\s]*$', "agreement", 0.8),  # просто "да"
    (r'(?:да|ага|угу),?\s*(?:конечно|разумеется|естественно)', "agreement", 0.9),
    (r'(?:звучит|выглядит)\s*(?:интересн|хорош|неплох|здорово)', "agreement", 0.85),
    (r'(?:заинтересова|заинтригова|любопытн)', "agreement", 0.85),
    (r'(?:хотел|хотела)\s*бы\s*(?:узнать|попробова|посмотре)', "agreement", 0.85),
    (r'(?:можно|можем|давайте)\s*(?:созвониться|пообщаться|обсудить)', "agreement", 0.85),
    (r'(?:когда\s*)?(?:можно|удобно)\s*(?:созвониться|встретиться|показать)', "agreement", 0.85),
    (r'(?:отлично|супер|класс|круто|здорово)[,!.\s]*(?:давайте|жду)', "agreement", 0.9),
    (r'(?:принял|понял|услышал)[,.\s]*(?:жду|давайте|запишите)', "agreement", 0.85),
    (r'(?:записывайте|записывай|пишите|пиши)[,.\s]*(?:меня|мой|нас)', "agreement", 0.9),
    (r'(?:бронируй|бронирую|бронируйте)\s*(?:время|слот|встречу)', "agreement", 0.9),
    (r'(?:готов|готовы|готова)\s*(?:посмотреть|попробовать|обсудить|слушать)', "agreement", 0.9),
    (r'(?:в\s*деле|погнали|поехали|го|погоди\s*вау)', "agreement", 0.85),
    (r'(?:почему\s*бы\s*и\s*нет|можно\s*попробовать|давай\s*попробуем)', "agreement", 0.85),

    # =================================================================
    # GREETING (приветствия — с уточнением)
    # =================================================================
    (r'^(?:привет|здравствуй\w*|добрый\s*(?:день|утро|вечер)|доброе\s*утро|доброго\s*времени)[,!.\s]*$', "greeting", 0.95),
    (r'^(?:хай|хелло|здарова?|дарова|салют|приветик|ку)[,!.\s]*$', "greeting", 0.9),

    # =================================================================
    # FAREWELL (прощания)
    # =================================================================
    (r'(?:до\s*свидания|до\s*связи|до\s*встречи|пока|всего\s*доброго|всего\s*хорошего)', "farewell", 0.9),
    (r'(?:хорошего|удачного|отличного)\s*(?:дня|вечера|времени)', "farewell", 0.85),
    (r'(?:спасибо|благодарю)[,.\s]*(?:пока|до\s*свидания|до\s*связи)', "farewell", 0.9),
    (r'(?:бай|бб|покедова|покеда|чао|адьёс)', "farewell", 0.85),
    (r'(?:на\s*этом|на\s*сегодня|пока\s*что)\s*(?:всё|все|достаточно)', "farewell", 0.8),

    # =================================================================
    # GRATITUDE (благодарность)
    # =================================================================
    (r'^(?:спасибо|благодарю|спс|пасибо)[,!.\s]*$', "gratitude", 0.9),
    (r'(?:большое|огромное|искреннее)\s*спасибо', "gratitude", 0.9),
    (r'(?:спасибо|благодарю)\s*(?:за|вам|тебе)', "gratitude", 0.85),
    (r'(?:очень\s*)?(?:благодарен|благодарна|признателен|признательна)', "gratitude", 0.85),

    # =================================================================
    # SMALL TALK (болтовня — нужно перенаправить)
    # =================================================================
    (r'как\s*(?:дела|жизнь|настроение|сам|сама)', "small_talk", 0.85),
    (r'(?:что|как)\s*(?:нового|новенького|интересного)', "small_talk", 0.85),
    (r'(?:как\s*)?(?:погода|настроен\w*|выходн\w*|праздник\w*)', "small_talk", 0.7),

    # =================================================================
    # UNCLEAR (непонятные сообщения)
    # =================================================================
    (r'^[?!.]+$', "unclear", 0.9),  # только знаки препинания
    (r'^(?:что|ась|чего|а)[?]*$', "unclear", 0.85),  # короткие вопросы
    (r'^(?:не\s*понял|не\s*понятно|что\s*это)[?]*$', "unclear", 0.85),
    (r'^(?:\?\?\?|\.\.\.|\!\!\!)$', "unclear", 0.9),
]

# Компилируем паттерны для производительности
_COMPILED_PRIORITY_PATTERNS = [(re.compile(p, re.IGNORECASE), intent, conf)
                                for p, intent, conf in PRIORITY_PATTERNS]


class RootClassifier:
    """Быстрая классификация по корням слов"""

    def __init__(self):
        self.roots = INTENT_ROOTS
        self.config = CLASSIFIER_CONFIG
        self.priority_patterns = _COMPILED_PRIORITY_PATTERNS

    def classify(self, message: str) -> Tuple[str, float, Dict[str, int]]:
        """
        Классификация по корням

        Returns:
            (intent, confidence, scores_dict)
        """
        message_lower = message.lower()

        # ШАГ 0: Проверяем приоритетные паттерны
        # Это решает проблему "не интересно" → rejection (а не agreement)
        for pattern, intent, confidence in self.priority_patterns:
            if pattern.search(message_lower):
                return intent, confidence, {intent: 3}  # высокий score

        # ШАГ 1: Обычная классификация по корням
        scores: Dict[str, int] = {}

        for intent, roots in self.roots.items():
            score = 0
            for root in roots:
                if root in message_lower:
                    score += 1
            if score > 0:
                scores[intent] = score

        if not scores:
            return "unclear", 0.0, {}

        # Находим лучший интент
        best_intent = max(scores, key=scores.get)
        best_score = scores[best_intent]

        # Нормализуем confidence
        # Чем больше совпадений, тем выше уверенность
        confidence = min(best_score * self.config["root_match_weight"] / 3, 1.0)

        # Бонус если есть явный лидер (разрыв с вторым местом)
        sorted_scores = sorted(scores.values(), reverse=True)
        if len(sorted_scores) > 1:
            gap = sorted_scores[0] - sorted_scores[1]
            if gap >= 2:
                confidence = min(confidence + 0.2, 1.0)

        return best_intent, confidence, scores


class LemmaClassifier:
    """Fallback классификация через pymorphy2"""

    def __init__(self):
        self.phrases = INTENT_PHRASES
        self.config = CLASSIFIER_CONFIG
        self.morph = MorphAnalyzer() if PYMORPHY_AVAILABLE else None

    def _lemmatize(self, text: str) -> List[str]:
        """Приводим слова к нормальной форме"""
        if not self.morph:
            return text.lower().split()

        words = re.findall(r'[а-яёa-z0-9]+', text.lower())
        lemmas = []
        for word in words:
            parsed = self.morph.parse(word)
            if parsed:
                lemmas.append(parsed[0].normal_form)
            else:
                lemmas.append(word)
        return lemmas

    def _lemmatize_phrase(self, phrase: str) -> str:
        """Лемматизируем фразу и склеиваем обратно"""
        return " ".join(self._lemmatize(phrase))

    def classify(self, message: str) -> Tuple[str, float, Dict[str, float]]:
        """
        Классификация через лемматизацию

        Returns:
            (intent, confidence, scores_dict)
        """
        if not PYMORPHY_AVAILABLE:
            return "unclear", 0.0, {}

        message_lemmas = self._lemmatize(message)
        message_lemma_str = " ".join(message_lemmas)

        scores: Dict[str, float] = {}

        for intent, phrases in self.phrases.items():
            best_match_score = 0.0

            for phrase in phrases:
                phrase_lemmas = self._lemmatize(phrase)
                phrase_lemma_str = " ".join(phrase_lemmas)

                # Точное совпадение лемматизированной фразы
                if phrase_lemma_str in message_lemma_str:
                    match_score = len(phrase_lemmas) * self.config["lemma_match_weight"]
                    best_match_score = max(best_match_score, match_score)
                    continue

                # Частичное совпадение (все леммы фразы есть в сообщении)
                matching_lemmas = sum(1 for l in phrase_lemmas if l in message_lemmas)
                if matching_lemmas == len(phrase_lemmas):
                    match_score = matching_lemmas * self.config["lemma_match_weight"] * 0.8
                    best_match_score = max(best_match_score, match_score)

            if best_match_score > 0:
                scores[intent] = best_match_score

        if not scores:
            return "unclear", 0.0, {}

        best_intent = max(scores, key=scores.get)
        best_score = scores[best_intent]

        # Нормализуем confidence
        confidence = min(best_score / 4, 1.0)

        return best_intent, confidence, scores


class DataExtractor:
    """Извлекаем структурированные данные из сообщения (включая SPIN-данные)"""

    def extract(self, message: str, context: Dict = None) -> Dict:
        """
        Извлекаем данные из сообщения

        Args:
            message: Сообщение пользователя
            context: Контекст (missing_data, collected_data, spin_phase) для понимания коротких ответов
        """
        extracted = {}
        message_lower = message.lower().strip()
        context = context or {}
        missing_data = context.get("missing_data", [])
        spin_phase = context.get("spin_phase")

        # === Размер компании ===
        size_patterns = [
            r'(\d+)\s*(?:человек|чел\.?|менеджер|сотрудник|продаж|продавц|официант|повар|работник|кассир)',
            r'нас\s*(\d+)',
            r'команд[аы]?\s*(?:из|в|на)?\s*(\d+)',
            r'отдел[еа]?\s*(\d+)',
            r'(\d+)\s*(?:в команде|в отделе|человек|продавц|официант)',
            r'штат[еа]?\s*(\d+)',
            r'работа[ею]т?\s*(\d+)',
        ]
        for pattern in size_patterns:
            match = re.search(pattern, message_lower)
            if match:
                size = int(match.group(1))
                if 1 <= size <= 10000:
                    extracted["company_size"] = size
                    break

        # Контекстное извлечение: если просто число и спрашивали о размере
        if "company_size" not in extracted and "company_size" in missing_data:
            # Проверяем что сообщение — просто число (возможно со словами)
            just_number = re.match(r'^(\d+)\s*(?:человек|чел)?\.?$', message_lower)
            if just_number:
                size = int(just_number.group(1))
                if 1 <= size <= 10000:
                    extracted["company_size"] = size

        # === Боль клиента ===
        pain_patterns = {
            # =================================================================
            # ПОТЕРЯ КЛИЕНТОВ И ОТТОК
            # =================================================================
            r'теря[ею]м?\s*клиент': "потеря клиентов",
            r'клиент\w*\s*(?:ухо|уш[её]л|сбеж|ушли)': "клиенты уходят",
            r'(?:отток|утечк)\w*\s*клиент': "отток клиентов",
            r'клиент\w*\s*(?:недовольн|жалу|ругают)': "недовольные клиенты",
            r'не\s*(?:возвращ|удержива)\w*\s*клиент': "не удерживаем клиентов",
            r'уход\w*\s*клиент': "клиенты уходят",
            r'клиент\w*\s*(?:уход|теря|бег)': "клиенты уходят",
            r'(?:мало|нет)\s*повторн': "нет повторных продаж",
            r'не\s*(?:возвращаются|приходят\s*снова)': "клиенты не возвращаются",
            r'(?:потерял|упустил)\w*\s*(?:клиент|заказ|сделк)': "упускаем клиентов",
            # Дополнительные паттерны
            r'клиент\w*\s*(?:сливают|слив)': "сливаем клиентов",
            r'(?:сливают|слив)\w*\s*клиент': "сливаем клиентов",
            r'(?:портим|испортил)\w*\s*(?:отношен|репутац)\w*\s*(?:с\s*)?клиент': "портим отношения с клиентами",
            r'клиент\w*\s*(?:злят|злит|бесит|раздражён)': "клиенты недовольны",
            r'(?:негатив|плох)\w*\s*(?:отзыв|обратн\w*\s*связ)': "негативные отзывы",
            r'клиент\w*\s*(?:пишут|оставля)\w*\s*(?:негатив|плох)': "негативные отзывы",
            r'(?:рейтинг|оценк)\w*\s*(?:пада|сниж|низк|плох)': "падает рейтинг",
            r'(?:nps|нпс|лояльн)\w*\s*(?:низк|пада|плох)': "низкая лояльность",

            # =================================================================
            # УПУЩЕННЫЕ СДЕЛКИ И ЛИДЫ
            # =================================================================
            r'упуска[ею]м?\s*(?:сделк|лид|заявк|клиент)?': "упускаем сделки",
            r'(?:сделк|лид|заявк)\w*\s*(?:теря|пропа|упуск)': "теряем заявки",
            r'(?:пропуск|теря)\w*\s*(?:заявк|лид|обращен)': "пропускаем заявки",
            r'заявк\w*\s*(?:не\s*)?(?:обрабат|отвеча)': "заявки не обрабатываются",
            r'(?:долго|медленно)\s*(?:отвеча|реагир)\w*\s*(?:на\s*)?(?:заявк|лид)?': "медленная обработка заявок",
            r'лид\w*\s*(?:остыва|протуха|умира)': "лиды остывают",
            r'(?:горяч|тёпл|тепл)\w*\s*(?:лид|клиент)\w*\s*(?:остыва|теря)': "теряем горячих клиентов",
            r'не\s*(?:дозванива|дозвон)': "не дозваниваемся",
            # Дополнительные паттерны
            r'(?:заявк|лид|обращен)\w*\s*вис': "заявки зависают",
            r'(?:заявк|лид)\w*\s*(?:без\s*)?(?:ответ|реакц)': "заявки без ответа",
            r'(?:заявк|лид)\w*\s*(?:копят|накаплива|скаплива)': "копятся заявки",
            r'(?:очередь|куч)\w*\s*(?:заявк|лид|обращен)': "очередь заявок",
            r'(?:входящ|поток)\w*\s*(?:не\s*)?(?:справля|обрабат)': "не справляемся с входящими",
            r'(?:упуст|проморга|прозева)\w*\s*(?:сделк|лид|заявк|клиент)': "упускаем возможности",
            r'(?:сделк|возможност)\w*\s*(?:упуст|проморга|прозева)': "упускаем возможности",
            r'(?:воронк|пайплайн)\w*\s*(?:пуст|нет|дыряв)': "пустая воронка",
            r'(?:мало|нет)\s*(?:входящ|заявок|лидов|обращен)': "мало входящих",

            # =================================================================
            # ПРОБЛЕМЫ С МЕНЕДЖЕРАМИ
            # =================================================================
            r'забыва[ею]т?\s*(?:перезвон|позвон|задач|клиент)?': "забывают задачи",
            r'менеджер\w*\s*(?:не\s*)?(?:перезван|звон)': "менеджеры не перезванивают",
            r'менеджер\w*\s*(?:косяч|лажа|ошиба)': "ошибки менеджеров",
            r'менеджер\w*\s*(?:забыва|пропуска|теря)': "менеджеры забывают",
            r'менеджер\w*\s*(?:не\s*работа|халтур|ленят)': "менеджеры не работают",
            r'менеджер\w*\s*(?:увол|уш[её]л|ушли)': "уход менеджеров",
            r'(?:новый|нов\w*)\s*менеджер\w*\s*(?:долго|не\s*мо)': "адаптация менеджеров",
            r'пропуска[ею]т?\s*(?:задач|звонк|встреч)?': "пропускают задачи",
            r'не\s*перезванива': "не перезванивают",
            r'сотрудник\w*\s*(?:не\s*)?(?:работа|выполня)': "проблемы с сотрудниками",
            r'(?:саботаж|саботир)': "саботаж сотрудников",
            r'(?:текучк|текучест)\w*\s*кадр': "текучка кадров",
            # Дополнительные паттерны
            r'менеджер\w*\s*(?:сливают|слив|гоняют)': "менеджеры сливают",
            r'менеджер\w*\s*(?:не\s*)?(?:фиксир|запис|вносят)': "менеджеры не фиксируют",
            r'менеджер\w*\s*(?:воруют|крадут|уводят)\w*\s*(?:клиент|базу)?': "менеджеры уводят клиентов",
            r'(?:воруют|крадут|уводят)\w*\s*(?:клиент|базу)': "уводят базу клиентов",
            r'менеджер\w*\s*(?:левач|подраб|калым)': "левые подработки",
            r'(?:отмаз|оправд|отговор)': "отмазываются",
            r'менеджер\w*\s*(?:врут|обманыва|лукав)': "менеджеры обманывают",
            r'(?:не\s*)?(?:доверя|верю)\w*\s*менеджер': "не доверяем менеджерам",
            r'менеджер\w*\s*(?:работают\s*)?(?:в\s*)?(?:своих|свои)\s*(?:интерес|карман)': "работают на себя",
            r'(?:продаж|сейлз)\w*\s*(?:не\s*)?(?:продают|закрыва)': "менеджеры не продают",
            r'(?:плох|слаб)\w*\s*(?:продаж|сейлз)\w*\s*навык': "слабые навыки продаж",
            r'(?:не\s*)?(?:умеют|могут)\s*продава': "не умеют продавать",
            r'продавц\w*\s*(?:слаб|плох|не\s*(?:умеют|могут))': "слабые продавцы",
            r'(?:обуч|тренир)\w*\s*(?:нет|не\s*было|не\s*провод)': "нет обучения",
            r'(?:новичк|стажёр|новен)\w*\s*(?:долго|не\s*мо|не\s*справля)': "проблемы с новичками",

            # =================================================================
            # НЕТ КОНТРОЛЯ И ПРОЗРАЧНОСТИ
            # =================================================================
            r'нет\s*контрол': "нет контроля",
            r'не\s*(?:могу|можем)\s*контролир': "нет контроля",
            r'не\s*вид[и|е][мт]\s*(?:что|как|чем)?': "нет видимости",
            r'контроль\s*(?:за|над)?\s*(?:менеджер|продаж|сотрудник)': "контроль продаж",
            r'(?:не\s*)?(?:понима|зна)[юем]\s*(?:что|как|сколько)': "нет понимания процессов",
            r'(?:чёрн|черн)\w*\s*ящик': "чёрный ящик",
            r'не\s*(?:отслежива|трек|мониторим)': "нет отслеживания",
            r'(?:непрозрачн|непонятн)\w*\s*(?:процесс|работ)?': "непрозрачные процессы",
            r'(?:кто|что)\s*(?:делает|работает|занят)': "неясно кто чем занят",
            r'не\s*(?:знаю|понимаю)\s*(?:чем|что|как)': "нет понимания",
            # Дополнительные паттерны
            r'(?:слеп|вслепую)\s*(?:работа|управля)': "работаем вслепую",
            r'руковод\w*\s*(?:не\s*)?(?:вид|знает|понима)': "руководство не видит",
            r'(?:собственник|директор|босс)\w*\s*(?:не\s*)?(?:вид|знает|понима)': "руководство не видит",
            r'(?:невозможн|не\s*мог)\w*\s*(?:провер|контролир|отслед)': "невозможно проверить",
            r'(?:верим|доверя)\w*\s*(?:на\s*слово|словам)': "верим на слово",
            r'(?:нет|отсутств)\w*\s*(?:учёт|учет)': "нет учёта",
            r'(?:нет|отсутств)\w*\s*(?:фиксац|протокол|логиров)': "ничего не фиксируется",

            # =================================================================
            # ХАОС В ДАННЫХ И ИНСТРУМЕНТАХ
            # =================================================================
            r'excel|эксел|табличк': "работа в Excel",
            r'гугл\s*(?:табли|докс)|google\s*(?:sheet|doc)': "работа в Google Docs",
            r'блокнот|записк|стикер': "записи в блокнотах",
            r'всё\s*в\s*голов': "всё в головах",
            r'нигде\s*не\s*(?:фикс|запис)': "ничего не фиксируется",
            r'разброс|раскидан': "данные разбросаны",
            r'хаос': "хаос в данных",
            r'беспоряд|бардак|бедлам': "беспорядок",
            r'(?:кажд|разн)\w*\s*(?:сво[йяеи]|по.своему|ведёт|ведет)': "каждый ведёт по-своему",
            r'по.своему\s*(?:вед|дела|работа)': "каждый ведёт по-своему",
            r'(?:вед[её]т|ведут)\w*\s*(?:\w+\s+)?по.своему': "каждый ведёт по-своему",
            r'нет\s*(?:единой|общей)\s*(?:базы|системы)': "нет единой базы",
            r'(?:разн|много)\w*\s*(?:систем|программ|инструмент)': "много разных систем",
            r'(?:информац|данн)\w*\s*(?:тер|пропа)': "данные теряются",
            r'(?:дубл|повтор)\w*\s*(?:данн|информ|ввод)': "дублирование данных",
            r'ручн\w*\s*(?:ввод|работ|труд)': "много ручной работы",
            # Дополнительные паттерны
            r'(?:бумаг|бумажк)\w*\s*(?:много|куч|завал)': "работа с бумагами",
            r'(?:вс[её]\s*)?(?:на\s*)?бумаг': "на бумаге",
            r'(?:в\s*)?(?:тетрад|блокнот)\w*\s*(?:пиш|вед|запис)': "записи в тетрадях",
            r'(?:word|ворд)\w*\s*(?:докум|файл)': "работа в Word",
            r'(?:куч|завал|мног)\w*\s*(?:файл|документ|папок)': "много файлов",
            r'(?:файл|документ)\w*\s*(?:где.то|потеря|не\s*найд)': "файлы теряются",
            r'(?:найти|искать)\s*(?:файл|документ|информац)\w*\s*(?:долго|сложно|невозможн)': "сложно найти файлы",
            r'(?:всё|все)\s*(?:раскидано|разбросано|в\s*разн)': "всё разбросано",
            r'(?:каш|месиво|свалк)\w*\s*(?:в\s*)?(?:данн|информац|файл)': "каша в данных",
            r'(?:зоопарк|винегрет)\w*\s*(?:систем|программ|инструмент)': "зоопарк систем",

            # =================================================================
            # ДУБЛИ И ОШИБКИ
            # =================================================================
            r'дубл[иеяь]': "дубли клиентов",
            r'путаниц': "путаница в данных",
            r'ошиб[ко]': "ошибки в работе",
            r'(?:один|одного)\s*клиент\w*\s*(?:несколько|много|двое)': "дубли клиентов",
            r'(?:повторн|дважды)\w*\s*(?:звон|пиш|обраща)': "повторные обращения",
            r'(?:перепут|смеша|спута)': "путаница",
            r'(?:неточн|некорректн|неправильн)\w*\s*данн': "некорректные данные",
            r'(?:устарел|старые|неактуальн)\w*\s*(?:данн|информ|контакт)': "устаревшие данные",
            # Дополнительные паттерны
            r'(?:одному|одного)\s*клиент\w*\s*(?:звоня|обраща)\w*\s*(?:несколько|много|двое)': "звоним одному клиенту несколько раз",
            r'(?:базе|данн)\w*\s*(?:грязн|мусор|шлак)': "грязная база",
            r'(?:чист|актуализ)\w*\s*(?:баз|данн)': "нужна чистка базы",
            r'(?:контакт|телефон|email)\w*\s*(?:неверн|некорректн|ошиб|устар)': "неверные контакты",
            r'(?:данн|информац)\w*\s*(?:противореч|не\s*совпад|расход)': "данные противоречат",
            r'(?:разн|противореч)\w*\s*(?:информац|данн)\w*\s*(?:об\s*одном|по\s*одному)': "разная информация",
            r'(?:накоп|скоп)\w*\s*(?:мусор|хлам|шлак)': "мусор в данных",

            # =================================================================
            # ОБЩАЯ НЕЭФФЕКТИВНОСТЬ
            # =================================================================
            r'долго\s*(?:иск|наход)': "долго ищут информацию",
            r'не\s*успева[ею]': "не успевают",
            r'много\s*времен': "много времени на рутину",
            r'неэффективн': "неэффективность",
            r'медленн': "медленная работа",
            r'рутин': "много рутины",
            r'(?:убива|трат|жр[её]т)\w*\s*врем': "тратят много времени",
            r'(?:отнима|занима)\w*\s*(?:много\s*)?врем': "занимает много времени",
            r'(?:низк|плох)\w*\s*(?:производительн|эффективн)': "низкая эффективность",
            r'(?:простаива|просто[йи])': "простои в работе",
            r'(?:затягива|задержива|опаздыва)': "задержки",
            # Дополнительные паттерны
            r'(?:копипаст|копировать)\w*\s*(?:данн|информац)?': "много копипаста",
            r'(?:переключа|прыга)\w*\s*между\s*(?:програм|систем|окн)': "переключение между системами",
            r'(?:перенос|дублир)\w*\s*(?:данн|информац)\w*\s*(?:вручную|руками)': "ручной перенос данных",
            r'(?:одно\s*и\s*то\s*же|одинаков)\w*\s*(?:вводи|заполня|делае)': "повторный ввод",
            r'(?:куч|мног)\w*\s*(?:кликов|действ|шагов)': "много действий",
            r'(?:сложн|непонятн)\w*\s*(?:интерфейс|систем|програм)': "сложный интерфейс",
            r'(?:неудобн|громоздк)\w*\s*(?:систем|програм|интерфейс)': "неудобная система",
            r'(?:тормоз|лагает|виснет|глюч)': "тормозит система",
            r'(?:падает|вылетает|крашит)': "падает система",
            r'(?:баги|глюки|ошибки)\w*\s*(?:в\s*)?(?:систем|програм)': "баги в системе",

            # =================================================================
            # ПРОДАЖИ
            # =================================================================
            r'плох\w*\s*продаж': "плохие продажи",
            r'слаб\w*\s*продаж': "слабые продажи",
            r'низк\w*\s*продаж': "низкие продажи",
            r'продаж[иа]?\s*(?:пада|упа|снижа|плох|низк)': "падение продаж",
            r'(?:пада|упа|снижа)\w*\s*продаж': "падение продаж",
            r'мало\s*(?:продаж|клиент|сделок)': "мало продаж",
            r'(?:увеличить|поднять|нарастить)\s*продаж': "рост продаж",
            r'проблем\w*\s*(?:с\s*)?продаж': "проблемы с продажами",
            r'(?:низк|плох|мал)\w*\s*конверси': "низкая конверсия",
            r'(?:мал|низк)\w*\s*(?:средн|чек|сумм)': "низкий средний чек",
            r'(?:длинн|долг)\w*\s*(?:цикл|сделк)': "длинный цикл сделки",
            r'не\s*(?:выполня|закрыва)\w*\s*план': "не выполняют план",
            r'план\w*\s*(?:не\s*)?(?:выполня|горит|срыва)': "срыв плана продаж",
            r'(?:выручк|доход|оборот)\w*\s*(?:пада|сниж|мал)': "падение выручки",
            r'(?:маржа|маржинальн|прибыл)\w*\s*(?:пада|сниж|мал|низк)': "низкая маржа",
            # Дополнительные паттерны
            r'(?:стагнац|застой)\w*\s*(?:в\s*)?(?:продаж|бизнес)': "стагнация продаж",
            r'продаж\w*\s*(?:встал|стоят|не\s*идут)': "продажи встали",
            r'(?:сезон|спад)\w*\s*(?:продаж)?': "сезонный спад",
            r'(?:кризис|провал)\w*\s*(?:в\s*)?продаж': "кризис продаж",
            r'(?:допродаж|апселл|кросс.сел)\w*\s*(?:нет|мало|не\s*(?:делаем|работа))': "нет допродаж",
            r'(?:не\s*)?(?:предлага|продаём|продаем)\w*\s*(?:доп|сопутств)': "не предлагают допы",
            r'(?:средн|среднемес)\w*\s*(?:чек|сумм)\w*\s*(?:не\s*)?рас': "средний чек не растёт",
            r'(?:количеств|числ)\w*\s*(?:сделок|продаж)\w*\s*(?:пада|сниж|мал)': "мало сделок",
            r'(?:редк|мал)\w*\s*(?:покупа|заказыва)': "редко покупают",
            r'(?:клиент|покупател)\w*\s*(?:экономят|не\s*готов|отказыва)': "клиенты экономят",
            r'(?:ценов|цен)\w*\s*(?:давлен|конкурен)': "ценовое давление",

            # =================================================================
            # АНАЛИТИКА И ОТЧЁТЫ
            # =================================================================
            r'нет\s*(?:статистик|аналитик|отчёт|отчет)': "нет аналитики",
            r'(?:хочу|нужн|надо)\s*(?:вид|знать)\w*\s*(?:статистик|цифр|показател)': "нужна аналитика",
            r'(?:не\s*)?(?:понима|зна)[юем]\s*(?:цифр|показател|статистик)': "непонятна статистика",
            r'(?:собира|формиру|делаю)\w*\s*отчёт\w*\s*(?:вручную|руками)': "ручные отчёты",
            r'отчёт\w*\s*(?:долго|сложно|трудно)': "сложные отчёты",
            r'(?:kpi|кпи|метрик)\w*\s*(?:нет|не\s*(?:счита|отслежива))': "нет KPI",
            r'воронк\w*\s*(?:не\s*)?(?:вид|отслежива|понима)': "не видим воронку",
            r'(?:прогноз|планирован)\w*\s*(?:нет|сложн|невозможн)': "нет прогнозирования",
            # Дополнительные паттерны
            r'(?:дашборд|dashboard)\w*\s*(?:нет|нужен|хотим)': "нужен дашборд",
            r'(?:графики|диаграм|визуализац)\w*\s*(?:нет|нужн|хотим)': "нужна визуализация",
            r'(?:цифр|данн|показател)\w*\s*(?:собира|сводим)\w*\s*(?:вручную|руками|из\s*разн)': "собираем данные вручную",
            r'(?:сверк|сводк|свед[её]|сводим)\w*\s*(?:данн|цифр)': "сводим данные",
            r'(?:отчёт|отчет|данн)\w*\s*(?:в\s*)?(?:excel|эксел|табли)': "отчёты в Excel",
            r'(?:считаем|считаю|подсч[её]т)\w*\s*(?:вручную|руками|на\s*калькулятор)': "считаем вручную",
            r'(?:данн|показател|цифр)\w*\s*(?:устарел|неактуальн|вчерашн)': "устаревшие данные",
            r'(?:realtime|реалтайм|оперативн)\w*\s*(?:данн|показател)\w*\s*(?:нет|нужн)': "нужны оперативные данные",
            r'(?:принима|оцени|проанализ)\w*\s*(?:решен)\w*\s*(?:сложн|не\s*(?:на\s*чем|можем))': "сложно принимать решения",
            r'(?:бизнес|управленч)\w*\s*(?:решен)\w*\s*(?:на\s*)?(?:интуиц|авось|глазок)': "решения на интуиции",

            # =================================================================
            # КОММУНИКАЦИЯ И КОМАНДА
            # =================================================================
            r'(?:плох|нет)\w*\s*коммуникац': "плохая коммуникация",
            r'(?:не\s*)?(?:знаю|понима)[юем]\s*(?:что|как)\s*(?:делает|работает)\s*(?:коллег|команд)': "нет коммуникации в команде",
            r'(?:передач|переда[ёе])\w*\s*(?:клиент|дел|информац)': "проблемы с передачей дел",
            r'(?:команд|отдел)\w*\s*(?:не\s*)?(?:работа|координир)': "проблемы координации",
            r'(?:между\s*)?отдел\w*\s*(?:не\s*)?(?:взаимодейств|общ|коммуник)': "нет связи между отделами",
            r'(?:конфликт|спор|выясн)\w*\s*(?:менеджер|сотрудник)?': "конфликты в команде",
            # Дополнительные паттерны
            r'(?:информац|данн)\w*\s*(?:не\s*)?(?:дох|доход|переда)\w*\s*(?:до|между)': "информация не доходит",
            r'(?:кто|один)\w*\s*(?:не\s*)?(?:зна|в\s*курс)\w*\s*(?:что|как)\w*\s*(?:друг)': "не знаем что делает коллега",
            r'(?:дублир|пересек)\w*\s*(?:работ|задач|функц)': "дублирование работы",
            r'(?:делаем|делают)\s*одн[оу]\s*(?:и\s*то\s*же|работу)': "делаем одно и то же",
            r'(?:маркетинг|продаж)\w*\s*(?:не\s*)?(?:работают\s*)?(?:вместе|сообща)': "маркетинг и продажи не работают вместе",
            r'(?:передал|передач)\w*\s*(?:клиент|лид)\w*\s*(?:потерял|забыл|провал)': "теряем при передаче",
            r'(?:замен|подмен|отпуск|больничн)\w*\s*(?:никто\s*не|не\s*кому)': "некому заменить",
            r'(?:ключев|един)\w*\s*(?:сотрудник|специалист|человек)\w*\s*(?:увол|уш[её]л|уйд)': "уход ключевого сотрудника",
            r'(?:всё|все)\s*(?:завис|держит)\w*\s*(?:на\s*одном|один\s*человек)': "всё на одном человеке",

            # =================================================================
            # ЗВОНКИ И ТЕЛЕФОНИЯ
            # =================================================================
            r'звонк\w*\s*(?:тер|пропуск|пропада)': "теряем звонки",
            r'(?:пропущ|пропуска)\w*\s*звонк': "пропущенные звонки",
            r'(?:не\s*)?(?:записыва|сохраня)\w*\s*звонк': "не записываем звонки",
            r'(?:нет|не\s*вед[её])\w*\s*истор\w*\s*(?:звонк|общен|переговор)': "нет истории звонков",
            r'(?:не\s*)?(?:слуша|анализ)\w*\s*звонк': "не анализируем звонки",
            r'(?:скрипт|сценар)\w*\s*(?:нет|не\s*(?:работ|соблюд))': "нет скриптов продаж",
            # Дополнительные паттерны
            r'(?:ручн|вручную)\w*\s*(?:набор|набира|звон)': "ручной набор номеров",
            r'(?:авто|автомат)\w*\s*(?:дозвон|набор|обзвон)\w*\s*(?:нет|нужен)': "нужен автодозвон",
            r'(?:долго|много\s*времен)\w*\s*(?:на\s*)?(?:набор|дозвон)': "много времени на набор",
            r'(?:callback|обратн\w*\s*звон)\w*\s*(?:нет|долго|не\s*работа)': "проблемы с callback",
            r'(?:ivr|голосов\w*\s*меню)\w*\s*(?:нет|нужен|хотим)': "нужен IVR",
            r'(?:очередь|распредел)\w*\s*звонк\w*\s*(?:нет|плохо|не\s*работа)': "нет очереди звонков",
            r'(?:входящ|исходящ)\w*\s*звонк\w*\s*(?:не\s*)?(?:вид|контрол|отслежива)': "не видим статистику звонков",
            r'(?:качеств|оценк)\w*\s*(?:звонк|разговор)\w*\s*(?:не\s*)?(?:контрол|оценива)': "не оцениваем качество звонков",

            # =================================================================
            # АВТОМАТИЗАЦИЯ И ПРОЦЕССЫ
            # =================================================================
            r'автоматизир': "автоматизация",
            r'систематизир': "систематизация",
            r'(?:навести|нужен)\s*порядок': "навести порядок",
            r'(?:оптимиз|улучш)\w*\s*процесс': "оптимизация процессов",
            r'(?:выстро|постро|настро)\w*\s*(?:процесс|систем|работ)': "выстроить процессы",
            r'(?:нет|отсутств)\w*\s*(?:процесс|регламент|стандарт)': "нет процессов",
            r'(?:всё|все)\s*(?:вручную|руками|делаем\s*вручную)': "всё делается вручную",
            r'(?:делаем|делают|работаем)\s*(?:всё\s*)?вручную': "всё делается вручную",
            r'(?:автоматич|автомат)\w*\s*(?:напоминан|задач|уведомлен)': "нужна автоматизация",
            r'(?:нужн|хотим|надо)\s*(?:crm|црм|систем)': "нужна CRM",
            r'(?:внедр|запуст)\w*\s*(?:crm|црм|систем)': "внедрение CRM",
            # Дополнительные паттерны
            r'(?:триггер|автомат)\w*\s*(?:действ|задач|напоминан)\w*\s*(?:нет|нужн)': "нужны триггеры",
            r'(?:авто|автомат)\w*\s*(?:рассылк|письм|уведомлен)\w*\s*(?:нет|нужн)': "нужны авторассылки",
            r'(?:напомина|уведомлен)\w*\s*(?:нет|забыва|не\s*приход)': "нет напоминаний",
            r'(?:шаблон|темплейт)\w*\s*(?:нет|мало|устарел)': "нет шаблонов",
            r'(?:кажд|постоянн)\w*\s*раз\w*\s*(?:с\s*нуля|заново|писать|создава)': "каждый раз с нуля",
            r'(?:типов|стандартн|однотипн)\w*\s*(?:задач|действ|операц)\w*\s*(?:много|куча|вручную)': "много типовых задач",
            r'(?:бизнес|рабоч)\w*\s*(?:процесс)\w*\s*(?:не\s*)?(?:описан|формализ|стандартиз)': "процессы не описаны",

            # =================================================================
            # МАСШТАБИРОВАНИЕ И РОСТ
            # =================================================================
            r'(?:не\s*)?(?:мож|получа)\w*\s*(?:масштаб|расти|вырасти)': "проблемы масштабирования",
            r'(?:рост|развити)\w*\s*(?:ограничен|невозможен|сложн)': "ограничения роста",
            r'(?:упир|упёрл|упер)\w*\s*(?:в\s*)?(?:потолок|стену|границ)': "упёрлись в потолок",
            r'(?:бизнес|компани)\w*\s*(?:не\s*)?(?:раст|развива)': "бизнес не растёт",
            r'(?:больше|много)\s*(?:клиент|заказ)\w*\s*(?:не\s*)?(?:справля|обрабат)': "не справляемся с потоком",
            # Дополнительные паттерны
            r'(?:расшир|нанима|набира)\w*\s*(?:команд|штат|персонал)\w*\s*(?:сложн|не\s*мож)': "сложно расширяться",
            r'(?:новый|нов)\w*\s*(?:клиент|направлен|продукт)\w*\s*(?:не\s*мож|сложн)': "сложно добавить новое",
            r'(?:систем|процесс)\w*\s*(?:не\s*)?(?:готов|рассчитан)\w*\s*(?:на\s*)?рост': "система не готова к росту",
            r'(?:узк|бутылочн)\w*\s*(?:место|горл|горлышк)': "бутылочное горлышко",
            r'(?:предел|лимит|ограничен)\w*\s*(?:возможност|мощност|ёмкост)': "предел возможностей",
            r'(?:людей|рук|человек)\w*\s*(?:не\s*хватает|мало)': "не хватает людей",
            r'(?:перегруж|загруж|заваленн)\w*\s*(?:команд|сотрудник|менеджер)': "перегруженная команда",

            # =================================================================
            # ЖЕЛАНИЯ И ПОТРЕБНОСТИ (косвенные)
            # =================================================================
            r'(?:хочу|хотим|нужн|надо)\s*(?:видеть|знать)\s*(?:статистик|аналитик|цифр)': "нужна аналитика",
            r'(?:хочу|хотим|нужн|надо)\s*(?:контролир|отслежива|мониторить)': "нужен контроль",
            r'(?:хочу|хотим|нужн|надо)\s*(?:понима|знать)\s*(?:что|как|где)': "нужна прозрачность",
            r'(?:хочу|хотим|нужн|надо)\s*(?:автоматиз|упростить|ускорить)': "нужна автоматизация",
            r'(?:хочу|хотим|нужн|надо)\s*(?:порядок|систем|структур)': "нужна систематизация",
            r'(?:хочу|хотим|нужн\w*|надо)\s+(?:един|общ)\w*\s+(?:баз|систем|место)': "нужна единая система",
            r'нужн\w*\s+(?:един|общ)\w*\s+баз': "нужна единая база",
            r'(?:един|общ)\w*\s+(?:баз|систем)\w*\s+(?:нет|нужн)': "нужна единая система",
            r'(?:устал|надоел)\w*\s*(?:от\s*)?(?:бардак|хаос|беспоряд|рутин)': "устали от хаоса",
            r'(?:хочу|хотим)\s*(?:как\s*у\s*)?(?:нормальн|взросл|больш)': "хотим нормальные процессы",
            # Дополнительные паттерны
            r'(?:хочу|хотим|нужн|надо)\s*(?:сэконом|сберечь|оптимизир)\w*\s*(?:врем|ресурс)': "хотим экономить время",
            r'(?:хочу|хотим|нужн|надо)\s*(?:больше|увеличить|поднять)\s*(?:продаж|выручк|прибыл)': "хотим больше продаж",
            r'(?:хочу|хотим|нужн|надо)\s*(?:понятн|прозрачн)\w*\s*(?:процесс|систем|картин)': "хотим прозрачность",
            r'(?:хочу|хотим|нужн|надо)\s*(?:быстр|оперативн)\w*\s*(?:реагир|обрабат|отвеча)': "хотим быстрее работать",
            r'(?:хочу|хотим|нужн|надо)\s*(?:избав|уйти)\w*\s*(?:от\s*)?(?:рутин|ручн|excel)': "хотим избавиться от рутины",
            r'(?:хочу|хотим|нужн|надо)\s*(?:собрать|объединить|консолидир)\w*\s*(?:всё|все|данн|информац)': "хотим собрать всё в одном месте",

            # =================================================================
            # АБСТРАКТНЫЕ ЖАЛОБЫ
            # =================================================================
            r'всё\s*плохо': "всё плохо",
            r'ничего\s*не\s*работ': "ничего не работает",
            r'не\s*работает\s*(?:нормальн|как\s*надо)': "не работает нормально",
            r'полный\s*(?:бардак|хаос|трэш|треш|пипец|капец)': "полный бардак",
            r'(?:сплошн|одни)\s*(?:проблем|головн\w*\s*бол)': "сплошные проблемы",
            r'(?:замуч|задолб|достал)': "замучились",
            r'(?:невозможн|нереальн|нельзя)\s*(?:работ|так\s*дальше)': "невозможно работать",
            r'(?:тонем|зашива|захлёб)': "захлёбываемся",
            r'(?:горим|пожар|срочн|аврал)': "постоянные авралы",
            # Дополнительные паттерны
            r'(?:ад|кошмар|ужас)': "кошмар",
            r'(?:надоело|достало|заколебало)': "надоело",
            r'(?:бесит|раздражает|выводит\s*из\s*себя)': "бесит",
            r'(?:нервы|стресс|выгорание)\w*\s*(?:на\s*)?пред': "стресс",
            r'(?:сплошн|постоянн|вечн)\w*\s*(?:стресс|напряг|нервы)': "постоянный стресс",
            r'(?:устал|вымотал|измотал)\w*\s*(?:все|весь\s*отдел|команд)': "все устали",
            r'(?:так|это)\s*больше\s*(?:не\s*мож|продолжа)\w*\s*(?:нельзя|не\s*будет)': "так дальше нельзя",
            r'(?:нужн|пора|давно\s*пора)\s*что.то\s*(?:менять|делать|решать)': "пора что-то менять",

            # =================================================================
            # СПЕЦИФИЧНЫЕ ОТРАСЛЕВЫЕ БОЛИ
            # =================================================================
            r'(?:сервис|поддержк|support)\w*\s*(?:плох|медленн|не\s*отвеча)': "плохой сервис",
            r'(?:клиент\w*\s*)?(?:ждут|ожида)\w*\s*(?:долго|часами)': "клиенты долго ждут",
            r'(?:время|срок)\w*\s*(?:ответ|реакц|обработк)\w*\s*(?:большое|долг|медленн)': "долгое время ответа",
            r'(?:sla|слa|времен\w*\s*норматив)\w*\s*(?:не\s*)?(?:выполня|соблюда|нарушае)': "нарушаем SLA",
            r'(?:тикет|заявк|обращен)\w*\s*(?:копят|накаплива|не\s*закрыва)': "копятся тикеты",
            r'(?:повторн|одинаков)\w*\s*(?:вопрос|проблем|обращен)': "повторные обращения",
            r'(?:faq|база\s*знаний|документац)\w*\s*(?:нет|устарел|не\s*полн)': "нет базы знаний",
        }

        for pattern, pain in pain_patterns.items():
            if re.search(pattern, message_lower):
                extracted["pain_point"] = pain
                break

        # Контекстное: если спрашивали о проблемах, а клиент ответил коротко
        if "pain_point" not in extracted and "pain_point" in missing_data:
            # Короткие ответы о сфере деятельности = проблема в этой сфере
            short_answers = {
                # =================================================================
                # СФЕРЫ ДЕЯТЕЛЬНОСТИ
                # =================================================================
                # Продажи
                "продажи": "улучшение продаж",
                "продажами": "улучшение продаж",
                "сейлз": "улучшение продаж",
                "sales": "улучшение продаж",
                "продажниками": "контроль продавцов",
                "продавцами": "контроль продавцов",
                "выручка": "рост выручки",
                "выручкой": "рост выручки",
                "прибыль": "рост прибыли",
                "прибылью": "рост прибыли",
                "доход": "рост дохода",
                "доходом": "рост дохода",

                # Маркетинг
                "маркетинг": "маркетинг и лиды",
                "маркетингом": "маркетинг и лиды",
                "реклама": "работа с рекламой",
                "рекламой": "работа с рекламой",
                "трафик": "управление трафиком",
                "трафиком": "управление трафиком",
                "лидогенерация": "генерация лидов",
                "лидген": "генерация лидов",
                "контент": "контент-маркетинг",
                "контентом": "контент-маркетинг",
                "smm": "SMM продвижение",
                "соцсети": "работа с соцсетями",
                "соцсетями": "работа с соцсетями",
                "рассылки": "email-маркетинг",
                "рассылками": "email-маркетинг",

                # Клиенты
                "клиенты": "работа с клиентами",
                "клиентами": "работа с клиентами",
                "заказчики": "работа с заказчиками",
                "заказчиками": "работа с заказчиками",
                "покупатели": "работа с покупателями",
                "покупателями": "работа с покупателями",
                "клиентская база": "ведение базы клиентов",
                "клиентской базой": "ведение базы клиентов",
                "отток": "удержание клиентов",
                "оттоком": "удержание клиентов",
                "удержание": "удержание клиентов",
                "удержанием": "удержание клиентов",
                "лояльность": "повышение лояльности",
                "лояльностью": "повышение лояльности",

                # HR и персонал
                "hr": "управление персоналом",
                "кадры": "работа с кадрами",
                "кадрами": "работа с кадрами",
                "персонал": "управление персоналом",
                "персоналом": "управление персоналом",
                "сотрудники": "управление сотрудниками",
                "сотрудниками": "управление сотрудниками",
                "менеджеры": "контроль менеджеров",
                "менеджерами": "контроль менеджеров",
                "команда": "управление командой",
                "командой": "управление командой",
                "найм": "подбор персонала",
                "наймом": "подбор персонала",
                "онбординг": "адаптация сотрудников",
                "онбордингом": "адаптация сотрудников",
                "адаптация": "адаптация сотрудников",
                "адаптацией": "адаптация сотрудников",
                "обучение": "обучение сотрудников",
                "обучением": "обучение сотрудников",
                "мотивация": "мотивация сотрудников",
                "мотивацией": "мотивация сотрудников",

                # Логистика и склад
                "логистика": "управление логистикой",
                "логистикой": "управление логистикой",
                "доставка": "управление доставкой",
                "доставкой": "управление доставкой",
                "склад": "учёт склада",
                "складом": "учёт склада",
                "остатки": "учёт остатков",
                "остатками": "учёт остатков",
                "запасы": "управление запасами",
                "запасами": "управление запасами",
                "отгрузки": "контроль отгрузок",
                "отгрузками": "контроль отгрузок",
                "поставки": "контроль поставок",
                "поставками": "контроль поставок",

                # Финансы
                "финансы": "финансовый учёт",
                "финансами": "финансовый учёт",
                "деньги": "учёт финансов",
                "деньгами": "учёт финансов",
                "оплаты": "контроль оплат",
                "оплатами": "контроль оплат",
                "дебиторка": "контроль дебиторки",
                "дебиторкой": "контроль дебиторки",
                "долги": "контроль задолженностей",
                "долгами": "контроль задолженностей",
                "платежи": "контроль платежей",
                "платежами": "контроль платежей",
                "бюджет": "контроль бюджета",
                "бюджетом": "контроль бюджета",
                "расходы": "контроль расходов",
                "расходами": "контроль расходов",
                "касса": "учёт кассы",
                "кассой": "учёт кассы",

                # Сервис и поддержка
                "поддержка": "клиентская поддержка",
                "поддержкой": "клиентская поддержка",
                "сервис": "клиентский сервис",
                "сервисом": "клиентский сервис",
                "саппорт": "клиентская поддержка",
                "саппортом": "клиентская поддержка",
                "тикеты": "обработка тикетов",
                "тикетами": "обработка тикетов",
                "жалобы": "работа с жалобами",
                "жалобами": "работа с жалобами",
                "рекламации": "работа с рекламациями",
                "рекламациями": "работа с рекламациями",

                # =================================================================
                # ДЕЙСТВИЯ И ПРОЦЕССЫ
                # =================================================================
                # Коммуникации
                "звонки": "учёт звонков",
                "звонками": "учёт звонков",
                "переговоры": "ведение переговоров",
                "переговорами": "ведение переговоров",
                "общение": "коммуникация с клиентами",
                "общением": "коммуникация с клиентами",
                "переписка": "ведение переписки",
                "перепиской": "ведение переписки",
                "телефония": "телефония и звонки",
                "телефонией": "телефония и звонки",
                "чаты": "работа с чатами",
                "чатами": "работа с чатами",
                "мессенджеры": "работа с мессенджерами",
                "мессенджерами": "работа с мессенджерами",
                "email": "email-коммуникация",
                "почта": "email-коммуникация",
                "почтой": "email-коммуникация",

                # Заявки и лиды
                "заявки": "обработка заявок",
                "заявками": "обработка заявок",
                "лиды": "обработка лидов",
                "лидами": "обработка лидов",
                "обращения": "обработка обращений",
                "обращениями": "обработка обращений",
                "запросы": "обработка запросов",
                "запросами": "обработка запросов",
                "входящие": "обработка входящих",
                "входящими": "обработка входящих",
                "холодные": "работа с холодными",
                "холодными": "работа с холодными",
                "тёплые": "работа с тёплыми",
                "теплыми": "работа с тёплыми",

                # Сделки
                "сделки": "ведение сделок",
                "сделками": "ведение сделок",
                "заказы": "обработка заказов",
                "заказами": "обработка заказов",
                "договоры": "ведение договоров",
                "договорами": "ведение договоров",
                "контракты": "ведение контрактов",
                "контрактами": "ведение контрактов",
                "счета": "выставление счетов",
                "счетами": "выставление счетов",
                "документы": "документооборот",
                "документами": "документооборот",
                "акты": "работа с актами",
                "актами": "работа с актами",

                # Задачи
                "задачи": "управление задачами",
                "задачами": "управление задачами",
                "дела": "управление делами",
                "делами": "управление делами",
                "напоминания": "система напоминаний",
                "напоминаниями": "система напоминаний",
                "планирование": "планирование задач",
                "планированием": "планирование задач",
                "дедлайны": "контроль дедлайнов",
                "дедлайнами": "контроль дедлайнов",
                "расписание": "управление расписанием",
                "расписанием": "управление расписанием",
                "календарь": "ведение календаря",
                "календарём": "ведение календаря",
                "календарем": "ведение календаря",

                # =================================================================
                # УЧЁТ И ОТЧЁТНОСТЬ
                # =================================================================
                "учёт": "учёт клиентов",
                "учет": "учёт клиентов",
                "учётом": "учёт клиентов",
                "учетом": "учёт клиентов",
                "контроль": "контроль менеджеров",
                "контролем": "контроль менеджеров",
                "отчёты": "отчётность",
                "отчеты": "отчётность",
                "отчётами": "отчётность",
                "отчетами": "отчётность",
                "отчётность": "отчётность",
                "отчетность": "отчётность",
                "аналитика": "аналитика продаж",
                "аналитикой": "аналитика продаж",
                "статистика": "статистика продаж",
                "статистикой": "статистика продаж",
                "метрики": "отслеживание метрик",
                "метриками": "отслеживание метрик",
                "kpi": "контроль KPI",
                "кпи": "контроль KPI",
                "дашборд": "визуализация данных",
                "дашбордом": "визуализация данных",
                "dashboard": "визуализация данных",
                "графики": "визуализация данных",
                "графиками": "визуализация данных",
                "цифры": "работа с данными",
                "цифрами": "работа с данными",
                "показатели": "контроль показателей",
                "показателями": "контроль показателей",

                # Воронка
                "воронка": "воронка продаж",
                "воронкой": "воронка продаж",
                "конверсия": "повышение конверсии",
                "конверсией": "повышение конверсии",
                "пайплайн": "управление пайплайном",
                "пайплайном": "управление пайплайном",
                "pipeline": "управление пайплайном",
                "стадии": "настройка стадий",
                "стадиями": "настройка стадий",
                "этапы": "настройка этапов",
                "этапами": "настройка этапов",

                # =================================================================
                # СОСТОЯНИЯ И ПРОБЛЕМЫ
                # =================================================================
                "бардак": "наведение порядка",
                "хаос": "устранение хаоса",
                "беспорядок": "наведение порядка",
                "путаница": "устранение путаницы",
                "неразбериха": "устранение неразберихи",
                "каша": "наведение порядка",
                "бедлам": "наведение порядка",
                "завал": "разбор завалов",
                "завалом": "разбор завалов",
                "трэш": "наведение порядка",
                "треш": "наведение порядка",
                "кошмар": "решение проблем",
                "кошмаром": "решение проблем",
                "ужас": "решение проблем",
                "ужасом": "решение проблем",
                "стресс": "снижение стресса",
                "стрессом": "снижение стресса",
                "выгорание": "предотвращение выгорания",
                "выгоранием": "предотвращение выгорания",

                # Потери
                "потери": "сокращение потерь",
                "потерями": "сокращение потерь",
                "упущения": "сокращение упущений",
                "упущениями": "сокращение упущений",
                "утечки": "устранение утечек",
                "утечками": "устранение утечек",
                "дубли": "устранение дублей",
                "дублями": "устранение дублей",
                "дублирование": "устранение дублирования",
                "дублированием": "устранение дублирования",
                "ошибки": "сокращение ошибок",
                "ошибками": "сокращение ошибок",
                "косяки": "устранение косяков",
                "косяками": "устранение косяков",
                "факапы": "устранение факапов",
                "факапами": "устранение факапов",

                # Эффективность
                "эффективность": "повышение эффективности",
                "эффективностью": "повышение эффективности",
                "производительность": "повышение производительности",
                "производительностью": "повышение производительности",
                "скорость": "увеличение скорости работы",
                "скоростью": "увеличение скорости работы",
                "оптимизация": "оптимизация процессов",
                "оптимизацией": "оптимизация процессов",
                "рутина": "сокращение рутины",
                "рутиной": "сокращение рутины",
                "время": "экономия времени",
                "временем": "экономия времени",
                "ресурсы": "экономия ресурсов",
                "ресурсами": "экономия ресурсов",

                # Автоматизация
                "автоматизация": "автоматизация процессов",
                "автоматизацией": "автоматизация процессов",
                "систематизация": "систематизация работы",
                "систематизацией": "систематизация работы",
                "стандартизация": "стандартизация процессов",
                "стандартизацией": "стандартизация процессов",
                "регламенты": "создание регламентов",
                "регламентами": "создание регламентов",
                "процессы": "выстраивание процессов",
                "процессами": "выстраивание процессов",
                "порядок": "наведение порядка",
                "порядком": "наведение порядка",

                # =================================================================
                # ИНСТРУМЕНТЫ И БАЗА
                # =================================================================
                "база": "ведение базы клиентов",
                "базой": "ведение базы клиентов",
                "crm": "внедрение CRM",
                "црм": "внедрение CRM",
                "система": "внедрение системы",
                "системой": "внедрение системы",
                "excel": "уход от Excel",
                "эксель": "уход от Excel",
                "экселем": "уход от Excel",
                "таблицы": "уход от таблиц",
                "таблицами": "уход от таблиц",
                "блокноты": "уход от блокнотов",
                "блокнотами": "уход от блокнотов",
                "бумажки": "уход от бумаг",
                "бумажками": "уход от бумаг",
                "интеграция": "настройка интеграций",
                "интеграцией": "настройка интеграций",
                "интеграции": "настройка интеграций",
                "интеграциями": "настройка интеграций",
                "1с": "интеграция с 1С",
                "телефония": "интеграция телефонии",
                "телефонией": "интеграция телефонии",

                # =================================================================
                # МАСШТАБИРОВАНИЕ
                # =================================================================
                "рост": "масштабирование бизнеса",
                "ростом": "масштабирование бизнеса",
                "масштаб": "масштабирование бизнеса",
                "масштабом": "масштабирование бизнеса",
                "масштабирование": "масштабирование бизнеса",
                "масштабированием": "масштабирование бизнеса",
                "расширение": "расширение бизнеса",
                "расширением": "расширение бизнеса",
                "развитие": "развитие бизнеса",
                "развитием": "развитие бизнеса",
            }
            if message_lower in short_answers:
                extracted["pain_point"] = short_answers[message_lower]

        # === Контактная информация ===
        # Email
        email_match = re.search(r'[\w\.-]+@[\w\.-]+\.\w{2,}', message)
        if email_match:
            extracted["contact_info"] = email_match.group(0)

        # Телефон (если email не найден)
        if "contact_info" not in extracted:
            phone_patterns = [
                # +7 с разными разделителями: +7 999 123-45-67, +7(999)123-45-67, +79991234567
                r'\+7[\s\-\.]?\(?\d{3}\)?[\s\-\.]?\d{3}[\s\-\.]?\d{2}[\s\-\.]?\d{2}',
                # 8 с разными разделителями: 8 999 123-45-67, 8(999)123-45-67
                r'8[\s\-\.]?\(?\d{3}\)?[\s\-\.]?\d{3}[\s\-\.]?\d{2}[\s\-\.]?\d{2}',
                # 10 цифр подряд (без кода страны): 9991234567
                r'\b\d{10}\b',
                # Формат XXX-XXX-XX-XX или XXX XXX XX XX
                r'\d{3}[\s\-\.]\d{3}[\s\-\.]\d{2}[\s\-\.]\d{2}',
            ]
            for pattern in phone_patterns:
                phone_match = re.search(pattern, message)
                if phone_match:
                    extracted["contact_info"] = phone_match.group(0).strip()
                    break

        # === Имя клиента ===
        name_patterns = [
            r'(?:меня\s*зовут|я\s+)\s*([А-ЯЁ][а-яё]+)',
            r'(?:это\s+)?([А-ЯЁ][а-яё]+)\s*(?:на связи|пишу|беспокоит)',
        ]
        for pattern in name_patterns:
            name_match = re.search(pattern, message)
            if name_match:
                extracted["client_name"] = name_match.group(1)
                break

        # =================================================================
        # SPIN-специфичное извлечение данных
        # =================================================================

        # === Текущие инструменты (для Situation) ===
        tool_patterns = {
            r'(?:в\s+)?excel': "Excel",
            r'(?:в\s+)?эксел': "Excel",
            r'(?:в\s+)?табли[цч]': "таблицы",
            r'(?:в\s+)?гугл\s*(?:табли|докс|sheets|docs)': "Google Таблицы",
            r'(?:в\s+)?1[сc]': "1С",
            r'(?:в\s+)?битрикс': "Битрикс24",
            r'(?:в\s+)?амо': "AmoCRM",
            r'(?:в\s+)?notion': "Notion",
            r'(?:в\s+)?trello': "Trello",
            r'(?:на\s+)?бумаг': "на бумаге",
            r'(?:в\s+)?блокнот': "в блокноте",
            r'(?:в\s+)?голов': "в головах",
            r'вручную|руками': "вручную",
            r'никак|нигде|ничего': "никак не ведём",
        }
        for pattern, tool in tool_patterns.items():
            if re.search(pattern, message_lower):
                extracted["current_tools"] = tool
                break

        # === Тип бизнеса (для Situation) ===
        business_patterns = {
            r'магазин|розни[цч]|ритейл|retail': "розничная торговля",
            r'опт(?:ов)?|b2b': "оптовые продажи",
            r'ресторан|кафе|общепит|еда': "общепит",
            r'услуг|сервис|service': "сфера услуг",
            r'салон|красот|spa|спа': "салон красоты",
            r'клиник|медицин|врач': "медицина",
            r'недвижим|агентств|риэлтор': "недвижимость",
            r'склад|логистик|доставк': "логистика",
            r'производств|завод|фабрик': "производство",
            r'it|айти|программ|разработ': "IT",
            r'строител|ремонт': "строительство",
            r'образован|обучен|курс': "образование",
        }
        for pattern, btype in business_patterns.items():
            if re.search(pattern, message_lower):
                extracted["business_type"] = btype
                break

        # === Последствия проблемы (для Implication) ===
        if spin_phase == "implication" or "pain_impact" in missing_data:
            impact_patterns = [
                # Количество потерянных клиентов
                (r'(\d+)\s*(?:клиент|покупател|заказ)\w*\s*(?:теря|упуска|уход)', 'clients_lost'),
                (r'(?:теря|упуска)\w*\s*(\d+)\s*(?:клиент|покупател|заказ)', 'clients_lost'),
                (r'(?:примерно|около|где-то)\s*(\d+)\s*(?:клиент|покупател)', 'clients_lost'),
                # Время
                (r'(\d+)\s*(?:час|минут)\w*\s*(?:в\s*день|каждый\s*день|ежедневно)', 'time_daily'),
                (r'(?:тратим|уходит|занимает)\s*(\d+)\s*(?:час|минут)', 'time_daily'),
                (r'(\d+)\s*(?:час|минут)\w*\s*(?:в\s*недел|еженедельно)', 'time_weekly'),
                # Деньги
                (r'(\d+)\s*(?:тысяч|т\.?р\.?|к)\s*(?:руб|₽)?', 'money_k'),
                (r'(\d+)\s*(?:миллион|млн|м)\s*(?:руб|₽)?', 'money_m'),
                (r'(\d+)\s*%\s*(?:выручк|продаж|прибыл)', 'percent'),
            ]

            for pattern, impact_type in impact_patterns:
                match = re.search(pattern, message_lower)
                if match:
                    value = match.group(1)
                    if impact_type == 'clients_lost':
                        extracted["pain_impact"] = f"теряем ~{value} клиентов"
                    elif impact_type == 'time_daily':
                        extracted["pain_impact"] = f"тратим ~{value} часов/день"
                    elif impact_type == 'time_weekly':
                        extracted["pain_impact"] = f"тратим ~{value} часов/неделю"
                    elif impact_type == 'money_k':
                        extracted["pain_impact"] = f"теряем ~{value}к рублей"
                        extracted["financial_impact"] = f"{value}000"
                    elif impact_type == 'money_m':
                        extracted["pain_impact"] = f"теряем ~{value}млн рублей"
                        extracted["financial_impact"] = f"{value}000000"
                    elif impact_type == 'percent':
                        extracted["pain_impact"] = f"теряем ~{value}% выручки"
                    break

            # Качественные маркеры осознания последствий
            acknowledgment_patterns = [
                r'да[,.]?\s*(?:это|согласен|верно|точно)',
                r'к\s*сожалени',
                r'(?:серьёзн|критичн|важн)\s*(?:проблем|вопрос)',
                r'(?:много|часто|постоянно|регулярно)',
            ]
            for pattern in acknowledgment_patterns:
                if re.search(pattern, message_lower):
                    if "pain_impact" not in extracted:
                        extracted["pain_impact"] = "осознаёт последствия"
                    break

        # === Желаемый результат (для Need-Payoff) ===
        if spin_phase == "need_payoff" or "desired_outcome" in missing_data:
            need_patterns = {
                r'(?:хотел|хочу|хотим|хочется)\s*(?:бы\s*)?(?:видеть|знать|понима)': "прозрачность и контроль",
                r'(?:хотел|хочу|хотим)\s*(?:бы\s*)?автоматиз': "автоматизация процессов",
                r'(?:хотел|хочу|хотим)\s*(?:бы\s*)?(?:контролир|отслежива)': "контроль работы",
                r'(?:хотел|хочу|хотим)\s*(?:бы\s*)?(?:экономи|сберечь|сэкономи)': "экономия времени/денег",
                r'(?:хотел|хочу|хотим)\s*(?:бы\s*)?(?:упрост|ускор)': "упрощение работы",
                r'(?:хотел|хочу|хотим)\s*(?:бы\s*)?(?:систематиз|наладить|навести\s*порядок)': "систематизация",
                r'(?:помогло|решило|избавило)\s*(?:бы)?': "решение проблемы",
                r'было\s*бы\s*(?:отлично|супер|здорово|идеально|круто)': "положительный результат",
                r'(?:да|конечно|естественно|определённо),?\s*(?:это|помогло|упростило)': "подтверждение ценности",
            }

            for pattern, outcome in need_patterns.items():
                if re.search(pattern, message_lower):
                    extracted["desired_outcome"] = outcome
                    extracted["value_acknowledged"] = True
                    break

            # Простые утвердительные ответы на N-вопросы
            simple_yes = [
                r'^да[,!.]?\s*$',
                r'^конечно[,!.]?\s*$',
                r'^естественно[,!.]?\s*$',
                r'^было\s*бы\s*(?:здорово|отлично|супер)',
                r'^(?:да\s*)?помогло\s*бы',
            ]
            for pattern in simple_yes:
                if re.search(pattern, message_lower):
                    if "desired_outcome" not in extracted:
                        extracted["desired_outcome"] = "подтверждает ценность решения"
                        extracted["value_acknowledged"] = True
                    break

        # === Высокий интерес (для ускорения SPIN) ===
        high_interest_patterns = [
            r'(?:очень|сильно|крайне)\s*(?:интересн|нужн|важн)',
            r'(?:срочно|скорее|быстрее)\s*(?:нужн|надо|хотим)',
            r'готов\w*\s*(?:сейчас|сразу|прямо)',
            r'давайте\s*(?:сразу|прямо|начн)',
            r'хочу\s*(?:демо|попробова|подключи)',
        ]
        for pattern in high_interest_patterns:
            if re.search(pattern, message_lower):
                extracted["high_interest"] = True
                break

        # =================================================================
        # СРОЧНОСТЬ (urgency)
        # =================================================================
        urgency_patterns = {
            # Очень срочно
            r'(?:очень\s*)?срочн[оа]?': "very_urgent",
            r'горит': "very_urgent",
            r'(?:прям[оа]?\s*)?сейчас': "very_urgent",
            r'(?:нужн[оа]?|надо)\s*(?:вчера|срочно|немедленно)': "very_urgent",
            r'(?:asap|асап)': "very_urgent",
            r'(?:экстренн|критичн|аварийн)': "very_urgent",
            r'(?:дедлайн|deadline)\s*(?:гор|завтра|сегодня|на\s*нос)': "very_urgent",
            r'(?:времени?\s*)?(?:нет|мало)\s*(?:совсем)?': "very_urgent",
            r'(?:кровь\s*из\s*носа|любой\s*ценой|во\s*что\s*бы\s*то\s*ни\s*стало)': "very_urgent",

            # Срочно
            r'(?:на\s*)?(?:этой|ближайш)\w*\s*недел': "urgent",
            r'(?:в\s*)?(?:ближайш|скор)\w*\s*(?:врем|буду|дн)': "urgent",
            r'(?:как\s*можно\s*)?(?:скорее|быстрее|раньше)': "urgent",
            r'(?:до\s*конца\s*)?(?:недел|месяц|квартал)': "urgent",
            r'(?:не\s*)?терпит\s*(?:отлагательств)?': "urgent",
            r'(?:важно|критично|необходимо)': "urgent",
            r'(?:побыстрее|поскорее)': "urgent",

            # Не срочно
            r'(?:не\s*)?(?:очень\s*)?(?:срочн|горит)\s*(?:не|нет)': "not_urgent",
            r'(?:когда\s*)?удобно': "not_urgent",
            r'(?:не\s*)?(?:торопимся|спешим)': "not_urgent",
            r'(?:присматриваемся|изучаем|сравниваем)': "not_urgent",
            r'(?:на\s*)?будущее': "not_urgent",
            r'(?:в\s*)?(?:след|будущ)\w*\s*(?:месяц|квартал|полугод|год)': "not_urgent",
            r'(?:планируем|думаем|рассматриваем)': "not_urgent",
            r'(?:пока\s*)?(?:просто\s*)?(?:интересуюсь|смотрю|изучаю)': "not_urgent",
        }
        for pattern, urgency in urgency_patterns.items():
            if re.search(pattern, message_lower):
                extracted["urgency"] = urgency
                break

        # =================================================================
        # БЮДЖЕТ (budget_range)
        # =================================================================
        budget_patterns = [
            # Конкретные суммы
            (r'бюджет\w*\s*(?:около|примерно|до|от)?\s*(\d+)\s*(?:тысяч|т\.?р\.?|к|тыс)', 'thousands'),
            (r'(\d+)\s*(?:тысяч|т\.?р\.?|к|тыс)\w*\s*(?:бюджет|выделен|есть|готов)', 'thousands'),
            (r'бюджет\w*\s*(?:около|примерно|до|от)?\s*(\d+)\s*(?:миллион|млн|м)', 'millions'),
            (r'(\d+)\s*(?:миллион|млн|м)\w*\s*(?:бюджет|выделен|есть|готов)', 'millions'),
            (r'готов\w*\s*(?:платить|заплатить|отдать)\s*(?:до\s*)?(\d+)', 'thousands'),
            (r'(?:до|от)\s*(\d+)\s*(?:руб|₽|рублей)', 'rubles'),
        ]
        for pattern, scale in budget_patterns:
            match = re.search(pattern, message_lower)
            if match:
                amount = int(match.group(1))
                if scale == 'thousands':
                    extracted["budget_range"] = f"{amount}k"
                elif scale == 'millions':
                    extracted["budget_range"] = f"{amount}m"
                elif scale == 'rubles' and amount > 1000:
                    extracted["budget_range"] = f"{amount // 1000}k"
                break

        # Качественные оценки бюджета
        budget_quality_patterns = {
            r'бюджет\w*\s*(?:большой|серьёзн|нормальн|достаточн)': "high",
            r'бюджет\w*\s*(?:ограничен|небольш|маленьк|скромн)': "low",
            r'(?:неограничен|любой)\s*бюджет': "unlimited",
            r'денег\s*(?:нет|мало)': "very_low",
            r'(?:готов|могу|можем)\s*(?:платить|заплатить)': "has_budget",
            r'(?:не\s*)?(?:выделен|заложен|запланирован)\w*\s*бюджет': "planned",
        }
        for pattern, quality in budget_quality_patterns.items():
            if re.search(pattern, message_lower):
                if "budget_range" not in extracted:
                    extracted["budget_range"] = quality
                break

        # =================================================================
        # РОЛЬ / ДОЛЖНОСТЬ (role)
        # =================================================================
        role_patterns = {
            # Руководство
            r'(?:я\s*)?(?:директор|генеральн|гендир|ген\.?\s*дир)': "director",
            r'(?:я\s*)?(?:собственник|владелец|основатель|учредитель)': "owner",
            r'(?:я\s*)?(?:руководитель|руковожу|начальник|глава)': "head",
            r'(?:я\s*)?(?:управляющ|управленец|топ.менеджер)': "top_manager",
            r'(?:я\s*)?(?:rop|роп|рук\w*\s*отдел\w*\s*продаж)': "sales_head",
            r'(?:я\s*)?(?:ком\.?\s*дир|коммерч\w*\s*директор)': "commercial_director",

            # Средний менеджмент
            r'(?:я\s*)?(?:менеджер|специалист|сотрудник)': "employee",
            r'(?:я\s*)?(?:продавец|продажник|сейлз|sales)': "sales",
            r'(?:я\s*)?(?:маркетолог|smm|пиарщик)': "marketing",
            r'(?:я\s*)?(?:бухгалтер|финансист|экономист)': "finance",
            r'(?:я\s*)?(?:hr|эйчар|кадровик|рекрутер)': "hr",
            r'(?:я\s*)?(?:айтишник|программист|разработчик|it|ит)': "it",
            r'(?:я\s*)?(?:администратор|админ|секретарь|ассистент)': "admin",

            # IT-специфичные
            r'(?:я\s*)?(?:cto|cio|технич\w*\s*директор)': "cto",
            r'(?:я\s*)?(?:devops|девопс|сисадмин|системн\w*\s*администратор)': "devops",
            r'(?:я\s*)?(?:аналитик|bi|data)': "analyst",

            # Контекст принятия решений
            r'(?:принима|решаю|отвечаю\s*за)\w*\s*(?:решен|закупк|выбор)': "decision_maker",
            r'(?:изуча|сравнива|собираю\s*информац)\w*\s*(?:для\s*)?(?:руковод|директор|босс)': "researcher",
            r'(?:мне\s*)?(?:поручили|сказали|попросили)\s*(?:изучить|найти|подобрать)': "researcher",
        }
        for pattern, role in role_patterns.items():
            if re.search(pattern, message_lower):
                extracted["role"] = role
                break

        # =================================================================
        # ПРЕДПОЧИТАЕМЫЙ КАНАЛ СВЯЗИ (preferred_channel)
        # =================================================================
        channel_patterns = {
            # Телефон
            r'(?:лучше|удобнее|предпочитаю)\s*(?:позвон|по\s*телефон|созвон)': "phone",
            r'(?:звоните|позвоните|перезвоните)\s*(?:на|мне)': "phone",
            r'(?:по\s*)?телефон\w*\s*(?:удобн|лучше|предпочит)': "phone",

            # WhatsApp
            r'(?:whatsapp|ватсап|вотсап|вацап|воцап)': "whatsapp",
            r'(?:лучше|удобнее|пишите)\s*в\s*(?:whatsapp|ватсап|вотсап)': "whatsapp",

            # Telegram
            r'(?:telegram|телеграм|телега|тг)\s*(?:удобн|лучше|пишите)?': "telegram",
            r'(?:лучше|удобнее|пишите)\s*в\s*(?:telegram|телеграм|телегу|тг)': "telegram",

            # Email
            r'(?:email|почт[уае]|mail|мейл)\s*(?:удобн|лучше|пишите)?': "email",
            r'(?:лучше|удобнее|пишите)\s*на\s*(?:почту|email|mail)': "email",
            r'(?:напишите|пришлите)\s*на\s*(?:почту|email)': "email",

            # Любой
            r'(?:любой|любым)\s*(?:способ|канал|путь)': "any",
            r'(?:как\s*)?удобно\s*(?:вам|будет)': "any",
        }
        for pattern, channel in channel_patterns.items():
            if re.search(pattern, message_lower):
                extracted["preferred_channel"] = channel
                break

        # =================================================================
        # КОЛИЧЕСТВО ПОЛЬЗОВАТЕЛЕЙ (если не извлечено как company_size)
        # =================================================================
        if "company_size" not in extracted:
            user_patterns = [
                r'(\d+)\s*(?:пользовател|юзер|user|оператор|рабоч\w*\s*мест)',
                r'(?:на\s*)?(\d+)\s*(?:лицензи|место|аккаунт)',
                r'(?:лицензи|место|аккаунт)\w*\s*(?:на\s*)?(\d+)',
            ]
            for pattern in user_patterns:
                match = re.search(pattern, message_lower)
                if match:
                    count = int(match.group(1))
                    if 1 <= count <= 10000:
                        extracted["users_count"] = count
                        break

        # =================================================================
        # TIMELINE / СРОКИ ВНЕДРЕНИЯ
        # =================================================================
        timeline_patterns = {
            r'(?:сегодня|завтра|на\s*днях)': "immediate",
            r'(?:на\s*)?(?:этой|ближайш)\w*\s*недел': "this_week",
            r'(?:в\s*)?(?:этом|ближайш)\w*\s*месяц': "this_month",
            r'(?:в\s*)?(?:след|будущ)\w*\s*месяц': "next_month",
            r'(?:в\s*)?(?:этом|ближайш)\w*\s*квартал': "this_quarter",
            r'(?:в\s*)?(?:след|будущ)\w*\s*квартал': "next_quarter",
            r'(?:в\s*)?(?:этом|ближайш)\w*\s*году?': "this_year",
            r'(?:в\s*)?(?:след|будущ|нов)\w*\s*году?': "next_year",
            r'(?:не\s*)?(?:определено|понятно|знаю)\s*(?:когда)?': "undefined",
        }
        for pattern, timeline in timeline_patterns.items():
            if re.search(pattern, message_lower):
                extracted["timeline"] = timeline
                break

        return extracted


class HybridClassifier:
    """
    Гибридный классификатор: быстрый + точный

    1. Нормализация текста (TextNormalizer)
    2. Пробуем быструю классификацию по корням
    3. Если confidence >= threshold → возвращаем
    4. Иначе → fallback на pymorphy2
    5. Выбираем лучший результат
    """

    def __init__(self):
        self.normalizer = TextNormalizer()
        self.root_classifier = RootClassifier()
        self.lemma_classifier = LemmaClassifier()
        self.data_extractor = DataExtractor()
        self.config = CLASSIFIER_CONFIG

    def classify(self, message: str, context: Dict = None) -> Dict:
        """
        Полная классификация сообщения

        Args:
            message: Сообщение пользователя
            context: Контекст диалога (missing_data, collected_data, spin_phase, last_bot_intent)

        Returns:
            {
                "intent": str,
                "confidence": float,
                "extracted_data": dict,
                "method": str  # "root" | "lemma" | "data" | "spin" | "context"
            }
        """
        # 0. Нормализация текста (опечатки, слипшиеся слова, ё→е и т.д.)
        message = self.normalizer.normalize(message)
        message_lower = message.lower().strip()

        # =================================================================
        # КОНТЕКСТНАЯ КЛАССИФИКАЦИЯ КОРОТКИХ ОТВЕТОВ
        # =================================================================
        # Короткие ответы (1-3 слова) требуют контекста для правильной интерпретации
        words = message_lower.split()
        is_short_message = len(words) <= 3

        if is_short_message and context:
            context_result = self._classify_short_answer(message_lower, context)
            if context_result:
                # Извлекаем данные с учётом контекстного интента
                extracted = self.data_extractor.extract(message, context)
                return {
                    "intent": context_result["intent"],
                    "confidence": context_result["confidence"],
                    "extracted_data": extracted,
                    "method": "context"
                }

        # 1. Извлекаем данные (с учётом контекста и SPIN-фазы)
        extracted = self.data_extractor.extract(message, context)

        # Получаем текущую SPIN-фазу
        spin_phase = context.get("spin_phase") if context else None

        # =================================================================
        # SPIN-специфичная классификация на основе извлечённых данных
        # =================================================================

        # Если в фазе situation и получили данные о ситуации
        if spin_phase == "situation":
            if extracted.get("company_size") or extracted.get("current_tools") or extracted.get("business_type"):
                return {
                    "intent": "situation_provided",
                    "confidence": 0.9,
                    "extracted_data": extracted,
                    "method": "spin"
                }

        # Если в фазе problem и получили информацию о боли
        if spin_phase == "problem":
            if extracted.get("pain_point"):
                return {
                    "intent": "problem_revealed",
                    "confidence": 0.9,
                    "extracted_data": extracted,
                    "method": "spin"
                }

        # Если в фазе implication и клиент осознаёт последствия
        if spin_phase == "implication":
            if extracted.get("pain_impact") or extracted.get("financial_impact"):
                return {
                    "intent": "implication_acknowledged",
                    "confidence": 0.9,
                    "extracted_data": extracted,
                    "method": "spin"
                }

        # Если в фазе need_payoff и клиент выразил желаемый результат
        if spin_phase == "need_payoff":
            if extracted.get("desired_outcome") or extracted.get("value_acknowledged"):
                return {
                    "intent": "need_expressed",
                    "confidence": 0.9,
                    "extracted_data": extracted,
                    "method": "spin"
                }

        # =================================================================
        # Стандартная классификация (если не SPIN-специфичная)
        # =================================================================

        # Если есть данные — это info_provided (высокий приоритет)
        if extracted.get("company_size") or extracted.get("pain_point"):
            return {
                "intent": "info_provided",
                "confidence": 0.95,
                "extracted_data": extracted,
                "method": "data"
            }

        # Если есть контакт — contact_provided
        if extracted.get("contact_info"):
            return {
                "intent": "contact_provided",
                "confidence": 0.95,
                "extracted_data": extracted,
                "method": "data"
            }

        # 2. Быстрая классификация по корням
        root_intent, root_conf, root_scores = self.root_classifier.classify(message)

        # Если уверенность высокая — возвращаем сразу
        if root_conf >= self.config["high_confidence_threshold"]:
            return {
                "intent": root_intent,
                "confidence": root_conf,
                "extracted_data": extracted,
                "method": "root",
                "debug_scores": root_scores
            }

        # 3. Fallback на лемматизацию
        lemma_intent, lemma_conf, lemma_scores = self.lemma_classifier.classify(message)

        # 4. Выбираем лучший результат
        if lemma_conf > root_conf:
            return {
                "intent": lemma_intent,
                "confidence": lemma_conf,
                "extracted_data": extracted,
                "method": "lemma",
                "debug_scores": lemma_scores
            }

        # Если оба метода дали низкую уверенность
        if root_conf < self.config["min_confidence"]:
            return {
                "intent": "unclear",
                "confidence": root_conf,
                "extracted_data": extracted,
                "method": "root",
                "debug_scores": root_scores
            }

        return {
            "intent": root_intent,
            "confidence": root_conf,
            "extracted_data": extracted,
            "method": "root",
            "debug_scores": root_scores
        }

    def _classify_short_answer(self, message: str, context: Dict) -> Optional[Dict]:
        """
        Контекстная классификация коротких ответов.

        Короткие ответы типа "да", "нет", "ок", "понял" интерпретируются
        в зависимости от контекста: что спросил бот, в какой фазе диалог.

        Args:
            message: Нормализованное сообщение (lowercase)
            context: Контекст диалога

        Returns:
            {"intent": str, "confidence": float} или None если не определено
        """
        last_bot_intent = context.get("last_bot_intent")
        spin_phase = context.get("spin_phase")
        current_state = context.get("current_state")
        missing_data = context.get("missing_data", [])

        # =================================================================
        # УТВЕРДИТЕЛЬНЫЕ КОРОТКИЕ ОТВЕТЫ
        # =================================================================
        positive_markers = [
            r'^да[,!.\s]*$', r'^ага[,!.\s]*$', r'^угу[,!.\s]*$',
            r'^конечно[,!.\s]*$', r'^естественно[,!.\s]*$',
            r'^разумеется[,!.\s]*$', r'^точно[,!.\s]*$',
            r'^верно[,!.\s]*$', r'^согласен[,!.\s]*$',
            r'^ок[,!.\s]*$', r'^окей[,!.\s]*$', r'^хорошо[,!.\s]*$',
            r'^ладно[,!.\s]*$', r'^давайте[,!.\s]*$', r'^давай[,!.\s]*$',
            r'^можно[,!.\s]*$', r'^готов[,!.\s]*$', r'^готовы[,!.\s]*$',
            r'^понял[,!.\s]*$', r'^понятно[,!.\s]*$', r'^ясно[,!.\s]*$',
            r'^так\s*точно[,!.\s]*$', r'^именно[,!.\s]*$',
            r'^да\s*да[,!.\s]*$', r'^ну\s*да[,!.\s]*$',
            r'^в\s*принципе\s*да[,!.\s]*$', r'^скорее\s*да[,!.\s]*$',
        ]

        is_positive = any(re.match(p, message) for p in positive_markers)

        # =================================================================
        # ОТРИЦАТЕЛЬНЫЕ КОРОТКИЕ ОТВЕТЫ
        # =================================================================
        negative_markers = [
            r'^нет[,!.\s]*$', r'^неа[,!.\s]*$', r'^не[,!.\s]*$',
            r'^ноуп[,!.\s]*$', r'^ни\s*в\s*коем[,!.\s]*$',
            r'^ни\s*за\s*что[,!.\s]*$', r'^точно\s*нет[,!.\s]*$',
            r'^не\s*надо[,!.\s]*$', r'^не\s*нужно[,!.\s]*$',
            r'^отстаньте[,!.\s]*$', r'^хватит[,!.\s]*$',
            r'^стоп[,!.\s]*$', r'^нет\s*нет[,!.\s]*$',
            r'^вряд\s*ли[,!.\s]*$', r'^сомневаюсь[,!.\s]*$',
            r'^не\s*думаю[,!.\s]*$', r'^скорее\s*нет[,!.\s]*$',
        ]

        is_negative = any(re.match(p, message) for p in negative_markers)

        # =================================================================
        # НЕЙТРАЛЬНЫЕ / УТОЧНЯЮЩИЕ
        # =================================================================
        neutral_markers = [
            r'^может\s*быть[,!.\s]*$', r'^возможно[,!.\s]*$',
            r'^не\s*знаю[,!.\s]*$', r'^хз[,!.\s]*$',
            r'^посмотрим[,!.\s]*$', r'^подумаю[,!.\s]*$',
            r'^надо\s*подумать[,!.\s]*$',
        ]

        is_neutral = any(re.match(p, message) for p in neutral_markers)

        # =================================================================
        # ИНТЕРПРЕТАЦИЯ В ЗАВИСИМОСТИ ОТ КОНТЕКСТА
        # =================================================================

        # Если бот предложил демо и клиент согласился
        if last_bot_intent in ["offer_demo", "ask_demo", "demo_question"]:
            if is_positive:
                return {"intent": "demo_request", "confidence": 0.9}
            if is_negative:
                return {"intent": "rejection", "confidence": 0.85}

        # Если бот предложил созвониться
        if last_bot_intent in ["offer_call", "ask_callback", "callback_question"]:
            if is_positive:
                return {"intent": "callback_request", "confidence": 0.9}
            if is_negative:
                return {"intent": "rejection", "confidence": 0.8}

        # Если бот задавал вопрос о цене и ждёт реакции
        if last_bot_intent in ["price_answer", "pricing_provided"]:
            if is_positive:
                return {"intent": "agreement", "confidence": 0.85}
            if is_negative:
                return {"intent": "objection_price", "confidence": 0.8}

        # В SPIN-фазах
        if spin_phase == "situation":
            if is_positive:
                return {"intent": "situation_provided", "confidence": 0.7}

        if spin_phase == "problem":
            if is_positive:
                return {"intent": "problem_revealed", "confidence": 0.75}
            if is_negative:
                # Клиент отрицает наличие проблемы — это тоже информация
                return {"intent": "no_problem", "confidence": 0.7}

        if spin_phase == "implication":
            if is_positive:
                return {"intent": "implication_acknowledged", "confidence": 0.8}

        if spin_phase == "need_payoff":
            if is_positive:
                return {"intent": "need_expressed", "confidence": 0.85}
            if is_negative:
                return {"intent": "no_need", "confidence": 0.7}

        # Если в фазе закрытия и спрашивали контакт
        if current_state == "close" or "contact_info" in missing_data:
            if is_positive:
                return {"intent": "agreement", "confidence": 0.85}
            if is_negative:
                return {"intent": "rejection", "confidence": 0.85}

        # Если бот спрашивал о проблемах/болях
        if last_bot_intent in ["ask_problem", "ask_pain", "problem_question"]:
            if is_positive:
                return {"intent": "problem_revealed", "confidence": 0.75}
            if is_negative:
                return {"intent": "no_problem", "confidence": 0.7}

        # Если бот презентовал продукт
        if last_bot_intent in ["presentation", "feature_presentation", "value_proposition"]:
            if is_positive:
                return {"intent": "agreement", "confidence": 0.85}
            if is_negative:
                return {"intent": "rejection", "confidence": 0.8}

        # "Надо подумать" и похожие — objection_think
        if is_neutral:
            return {"intent": "objection_think", "confidence": 0.75}

        # Если ничего не подходит — общая интерпретация
        if is_positive:
            return {"intent": "agreement", "confidence": 0.7}
        if is_negative:
            return {"intent": "rejection", "confidence": 0.7}

        # Не удалось определить
        return None


# =============================================================================
# ТЕСТИРОВАНИЕ
# =============================================================================


def test_normalizer() -> bool:
    """Тест нормализатора текста"""
    n = TextNormalizer()

    tests = [
        # (input, expected_output)

        # Повторы букв
        ("приииивет", "привет"),
        ("скооолько стоооит", "сколько стоит"),
        ("даааа", "да"),
        ("неееет", "нет"),

        # Опечатки
        ("скока стоит", "сколько стоит"),
        ("ценик какой", "ценник какой"),
        ("прайслист скинь", "прайс скинь"),
        ("чё почём", "что почем"),

        # Слипшиеся слова
        ("сколькостоит", "сколько стоит"),
        ("какаяцена", "какая цена"),

        # Ё → Е
        ("подскажёте", "подскажете"),
        ("почём", "почем"),

        # Комбинированные
        ("приииив скока ценик", "привет сколько ценник"),
        ("здрааасте какаяцена", "здравствуйте какая цена"),

        # Приветствия с опечатками
        ("хаюшки", "привет"),
        ("здрасте", "здравствуйте"),
        ("дратути", "здравствуйте"),

        # Разговорные формы
        ("щас посмотрю", "сейчас посмотрю"),
        ("норм всё", "нормально все"),
        ("спс за инфу", "спасибо за инфу"),

        # Не должно ломать нормальный текст
        ("привет как дела", "привет как дела"),
        ("сколько стоит на 10 человек", "сколько стоит на 10 человек"),
        ("добрый день", "добрый день"),
    ]

    passed = 0
    for inp, expected in tests:
        result = n.normalize(inp)
        status = "✓" if result == expected else "✗"
        if result == expected:
            passed += 1
        else:
            print(f"{status} '{inp}' → '{result}' (ожидали: '{expected}')")

    print(f"\nНормализатор: {passed}/{len(tests)} тестов пройдено")
    return passed == len(tests)


def test_classifier() -> bool:
    """Тест классификатора (существующие тесты)"""
    classifier = HybridClassifier()

    test_cases = [
        # Приветствия
        ("Привет!", "greeting"),
        ("Здравствуйте, подскажите пожалуйста", "greeting"),
        ("Добрый день", "greeting"),

        # Вопросы о цене (разные формулировки)
        ("Сколько стоит?", "price_question"),
        ("Какая цена?", "price_question"),
        ("Подскажите по стоимости", "price_question"),
        ("Ценник какой?", "price_question"),
        ("А прайс есть?", "price_question"),
        ("Какие тарифы?", "price_question"),
        ("Во сколько обойдётся?", "price_question"),

        # Возражения
        ("Дорого", "objection_price"),
        ("Слишком дорого для нас", "objection_price"),
        ("Нет бюджета на это", "objection_price"),
        ("Нет времени сейчас", "objection_no_time"),
        ("Занят, перезвоните позже", "objection_no_time"),
        ("У нас уже есть CRM", "objection_competitor"),
        ("Используем Битрикс24", "objection_competitor"),

        # Согласие
        ("Да, интересно", "agreement"),
        ("Давайте попробуем", "agreement"),
        ("Расскажите подробнее", "agreement"),
        ("Хочу демо", "agreement"),

        # Отказ
        ("Не интересно", "rejection"),
        ("Нет, спасибо", "rejection"),
        ("Не нужно", "rejection"),

        # Данные
        ("У нас 15 человек в отделе", "info_provided"),
        ("Постоянно теряем клиентов", "info_provided"),
        ("Работаем в Excel, всё теряется", "info_provided"),
        ("Мой email: test@company.ru", "contact_provided"),
        ("+7 999 123-45-67", "contact_provided"),
    ]

    passed = 0
    failed = 0

    for message, expected in test_cases:
        result = classifier.classify(message)
        actual = result["intent"]
        conf = result["confidence"]
        method = result["method"]

        status = "✓" if actual == expected else "✗"
        if actual == expected:
            passed += 1
        else:
            failed += 1
            print(f"{status} '{message}'")
            print(f"   Ожидали: {expected}, Получили: {actual} ({conf:.2f}) [{method}]")
            if result.get("extracted_data"):
                print(f"   Данные: {result['extracted_data']}")

    print(f"\nКлассификатор: {passed}/{passed+failed} тестов пройдено")
    return passed == len(test_cases)


def test_full_pipeline() -> bool:
    """Тест полного пайплайна: нормализация → классификация → извлечение"""
    classifier = HybridClassifier()

    tests = [
        # (message, expected_intent, expected_data_key, expected_data_value)

        # Опечатки в вопросах о цене
        ("скока стоит", "price_question", None, None),
        ("ценик какой", "price_question", None, None),
        ("прайсик скиньте", "price_question", None, None),
        ("скока ваш прайс", "price_question", None, None),

        # Приветствия с ошибками
        ("приииивет", "greeting", None, None),
        ("здрааасте", "greeting", None, None),
        ("хаюшки", "greeting", None, None),
        ("дратути", "greeting", None, None),

        # Слипшиеся слова
        ("сколькостоит", "price_question", None, None),
        ("какаяцена", "price_question", None, None),

        # Данные с опечатками (размер команды)
        ("у нас 15 чел", "info_provided", "company_size", 15),
        ("команда 8 человеек", "info_provided", "company_size", 8),

        # Боли с опечатками
        ("менеджеры забыыывают звонить", "info_provided", "pain_point", "забывают задачи"),
        ("теряеем клиентов", "info_provided", "pain_point", "потеря клиентов"),

        # Возражения с опечатками
        ("дорга очень", "objection_price", None, None),
        ("дорага для нас", "objection_price", None, None),

        # Нормальные сообщения (не должны ломаться)
        ("сколько стоит на 10 человек", "info_provided", "company_size", 10),
        ("привет", "greeting", None, None),
        ("дорого", "objection_price", None, None),
        ("да, интересно", "agreement", None, None),
        ("какая цена", "price_question", None, None),
    ]

    passed = 0
    for msg, exp_intent, exp_key, exp_value in tests:
        result = classifier.classify(msg)

        intent_ok = result["intent"] == exp_intent
        data_ok = True
        if exp_key:
            data_ok = result.get("extracted_data", {}).get(exp_key) == exp_value

        if intent_ok and data_ok:
            passed += 1
        else:
            print(f"✗ '{msg}'")
            print(f"   Ожидали: intent={exp_intent}, {exp_key}={exp_value}")
            print(f"   Получили: intent={result['intent']}, data={result.get('extracted_data')}")

    print(f"\nПолный пайплайн: {passed}/{len(tests)} тестов пройдено")
    return passed == len(tests)


if __name__ == "__main__":
    print("=" * 60)
    print("ТЕСТИРОВАНИЕ КЛАССИФИКАТОРА")
    print("=" * 60)

    # 1. Тест нормализатора
    print("\n### ТЕСТ НОРМАЛИЗАТОРА ###\n")
    norm_ok = test_normalizer()

    # 2. Тест классификатора (существующие тесты)
    print("\n### ТЕСТ КЛАССИФИКАТОРА ###\n")
    class_ok = test_classifier()

    # 3. End-to-end тест
    print("\n### END-TO-END ТЕСТ ###\n")
    e2e_ok = test_full_pipeline()

    # Итог
    print("\n" + "=" * 60)
    all_passed = norm_ok and class_ok and e2e_ok
    if all_passed:
        print("✓ ВСЕ ТЕСТЫ ПРОЙДЕНЫ")
    else:
        print("✗ ЕСТЬ ОШИБКИ")
        if not norm_ok:
            print("  - Ошибки в нормализаторе")
        if not class_ok:
            print("  - Ошибки в классификаторе")
        if not e2e_ok:
            print("  - Ошибки в end-to-end тестах")
    print("=" * 60)
