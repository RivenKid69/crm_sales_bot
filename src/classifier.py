"""
Гибридный классификатор интентов + извлечение данных

Архитектура:
1. Нормализация текста (TextNormalizer)
2. Быстрая проверка по корням слов (INTENT_ROOTS)
3. Если confidence < threshold → fallback на pymorphy2 (лемматизация)
4. Извлечение данных (company_size, pain_point, contact_info) через regex
"""

import re
import difflib
from typing import Dict, List, Tuple, Optional


# =============================================================================
# СЛОВАРИ ДЛЯ НОРМАЛИЗАЦИИ ТЕКСТА
# =============================================================================

# Словарь опечаток и разговорных форм → нормализованные варианты
TYPO_FIXES: Dict[str, str] = {
    # =================================================================
    # ЦЕНОВЫЕ СЛОВА
    # =================================================================
    "ценик": "ценник",
    "ценика": "ценника",
    "цена": "цена",
    "скока": "сколько",
    "скоко": "сколько",
    "скольк": "сколько",
    "почом": "почем",
    "почем": "почем",
    "скидон": "скидка",
    "скидос": "скидка",
    "прайс": "прайс",
    "прайслист": "прайс",
    "прайсик": "прайс",
    "тарифчик": "тариф",
    "тарифы": "тарифы",
    "стоимость": "стоимость",
    "стоит": "стоит",
    "денег": "денег",
    "деняг": "денег",
    "бабла": "денег",
    "бабло": "деньги",
    "бабок": "денег",

    # =================================================================
    # ПРИВЕТСТВИЯ И ПРОЩАНИЯ
    # =================================================================
    "прив": "привет",
    "превед": "привет",
    "приф": "привет",
    "прива": "привет",
    "привки": "привет",
    "хай": "привет",
    "хаюшки": "привет",
    "хеллоу": "привет",
    "здрасте": "здравствуйте",
    "здрасьте": "здравствуйте",
    "здаров": "здравствуйте",
    "здарова": "здравствуйте",
    "дратути": "здравствуйте",
    "доброго": "добрый",
    "добр": "добрый",
    "утречко": "утро",
    "вечерочек": "вечер",
    "денечек": "день",
    "пок": "пока",
    "покеда": "пока",
    "покедова": "пока",
    "бай": "пока",
    "бб": "пока",
    "удачки": "удачи",

    # =================================================================
    # РАЗГОВОРНЫЕ И СЛЕНГОВЫЕ
    # =================================================================
    "че": "что",
    "чо": "что",
    "шо": "что",
    "чего": "что",
    "чет": "что-то",
    "чето": "что-то",
    "чот": "что-то",
    "щас": "сейчас",
    "счас": "сейчас",
    "ща": "сейчас",
    "седня": "сегодня",
    "сегдня": "сегодня",
    "тока": "только",
    "ток": "только",
    "токо": "только",
    "тоже": "тоже",
    "тож": "тоже",
    "ваще": "вообще",
    "вапще": "вообще",
    "вобще": "вообще",
    "вопщем": "в общем",
    "короч": "короче",
    "кароч": "короче",
    "норм": "нормально",
    "нормик": "нормально",
    "ок": "хорошо",
    "окей": "хорошо",
    "океюшки": "хорошо",
    "лан": "ладно",
    "ладн": "ладно",
    "ладушки": "ладно",
    "спс": "спасибо",
    "спсб": "спасибо",
    "пасиб": "спасибо",
    "пасибо": "спасибо",
    "спасиб": "спасибо",
    "плз": "пожалуйста",
    "плиз": "пожалуйста",
    "пжлст": "пожалуйста",
    "пжл": "пожалуйста",
    "пж": "пожалуйста",
    "дап": "да",
    "ага": "да",
    "угу": "да",
    "неа": "нет",
    "непа": "нет",
    "нету": "нет",
    "ну": "ну",
    "нуну": "ну",
    "типо": "типа",
    "типа": "типа",
    "оч": "очень",
    "ооч": "очень",
    "оооч": "очень",
    "канеш": "конечно",
    "канешна": "конечно",
    "конеш": "конечно",
    "наверн": "наверное",
    "наврн": "наверное",
    "мб": "может быть",
    "возм": "возможно",
    "возмжно": "возможно",

    # =================================================================
    # БИЗНЕС-ТЕРМИНЫ
    # =================================================================
    "црм": "crm",
    "срм": "crm",
    "црм": "crm",
    "црмка": "crm",
    "цээрэм": "crm",
    "битрик": "битрикс",
    "битрикс24": "битрикс",
    "амо": "амо",
    "амоцрм": "амо crm",
    "эксель": "excel",
    "эксел": "excel",
    "ексель": "excel",
    "табличка": "таблица",
    "табличку": "таблицу",
    "менеджр": "менеджер",
    "манагер": "менеджер",
    "сейлз": "менеджер по продажам",
    "сэйлз": "менеджер по продажам",
    "продажник": "менеджер по продажам",
    "клиентов": "клиентов",
    "клиентоф": "клиентов",
    "заявка": "заявка",
    "заявочка": "заявка",
    "лид": "лид",
    "лидик": "лид",
    "лидов": "лидов",
    "сделка": "сделка",
    "сделочка": "сделка",
    "контракт": "контракт",
    "договор": "договор",
    "дкп": "договор",

    # =================================================================
    # ЧИСЛИТЕЛЬНЫЕ И ЕДИНИЦЫ
    # =================================================================
    "чел": "человек",
    "челов": "человек",
    "человеек": "человек",
    "человк": "человек",
    "чвек": "человек",
    "сотр": "сотрудник",
    "сотрудн": "сотрудник",
    "штук": "штук",
    "шт": "штук",
    "руб": "рублей",
    "р": "рублей",
    "тыс": "тысяч",
    "к": "тысяч",
    "кк": "миллион",
    "млн": "миллион",
    "лям": "миллион",
    "мес": "месяц",
    "мсц": "месяц",

    # =================================================================
    # ВОПРОСИТЕЛЬНЫЕ
    # =================================================================
    "скажите": "скажите",
    "подскажте": "подскажите",
    "падскажите": "подскажите",
    "подскжите": "подскажите",
    "расскажте": "расскажите",
    "раскажите": "расскажите",

    # =================================================================
    # ОТРИЦАНИЯ И ВОЗРАЖЕНИЯ
    # =================================================================
    "дорга": "дорого",
    "дорага": "дорого",
    "доргао": "дорого",
    "дешево": "дешево",
    "дешивле": "дешевле",
    "интерсно": "интересно",
    "интиресно": "интересно",
    "неинтересно": "не интересно",
    "неинтерсно": "не интересно",
    "ненужно": "не нужно",
    "ненадо": "не надо",

    # =================================================================
    # СЛИПШИЕСЯ СЛОВА (основные)
    # =================================================================
    "сколькостоит": "сколько стоит",
    "какаяцена": "какая цена",
    "какойценник": "какой ценник",
    "скинутьпрайс": "скинуть прайс",
    "естьскидки": "есть скидки",
    "подскажитецену": "подскажите цену",
    "чтопочем": "что почем",
    "какиетарифы": "какие тарифы",
    "какстоимость": "как стоимость",
    "естьдемо": "есть демо",
    "хочудемо": "хочу демо",
    "хочупопробовать": "хочу попробовать",
    "давайтепопробуем": "давайте попробуем",
    "расскажитеподробнее": "расскажите подробнее",
    "ненужноспасибо": "не нужно спасибо",
    "нетспасибо": "нет спасибо",
    "даинтересно": "да интересно",
    "добрыйдень": "добрый день",
    "доброеутро": "доброе утро",
    "добрыйвечер": "добрый вечер",

    # =================================================================
    # РАСКЛАДКА КЛАВИАТУРЫ (латиница → кириллица)
    # =================================================================
    "ghbdtn": "привет",
    "ghbd": "привет",
    "plfhfcndeqnt": "здравствуйте",
    "lj,hsq ltym": "добрый день",
    "crjkmrj cnjbn": "сколько стоит",
    "wtyf": "цена",
    "ghfqc": "прайс",
    "ljhjuj": "дорого",
    "bynthtcyj": "интересно",
    "yt ye;yj": "не нужно",
    "cgfcb,j": "спасибо",
    "lf": "да",
    "ytn": "нет",
}

# Паттерны для разбиения слипшихся слов (regex)
SPLIT_PATTERNS: List[Tuple[str, str]] = [
    # Вопросы о цене
    (r'сколько(\w)', r'сколько \1'),
    (r'какая(\w)', r'какая \1'),
    (r'какой(\w)', r'какой \1'),
    (r'какие(\w)', r'какие \1'),
    (r'какую(\w)', r'какую \1'),

    # Глаголы
    (r'есть(\w)', r'есть \1'),
    (r'хочу(\w)', r'хочу \1'),
    (r'нужно(\w)', r'нужно \1'),
    (r'можно(\w)', r'можно \1'),
    (r'давайте(\w)', r'давайте \1'),
    (r'скинуть(\w)', r'скинуть \1'),
    (r'расскажите(\w)', r'расскажите \1'),
    (r'подскажите(\w)', r'подскажите \1'),

    # Приветствия
    (r'добрый(\w)', r'добрый \1'),
    (r'доброе(\w)', r'доброе \1'),
    (r'привет(\w)', r'привет \1'),

    # Отрицания
    (r'не(\w{3,})', r'не \1'),  # минимум 3 буквы после "не"
    (r'нет(\w{3,})', r'нет \1'),

    # Местоимения
    (r'что(\w{3,})', r'что \1'),
    (r'как(\w{3,})', r'как \1'),

    # Убран паттерн для "да" - он ломал "давайте" → "да вайте"
]


class TextNormalizer:
    """
    Нормализатор текста для русскоязычных сообщений

    Обрабатывает:
    - Регистр и пробелы
    - Ё → Е
    - Повторяющиеся буквы
    - Опечатки и сленг
    - Слипшиеся слова
    """

    def __init__(self):
        self.typo_fixes = TYPO_FIXES
        self.split_patterns = SPLIT_PATTERNS
        # Предкомпилированные regex для производительности
        self._compiled_splits = [(re.compile(p), r) for p, r in self.split_patterns]
        # Regex для повторяющихся БУКВ (3+ подряд → 2), НЕ цифр!
        self._repeated_chars = re.compile(r'([а-яёa-z])\1{2,}', re.IGNORECASE)
        # Regex для множественных пробелов
        self._multiple_spaces = re.compile(r'\s+')

    def normalize(self, text: str) -> str:
        """
        Полная нормализация текста

        Этапы:
        1. lower() + strip()
        2. Ё → Е
        3. Убрать повторяющиеся буквы: "приииивет" → "привет"
        4. Убрать лишние пробелы
        5. Исправить слипшиеся слова
        6. Исправить опечатки

        Args:
            text: Исходный текст

        Returns:
            Нормализованный текст
        """
        if not text:
            return ""

        # 1. Базовая нормализация
        result = text.lower().strip()

        # 2. Ё → Е
        result = result.replace('ё', 'е')

        # 3. Убираем повторяющиеся буквы (3+ → 1, потом слово проверим)
        # Сначала сжимаем до 2 букв, потом до 1 если слово не в словаре
        result = self._reduce_repeated_chars(result)

        # 4. Нормализуем пробелы
        result = self._multiple_spaces.sub(' ', result).strip()

        # 5. Разбиваем слипшиеся слова (regex паттерны)
        result = self._apply_split_patterns(result)

        # 6. Исправляем опечатки (по словарю)
        result = self._fix_typos(result)

        # Финальная очистка пробелов
        result = self._multiple_spaces.sub(' ', result).strip()

        return result

    def _reduce_repeated_chars(self, text: str) -> str:
        """
        Убираем повторяющиеся буквы

        "приииивет" → "привет"
        "скооолько" → "сколько"
        "даааа" → "да"
        """
        # Сначала сжимаем 3+ повторов до 2
        result = self._repeated_chars.sub(r'\1\1', text)

        # Затем пробуем сжать до 1, если это даёт валидное слово
        words = result.split()
        normalized_words = []

        for word in words:
            # Пробуем варианты с одинарными буквами (только буквы, не цифры!)
            single_char = re.sub(r'([а-яёa-z])\1+', r'\1', word, flags=re.IGNORECASE)

            # Если слово в словаре опечаток — берём его
            if single_char in self.typo_fixes:
                normalized_words.append(single_char)
            elif word in self.typo_fixes:
                normalized_words.append(word)
            else:
                # Пробуем single_char как более вероятный вариант
                # для русских слов двойные буквы редки
                normalized_words.append(single_char)

        return ' '.join(normalized_words)

    def _apply_split_patterns(self, text: str) -> str:
        """Применяем паттерны разбиения слипшихся слов"""
        result = text

        # Сначала проверяем полные слова в словаре
        words = result.split()
        fixed_words = []

        for word in words:
            # Если слово целиком есть в словаре опечаток — подставляем
            if word in self.typo_fixes:
                fixed_words.append(self.typo_fixes[word])
            else:
                fixed_words.append(word)

        result = ' '.join(fixed_words)

        # Затем применяем regex паттерны
        for pattern, replacement in self._compiled_splits:
            result = pattern.sub(replacement, result)

        return result

    def _fix_typos(self, text: str) -> str:
        """Исправляем опечатки по словарю"""
        words = text.split()
        fixed_words = []

        for word in words:
            # Убираем пунктуацию для поиска
            clean_word = re.sub(r'[^\w]', '', word)

            if clean_word in self.typo_fixes:
                # Сохраняем пунктуацию
                prefix = ''
                suffix = ''
                if word and not word[0].isalnum():
                    prefix = word[0]
                if word and not word[-1].isalnum():
                    suffix = word[-1]
                fixed_words.append(prefix + self.typo_fixes[clean_word] + suffix)
            else:
                fixed_words.append(word)

        return ' '.join(fixed_words)

    def fuzzy_match(self, word: str, targets: List[str], threshold: float = 0.75) -> Optional[str]:
        """
        Нечёткий поиск ближайшего слова

        Args:
            word: Искомое слово
            targets: Список целевых слов
            threshold: Минимальный порог схожести (0.0-1.0)

        Returns:
            Ближайшее слово если similarity >= threshold, иначе None
        """
        if not word or not targets:
            return None

        best_match = None
        best_ratio = 0.0

        for target in targets:
            ratio = difflib.SequenceMatcher(None, word.lower(), target.lower()).ratio()
            if ratio > best_ratio and ratio >= threshold:
                best_ratio = ratio
                best_match = target

        return best_match

    def suggest_correction(self, word: str, threshold: float = 0.7) -> Optional[str]:
        """
        Предлагает исправление для неизвестного слова

        Использует fuzzy matching по словарю опечаток
        """
        return self.fuzzy_match(word, list(self.typo_fixes.keys()), threshold)

try:
    from pymorphy3 import MorphAnalyzer
    PYMORPHY_AVAILABLE = True
except ImportError:
    try:
        from pymorphy2 import MorphAnalyzer
        PYMORPHY_AVAILABLE = True
    except ImportError:
        PYMORPHY_AVAILABLE = False
        MorphAnalyzer = None
        print("[WARNING] pymorphy2/pymorphy3 не установлен. Fallback на лемматизацию недоступен.")

from config import (
    INTENT_ROOTS,
    INTENT_PHRASES,
    CLASSIFIER_CONFIG
)


# =============================================================================
# ПРИОРИТЕТНЫЕ ПАТТЕРНЫ (проверяются ПЕРЕД обычной классификацией)
# =============================================================================
# Эти паттерны решают проблему когда "не интересно" ловится как "agreement"
# из-за корня "интересн", хотя по смыслу это rejection

PRIORITY_PATTERNS: List[Tuple[str, str, float]] = [
    # (pattern, intent, confidence)

    # === CLARIFICATION (уточнение — "нет" + позитивный контекст) ===
    # Важно: эти паттерны ПЕРЕД rejection, чтобы "нет, кое-что конкретное" не стало отказом
    # "нет, кое что/кое-что" — уточнение запроса
    (r'нет,?\s*кое[\s\-]?(?:что|чего)', "agreement", 0.9),
    # "нет, мне нужно/интересно/хочу" — интерес после "нет"
    (r'нет,?\s*(?:мне|нам)\s*(?:нужн|интересн|хоч)', "agreement", 0.9),
    # "нет, я хочу/хотел" — желание
    (r'нет,?\s*я\s*хо[чт]', "agreement", 0.9),
    # "нет, но..." — уточнение с союзом
    (r'нет,?\s*но\s', "agreement", 0.85),
    # "нет, не всё/все, а..." — уточнение
    (r'нет,?\s*не\s*вс[еёо]', "agreement", 0.85),
    # "нет, только/конкретно/именно" — уточнение
    (r'нет,?\s*(?:только|конкретн|именно|определ)', "agreement", 0.9),
    # "нет, другое/другой вопрос" — смена темы, не отказ
    (r'нет,?\s*друг', "agreement", 0.85),
    # "нет, расскажите/покажите" — просьба продолжить
    (r'нет,?\s*(?:расскажите|покажите|объясните)', "agreement", 0.9),

    # === REJECTION (отказы с отрицанием) ===
    # "не интересно", "неинтересно"
    (r'не\s*интересн', "rejection", 0.9),
    (r'неинтересн', "rejection", 0.9),
    # "не нужно", "ненужно"
    (r'не\s*нужн', "rejection", 0.9),
    (r'ненужн', "rejection", 0.9),
    # "не надо", "ненадо"
    (r'не\s*надо', "rejection", 0.9),
    (r'ненадо', "rejection", 0.9),
    # "не хочу", "не хотим"
    (r'не\s*хо[чт]', "rejection", 0.85),
    # "не буду", "не будем"
    (r'не\s*буд', "rejection", 0.85),
    # "нет спасибо", "нет, спасибо"
    (r'нет,?\s*спасибо', "rejection", 0.9),
    # "спасибо не надо/нужно"
    (r'спасибо,?\s*не\s*(?:надо|нужн)', "rejection", 0.9),

    # === OBJECTION_PRICE (возражения по цене) ===
    # "нет бюджета", "бюджета нет"
    (r'нет\s*бюджет', "objection_price", 0.9),
    (r'бюджет\w*\s*нет', "objection_price", 0.9),
    # "без бюджета", "не заложено в бюджет"
    (r'без\s*бюджет', "objection_price", 0.85),
    (r'не\s*залож\w*\s*(?:в\s*)?бюджет', "objection_price", 0.85),
    # "денег нет", "нет денег"
    (r'денег\s*нет', "objection_price", 0.9),
    (r'нет\s*денег', "objection_price", 0.9),
    # "не потянем", "не потянуть"
    (r'не\s*потян', "objection_price", 0.85),

    # === AGREEMENT (согласие) ===
    # "давайте попробуем", "давай попробуем"
    (r'давай\w*\s*попробу', "agreement", 0.9),
    # "хочу попробовать"
    (r'хочу\s*попробо', "agreement", 0.9),
    # "да, интересно", "да интересно"
    (r'да,?\s*интересн', "agreement", 0.9),
    # "да, давайте"
    (r'да,?\s*давайте', "agreement", 0.9),
    # "расскажите подробнее"
    (r'расскажите\s*подробн', "agreement", 0.85),
    # "хочу демо", "хотим демо"
    (r'хо[чт]\w*\s*демо', "agreement", 0.9),

    # === OBJECTION_NO_TIME ===
    # "нет времени"
    (r'нет\s*времен', "objection_no_time", 0.9),
    # "сейчас не могу"
    (r'сейчас\s*не\s*мог', "objection_no_time", 0.85),
]

# Компилируем паттерны для производительности
_COMPILED_PRIORITY_PATTERNS = [(re.compile(p, re.IGNORECASE), intent, conf)
                                for p, intent, conf in PRIORITY_PATTERNS]


class RootClassifier:
    """Быстрая классификация по корням слов"""

    def __init__(self):
        self.roots = INTENT_ROOTS
        self.config = CLASSIFIER_CONFIG
        self.priority_patterns = _COMPILED_PRIORITY_PATTERNS

    def classify(self, message: str) -> Tuple[str, float, Dict[str, int]]:
        """
        Классификация по корням

        Returns:
            (intent, confidence, scores_dict)
        """
        message_lower = message.lower()

        # ШАГ 0: Проверяем приоритетные паттерны
        # Это решает проблему "не интересно" → rejection (а не agreement)
        for pattern, intent, confidence in self.priority_patterns:
            if pattern.search(message_lower):
                return intent, confidence, {intent: 3}  # высокий score

        # ШАГ 1: Обычная классификация по корням
        scores: Dict[str, int] = {}

        for intent, roots in self.roots.items():
            score = 0
            for root in roots:
                if root in message_lower:
                    score += 1
            if score > 0:
                scores[intent] = score

        if not scores:
            return "unclear", 0.0, {}

        # Находим лучший интент
        best_intent = max(scores, key=scores.get)
        best_score = scores[best_intent]

        # Нормализуем confidence
        # Чем больше совпадений, тем выше уверенность
        confidence = min(best_score * self.config["root_match_weight"] / 3, 1.0)

        # Бонус если есть явный лидер (разрыв с вторым местом)
        sorted_scores = sorted(scores.values(), reverse=True)
        if len(sorted_scores) > 1:
            gap = sorted_scores[0] - sorted_scores[1]
            if gap >= 2:
                confidence = min(confidence + 0.2, 1.0)

        return best_intent, confidence, scores


class LemmaClassifier:
    """Fallback классификация через pymorphy2"""

    def __init__(self):
        self.phrases = INTENT_PHRASES
        self.config = CLASSIFIER_CONFIG
        self.morph = MorphAnalyzer() if PYMORPHY_AVAILABLE else None

    def _lemmatize(self, text: str) -> List[str]:
        """Приводим слова к нормальной форме"""
        if not self.morph:
            return text.lower().split()

        words = re.findall(r'[а-яёa-z0-9]+', text.lower())
        lemmas = []
        for word in words:
            parsed = self.morph.parse(word)
            if parsed:
                lemmas.append(parsed[0].normal_form)
            else:
                lemmas.append(word)
        return lemmas

    def _lemmatize_phrase(self, phrase: str) -> str:
        """Лемматизируем фразу и склеиваем обратно"""
        return " ".join(self._lemmatize(phrase))

    def classify(self, message: str) -> Tuple[str, float, Dict[str, float]]:
        """
        Классификация через лемматизацию

        Returns:
            (intent, confidence, scores_dict)
        """
        if not PYMORPHY_AVAILABLE:
            return "unclear", 0.0, {}

        message_lemmas = self._lemmatize(message)
        message_lemma_str = " ".join(message_lemmas)

        scores: Dict[str, float] = {}

        for intent, phrases in self.phrases.items():
            best_match_score = 0.0

            for phrase in phrases:
                phrase_lemmas = self._lemmatize(phrase)
                phrase_lemma_str = " ".join(phrase_lemmas)

                # Точное совпадение лемматизированной фразы
                if phrase_lemma_str in message_lemma_str:
                    match_score = len(phrase_lemmas) * self.config["lemma_match_weight"]
                    best_match_score = max(best_match_score, match_score)
                    continue

                # Частичное совпадение (все леммы фразы есть в сообщении)
                matching_lemmas = sum(1 for l in phrase_lemmas if l in message_lemmas)
                if matching_lemmas == len(phrase_lemmas):
                    match_score = matching_lemmas * self.config["lemma_match_weight"] * 0.8
                    best_match_score = max(best_match_score, match_score)

            if best_match_score > 0:
                scores[intent] = best_match_score

        if not scores:
            return "unclear", 0.0, {}

        best_intent = max(scores, key=scores.get)
        best_score = scores[best_intent]

        # Нормализуем confidence
        confidence = min(best_score / 4, 1.0)

        return best_intent, confidence, scores


class DataExtractor:
    """Извлекаем структурированные данные из сообщения"""

    def extract(self, message: str, context: Dict = None) -> Dict:
        """
        Извлекаем данные из сообщения

        Args:
            message: Сообщение пользователя
            context: Контекст (missing_data, collected_data) для понимания коротких ответов
        """
        extracted = {}
        message_lower = message.lower().strip()
        context = context or {}
        missing_data = context.get("missing_data", [])

        # === Размер компании ===
        size_patterns = [
            r'(\d+)\s*(?:человек|чел\.?|менеджер|сотрудник|продаж)',
            r'нас\s*(\d+)',
            r'команд[аы]?\s*(?:из|в|на)?\s*(\d+)',
            r'отдел[еа]?\s*(\d+)',
            r'(\d+)\s*(?:в команде|в отделе|человек)',
            r'штат[еа]?\s*(\d+)',
            r'работа[ею]т?\s*(\d+)',
        ]
        for pattern in size_patterns:
            match = re.search(pattern, message_lower)
            if match:
                size = int(match.group(1))
                if 1 <= size <= 10000:
                    extracted["company_size"] = size
                    break

        # Контекстное извлечение: если просто число и спрашивали о размере
        if "company_size" not in extracted and "company_size" in missing_data:
            # Проверяем что сообщение — просто число (возможно со словами)
            just_number = re.match(r'^(\d+)\s*(?:человек|чел)?\.?$', message_lower)
            if just_number:
                size = int(just_number.group(1))
                if 1 <= size <= 10000:
                    extracted["company_size"] = size

        # === Боль клиента ===
        pain_patterns = {
            # =================================================================
            # ПОТЕРЯ КЛИЕНТОВ И ОТТОК
            # =================================================================
            r'теря[ею]м?\s*клиент': "потеря клиентов",
            r'клиент\w*\s*(?:ухо|уш[её]л|сбеж|ушли)': "клиенты уходят",
            r'(?:отток|утечк)\w*\s*клиент': "отток клиентов",
            r'клиент\w*\s*(?:недовольн|жалу|ругают)': "недовольные клиенты",
            r'не\s*(?:возвращ|удержива)\w*\s*клиент': "не удерживаем клиентов",
            r'уход\w*\s*клиент': "клиенты уходят",
            r'клиент\w*\s*(?:уход|теря|бег)': "клиенты уходят",
            r'(?:мало|нет)\s*повторн': "нет повторных продаж",
            r'не\s*(?:возвращаются|приходят\s*снова)': "клиенты не возвращаются",
            r'(?:потерял|упустил)\w*\s*(?:клиент|заказ|сделк)': "упускаем клиентов",
            # Дополнительные паттерны
            r'клиент\w*\s*(?:сливают|слив)': "сливаем клиентов",
            r'(?:сливают|слив)\w*\s*клиент': "сливаем клиентов",
            r'(?:портим|испортил)\w*\s*(?:отношен|репутац)\w*\s*(?:с\s*)?клиент': "портим отношения с клиентами",
            r'клиент\w*\s*(?:злят|злит|бесит|раздражён)': "клиенты недовольны",
            r'(?:негатив|плох)\w*\s*(?:отзыв|обратн\w*\s*связ)': "негативные отзывы",
            r'клиент\w*\s*(?:пишут|оставля)\w*\s*(?:негатив|плох)': "негативные отзывы",
            r'(?:рейтинг|оценк)\w*\s*(?:пада|сниж|низк|плох)': "падает рейтинг",
            r'(?:nps|нпс|лояльн)\w*\s*(?:низк|пада|плох)': "низкая лояльность",

            # =================================================================
            # УПУЩЕННЫЕ СДЕЛКИ И ЛИДЫ
            # =================================================================
            r'упуска[ею]м?\s*(?:сделк|лид|заявк|клиент)?': "упускаем сделки",
            r'(?:сделк|лид|заявк)\w*\s*(?:теря|пропа|упуск)': "теряем заявки",
            r'(?:пропуск|теря)\w*\s*(?:заявк|лид|обращен)': "пропускаем заявки",
            r'заявк\w*\s*(?:не\s*)?(?:обрабат|отвеча)': "заявки не обрабатываются",
            r'(?:долго|медленно)\s*(?:отвеча|реагир)\w*\s*(?:на\s*)?(?:заявк|лид)?': "медленная обработка заявок",
            r'лид\w*\s*(?:остыва|протуха|умира)': "лиды остывают",
            r'(?:горяч|тёпл|тепл)\w*\s*(?:лид|клиент)\w*\s*(?:остыва|теря)': "теряем горячих клиентов",
            r'не\s*(?:дозванива|дозвон)': "не дозваниваемся",
            # Дополнительные паттерны
            r'(?:заявк|лид|обращен)\w*\s*вис': "заявки зависают",
            r'(?:заявк|лид)\w*\s*(?:без\s*)?(?:ответ|реакц)': "заявки без ответа",
            r'(?:заявк|лид)\w*\s*(?:копят|накаплива|скаплива)': "копятся заявки",
            r'(?:очередь|куч)\w*\s*(?:заявк|лид|обращен)': "очередь заявок",
            r'(?:входящ|поток)\w*\s*(?:не\s*)?(?:справля|обрабат)': "не справляемся с входящими",
            r'(?:упуст|проморга|прозева)\w*\s*(?:сделк|лид|заявк|клиент)': "упускаем возможности",
            r'(?:сделк|возможност)\w*\s*(?:упуст|проморга|прозева)': "упускаем возможности",
            r'(?:воронк|пайплайн)\w*\s*(?:пуст|нет|дыряв)': "пустая воронка",
            r'(?:мало|нет)\s*(?:входящ|заявок|лидов|обращен)': "мало входящих",

            # =================================================================
            # ПРОБЛЕМЫ С МЕНЕДЖЕРАМИ
            # =================================================================
            r'забыва[ею]т?\s*(?:перезвон|позвон|задач|клиент)?': "забывают задачи",
            r'менеджер\w*\s*(?:не\s*)?(?:перезван|звон)': "менеджеры не перезванивают",
            r'менеджер\w*\s*(?:косяч|лажа|ошиба)': "ошибки менеджеров",
            r'менеджер\w*\s*(?:забыва|пропуска|теря)': "менеджеры забывают",
            r'менеджер\w*\s*(?:не\s*работа|халтур|ленят)': "менеджеры не работают",
            r'менеджер\w*\s*(?:увол|уш[её]л|ушли)': "уход менеджеров",
            r'(?:новый|нов\w*)\s*менеджер\w*\s*(?:долго|не\s*мо)': "адаптация менеджеров",
            r'пропуска[ею]т?\s*(?:задач|звонк|встреч)?': "пропускают задачи",
            r'не\s*перезванива': "не перезванивают",
            r'сотрудник\w*\s*(?:не\s*)?(?:работа|выполня)': "проблемы с сотрудниками",
            r'(?:саботаж|саботир)': "саботаж сотрудников",
            r'(?:текучк|текучест)\w*\s*кадр': "текучка кадров",
            # Дополнительные паттерны
            r'менеджер\w*\s*(?:сливают|слив|гоняют)': "менеджеры сливают",
            r'менеджер\w*\s*(?:не\s*)?(?:фиксир|запис|вносят)': "менеджеры не фиксируют",
            r'менеджер\w*\s*(?:воруют|крадут|уводят)\w*\s*(?:клиент|базу)?': "менеджеры уводят клиентов",
            r'(?:воруют|крадут|уводят)\w*\s*(?:клиент|базу)': "уводят базу клиентов",
            r'менеджер\w*\s*(?:левач|подраб|калым)': "левые подработки",
            r'(?:отмаз|оправд|отговор)': "отмазываются",
            r'менеджер\w*\s*(?:врут|обманыва|лукав)': "менеджеры обманывают",
            r'(?:не\s*)?(?:доверя|верю)\w*\s*менеджер': "не доверяем менеджерам",
            r'менеджер\w*\s*(?:работают\s*)?(?:в\s*)?(?:своих|свои)\s*(?:интерес|карман)': "работают на себя",
            r'(?:продаж|сейлз)\w*\s*(?:не\s*)?(?:продают|закрыва)': "менеджеры не продают",
            r'(?:плох|слаб)\w*\s*(?:продаж|сейлз)\w*\s*навык': "слабые навыки продаж",
            r'(?:не\s*)?(?:умеют|могут)\s*продава': "не умеют продавать",
            r'продавц\w*\s*(?:слаб|плох|не\s*(?:умеют|могут))': "слабые продавцы",
            r'(?:обуч|тренир)\w*\s*(?:нет|не\s*было|не\s*провод)': "нет обучения",
            r'(?:новичк|стажёр|новен)\w*\s*(?:долго|не\s*мо|не\s*справля)': "проблемы с новичками",

            # =================================================================
            # НЕТ КОНТРОЛЯ И ПРОЗРАЧНОСТИ
            # =================================================================
            r'нет\s*контрол': "нет контроля",
            r'не\s*(?:могу|можем)\s*контролир': "нет контроля",
            r'не\s*вид[и|е][мт]\s*(?:что|как|чем)?': "нет видимости",
            r'контроль\s*(?:за|над)?\s*(?:менеджер|продаж|сотрудник)': "контроль продаж",
            r'(?:не\s*)?(?:понима|зна)[юем]\s*(?:что|как|сколько)': "нет понимания процессов",
            r'(?:чёрн|черн)\w*\s*ящик': "чёрный ящик",
            r'не\s*(?:отслежива|трек|мониторим)': "нет отслеживания",
            r'(?:непрозрачн|непонятн)\w*\s*(?:процесс|работ)?': "непрозрачные процессы",
            r'(?:кто|что)\s*(?:делает|работает|занят)': "неясно кто чем занят",
            r'не\s*(?:знаю|понимаю)\s*(?:чем|что|как)': "нет понимания",
            # Дополнительные паттерны
            r'(?:слеп|вслепую)\s*(?:работа|управля)': "работаем вслепую",
            r'руковод\w*\s*(?:не\s*)?(?:вид|знает|понима)': "руководство не видит",
            r'(?:собственник|директор|босс)\w*\s*(?:не\s*)?(?:вид|знает|понима)': "руководство не видит",
            r'(?:невозможн|не\s*мог)\w*\s*(?:провер|контролир|отслед)': "невозможно проверить",
            r'(?:верим|доверя)\w*\s*(?:на\s*слово|словам)': "верим на слово",
            r'(?:нет|отсутств)\w*\s*(?:учёт|учет)': "нет учёта",
            r'(?:нет|отсутств)\w*\s*(?:фиксац|протокол|логиров)': "ничего не фиксируется",

            # =================================================================
            # ХАОС В ДАННЫХ И ИНСТРУМЕНТАХ
            # =================================================================
            r'excel|эксел|табличк': "работа в Excel",
            r'гугл\s*(?:табли|докс)|google\s*(?:sheet|doc)': "работа в Google Docs",
            r'блокнот|записк|стикер': "записи в блокнотах",
            r'всё\s*в\s*голов': "всё в головах",
            r'нигде\s*не\s*(?:фикс|запис)': "ничего не фиксируется",
            r'разброс|раскидан': "данные разбросаны",
            r'хаос': "хаос в данных",
            r'беспоряд|бардак|бедлам': "беспорядок",
            r'(?:кажд|разн)\w*\s*(?:сво[йяеи]|по.своему|ведёт|ведет)': "каждый ведёт по-своему",
            r'по.своему\s*(?:вед|дела|работа)': "каждый ведёт по-своему",
            r'(?:вед[её]т|ведут)\w*\s*(?:\w+\s+)?по.своему': "каждый ведёт по-своему",
            r'нет\s*(?:единой|общей)\s*(?:базы|системы)': "нет единой базы",
            r'(?:разн|много)\w*\s*(?:систем|программ|инструмент)': "много разных систем",
            r'(?:информац|данн)\w*\s*(?:тер|пропа)': "данные теряются",
            r'(?:дубл|повтор)\w*\s*(?:данн|информ|ввод)': "дублирование данных",
            r'ручн\w*\s*(?:ввод|работ|труд)': "много ручной работы",
            # Дополнительные паттерны
            r'(?:бумаг|бумажк)\w*\s*(?:много|куч|завал)': "работа с бумагами",
            r'(?:вс[её]\s*)?(?:на\s*)?бумаг': "на бумаге",
            r'(?:в\s*)?(?:тетрад|блокнот)\w*\s*(?:пиш|вед|запис)': "записи в тетрадях",
            r'(?:word|ворд)\w*\s*(?:докум|файл)': "работа в Word",
            r'(?:куч|завал|мног)\w*\s*(?:файл|документ|папок)': "много файлов",
            r'(?:файл|документ)\w*\s*(?:где.то|потеря|не\s*найд)': "файлы теряются",
            r'(?:найти|искать)\s*(?:файл|документ|информац)\w*\s*(?:долго|сложно|невозможн)': "сложно найти файлы",
            r'(?:всё|все)\s*(?:раскидано|разбросано|в\s*разн)': "всё разбросано",
            r'(?:каш|месиво|свалк)\w*\s*(?:в\s*)?(?:данн|информац|файл)': "каша в данных",
            r'(?:зоопарк|винегрет)\w*\s*(?:систем|программ|инструмент)': "зоопарк систем",

            # =================================================================
            # ДУБЛИ И ОШИБКИ
            # =================================================================
            r'дубл[иеяь]': "дубли клиентов",
            r'путаниц': "путаница в данных",
            r'ошиб[ко]': "ошибки в работе",
            r'(?:один|одного)\s*клиент\w*\s*(?:несколько|много|двое)': "дубли клиентов",
            r'(?:повторн|дважды)\w*\s*(?:звон|пиш|обраща)': "повторные обращения",
            r'(?:перепут|смеша|спута)': "путаница",
            r'(?:неточн|некорректн|неправильн)\w*\s*данн': "некорректные данные",
            r'(?:устарел|старые|неактуальн)\w*\s*(?:данн|информ|контакт)': "устаревшие данные",
            # Дополнительные паттерны
            r'(?:одному|одного)\s*клиент\w*\s*(?:звоня|обраща)\w*\s*(?:несколько|много|двое)': "звоним одному клиенту несколько раз",
            r'(?:базе|данн)\w*\s*(?:грязн|мусор|шлак)': "грязная база",
            r'(?:чист|актуализ)\w*\s*(?:баз|данн)': "нужна чистка базы",
            r'(?:контакт|телефон|email)\w*\s*(?:неверн|некорректн|ошиб|устар)': "неверные контакты",
            r'(?:данн|информац)\w*\s*(?:противореч|не\s*совпад|расход)': "данные противоречат",
            r'(?:разн|противореч)\w*\s*(?:информац|данн)\w*\s*(?:об\s*одном|по\s*одному)': "разная информация",
            r'(?:накоп|скоп)\w*\s*(?:мусор|хлам|шлак)': "мусор в данных",

            # =================================================================
            # ОБЩАЯ НЕЭФФЕКТИВНОСТЬ
            # =================================================================
            r'долго\s*(?:иск|наход)': "долго ищут информацию",
            r'не\s*успева[ею]': "не успевают",
            r'много\s*времен': "много времени на рутину",
            r'неэффективн': "неэффективность",
            r'медленн': "медленная работа",
            r'рутин': "много рутины",
            r'(?:убива|трат|жр[её]т)\w*\s*врем': "тратят много времени",
            r'(?:отнима|занима)\w*\s*(?:много\s*)?врем': "занимает много времени",
            r'(?:низк|плох)\w*\s*(?:производительн|эффективн)': "низкая эффективность",
            r'(?:простаива|просто[йи])': "простои в работе",
            r'(?:затягива|задержива|опаздыва)': "задержки",
            # Дополнительные паттерны
            r'(?:копипаст|копировать)\w*\s*(?:данн|информац)?': "много копипаста",
            r'(?:переключа|прыга)\w*\s*между\s*(?:програм|систем|окн)': "переключение между системами",
            r'(?:перенос|дублир)\w*\s*(?:данн|информац)\w*\s*(?:вручную|руками)': "ручной перенос данных",
            r'(?:одно\s*и\s*то\s*же|одинаков)\w*\s*(?:вводи|заполня|делае)': "повторный ввод",
            r'(?:куч|мног)\w*\s*(?:кликов|действ|шагов)': "много действий",
            r'(?:сложн|непонятн)\w*\s*(?:интерфейс|систем|програм)': "сложный интерфейс",
            r'(?:неудобн|громоздк)\w*\s*(?:систем|програм|интерфейс)': "неудобная система",
            r'(?:тормоз|лагает|виснет|глюч)': "тормозит система",
            r'(?:падает|вылетает|крашит)': "падает система",
            r'(?:баги|глюки|ошибки)\w*\s*(?:в\s*)?(?:систем|програм)': "баги в системе",

            # =================================================================
            # ПРОДАЖИ
            # =================================================================
            r'плох\w*\s*продаж': "плохие продажи",
            r'слаб\w*\s*продаж': "слабые продажи",
            r'низк\w*\s*продаж': "низкие продажи",
            r'продаж[иа]?\s*(?:пада|упа|снижа|плох|низк)': "падение продаж",
            r'(?:пада|упа|снижа)\w*\s*продаж': "падение продаж",
            r'мало\s*(?:продаж|клиент|сделок)': "мало продаж",
            r'(?:увеличить|поднять|нарастить)\s*продаж': "рост продаж",
            r'проблем\w*\s*(?:с\s*)?продаж': "проблемы с продажами",
            r'(?:низк|плох|мал)\w*\s*конверси': "низкая конверсия",
            r'(?:мал|низк)\w*\s*(?:средн|чек|сумм)': "низкий средний чек",
            r'(?:длинн|долг)\w*\s*(?:цикл|сделк)': "длинный цикл сделки",
            r'не\s*(?:выполня|закрыва)\w*\s*план': "не выполняют план",
            r'план\w*\s*(?:не\s*)?(?:выполня|горит|срыва)': "срыв плана продаж",
            r'(?:выручк|доход|оборот)\w*\s*(?:пада|сниж|мал)': "падение выручки",
            r'(?:маржа|маржинальн|прибыл)\w*\s*(?:пада|сниж|мал|низк)': "низкая маржа",
            # Дополнительные паттерны
            r'(?:стагнац|застой)\w*\s*(?:в\s*)?(?:продаж|бизнес)': "стагнация продаж",
            r'продаж\w*\s*(?:встал|стоят|не\s*идут)': "продажи встали",
            r'(?:сезон|спад)\w*\s*(?:продаж)?': "сезонный спад",
            r'(?:кризис|провал)\w*\s*(?:в\s*)?продаж': "кризис продаж",
            r'(?:допродаж|апселл|кросс.сел)\w*\s*(?:нет|мало|не\s*(?:делаем|работа))': "нет допродаж",
            r'(?:не\s*)?(?:предлага|продаём|продаем)\w*\s*(?:доп|сопутств)': "не предлагают допы",
            r'(?:средн|среднемес)\w*\s*(?:чек|сумм)\w*\s*(?:не\s*)?рас': "средний чек не растёт",
            r'(?:количеств|числ)\w*\s*(?:сделок|продаж)\w*\s*(?:пада|сниж|мал)': "мало сделок",
            r'(?:редк|мал)\w*\s*(?:покупа|заказыва)': "редко покупают",
            r'(?:клиент|покупател)\w*\s*(?:экономят|не\s*готов|отказыва)': "клиенты экономят",
            r'(?:ценов|цен)\w*\s*(?:давлен|конкурен)': "ценовое давление",

            # =================================================================
            # АНАЛИТИКА И ОТЧЁТЫ
            # =================================================================
            r'нет\s*(?:статистик|аналитик|отчёт|отчет)': "нет аналитики",
            r'(?:хочу|нужн|надо)\s*(?:вид|знать)\w*\s*(?:статистик|цифр|показател)': "нужна аналитика",
            r'(?:не\s*)?(?:понима|зна)[юем]\s*(?:цифр|показател|статистик)': "непонятна статистика",
            r'(?:собира|формиру|делаю)\w*\s*отчёт\w*\s*(?:вручную|руками)': "ручные отчёты",
            r'отчёт\w*\s*(?:долго|сложно|трудно)': "сложные отчёты",
            r'(?:kpi|кпи|метрик)\w*\s*(?:нет|не\s*(?:счита|отслежива))': "нет KPI",
            r'воронк\w*\s*(?:не\s*)?(?:вид|отслежива|понима)': "не видим воронку",
            r'(?:прогноз|планирован)\w*\s*(?:нет|сложн|невозможн)': "нет прогнозирования",
            # Дополнительные паттерны
            r'(?:дашборд|dashboard)\w*\s*(?:нет|нужен|хотим)': "нужен дашборд",
            r'(?:графики|диаграм|визуализац)\w*\s*(?:нет|нужн|хотим)': "нужна визуализация",
            r'(?:цифр|данн|показател)\w*\s*(?:собира|сводим)\w*\s*(?:вручную|руками|из\s*разн)': "собираем данные вручную",
            r'(?:сверк|сводк|свед[её]|сводим)\w*\s*(?:данн|цифр)': "сводим данные",
            r'(?:отчёт|отчет|данн)\w*\s*(?:в\s*)?(?:excel|эксел|табли)': "отчёты в Excel",
            r'(?:считаем|считаю|подсч[её]т)\w*\s*(?:вручную|руками|на\s*калькулятор)': "считаем вручную",
            r'(?:данн|показател|цифр)\w*\s*(?:устарел|неактуальн|вчерашн)': "устаревшие данные",
            r'(?:realtime|реалтайм|оперативн)\w*\s*(?:данн|показател)\w*\s*(?:нет|нужн)': "нужны оперативные данные",
            r'(?:принима|оцени|проанализ)\w*\s*(?:решен)\w*\s*(?:сложн|не\s*(?:на\s*чем|можем))': "сложно принимать решения",
            r'(?:бизнес|управленч)\w*\s*(?:решен)\w*\s*(?:на\s*)?(?:интуиц|авось|глазок)': "решения на интуиции",

            # =================================================================
            # КОММУНИКАЦИЯ И КОМАНДА
            # =================================================================
            r'(?:плох|нет)\w*\s*коммуникац': "плохая коммуникация",
            r'(?:не\s*)?(?:знаю|понима)[юем]\s*(?:что|как)\s*(?:делает|работает)\s*(?:коллег|команд)': "нет коммуникации в команде",
            r'(?:передач|переда[ёе])\w*\s*(?:клиент|дел|информац)': "проблемы с передачей дел",
            r'(?:команд|отдел)\w*\s*(?:не\s*)?(?:работа|координир)': "проблемы координации",
            r'(?:между\s*)?отдел\w*\s*(?:не\s*)?(?:взаимодейств|общ|коммуник)': "нет связи между отделами",
            r'(?:конфликт|спор|выясн)\w*\s*(?:менеджер|сотрудник)?': "конфликты в команде",
            # Дополнительные паттерны
            r'(?:информац|данн)\w*\s*(?:не\s*)?(?:дох|доход|переда)\w*\s*(?:до|между)': "информация не доходит",
            r'(?:кто|один)\w*\s*(?:не\s*)?(?:зна|в\s*курс)\w*\s*(?:что|как)\w*\s*(?:друг)': "не знаем что делает коллега",
            r'(?:дублир|пересек)\w*\s*(?:работ|задач|функц)': "дублирование работы",
            r'(?:делаем|делают)\s*одн[оу]\s*(?:и\s*то\s*же|работу)': "делаем одно и то же",
            r'(?:маркетинг|продаж)\w*\s*(?:не\s*)?(?:работают\s*)?(?:вместе|сообща)': "маркетинг и продажи не работают вместе",
            r'(?:передал|передач)\w*\s*(?:клиент|лид)\w*\s*(?:потерял|забыл|провал)': "теряем при передаче",
            r'(?:замен|подмен|отпуск|больничн)\w*\s*(?:никто\s*не|не\s*кому)': "некому заменить",
            r'(?:ключев|един)\w*\s*(?:сотрудник|специалист|человек)\w*\s*(?:увол|уш[её]л|уйд)': "уход ключевого сотрудника",
            r'(?:всё|все)\s*(?:завис|держит)\w*\s*(?:на\s*одном|один\s*человек)': "всё на одном человеке",

            # =================================================================
            # ЗВОНКИ И ТЕЛЕФОНИЯ
            # =================================================================
            r'звонк\w*\s*(?:тер|пропуск|пропада)': "теряем звонки",
            r'(?:пропущ|пропуска)\w*\s*звонк': "пропущенные звонки",
            r'(?:не\s*)?(?:записыва|сохраня)\w*\s*звонк': "не записываем звонки",
            r'(?:нет|не\s*вед[её])\w*\s*истор\w*\s*(?:звонк|общен|переговор)': "нет истории звонков",
            r'(?:не\s*)?(?:слуша|анализ)\w*\s*звонк': "не анализируем звонки",
            r'(?:скрипт|сценар)\w*\s*(?:нет|не\s*(?:работ|соблюд))': "нет скриптов продаж",
            # Дополнительные паттерны
            r'(?:ручн|вручную)\w*\s*(?:набор|набира|звон)': "ручной набор номеров",
            r'(?:авто|автомат)\w*\s*(?:дозвон|набор|обзвон)\w*\s*(?:нет|нужен)': "нужен автодозвон",
            r'(?:долго|много\s*времен)\w*\s*(?:на\s*)?(?:набор|дозвон)': "много времени на набор",
            r'(?:callback|обратн\w*\s*звон)\w*\s*(?:нет|долго|не\s*работа)': "проблемы с callback",
            r'(?:ivr|голосов\w*\s*меню)\w*\s*(?:нет|нужен|хотим)': "нужен IVR",
            r'(?:очередь|распредел)\w*\s*звонк\w*\s*(?:нет|плохо|не\s*работа)': "нет очереди звонков",
            r'(?:входящ|исходящ)\w*\s*звонк\w*\s*(?:не\s*)?(?:вид|контрол|отслежива)': "не видим статистику звонков",
            r'(?:качеств|оценк)\w*\s*(?:звонк|разговор)\w*\s*(?:не\s*)?(?:контрол|оценива)': "не оцениваем качество звонков",

            # =================================================================
            # АВТОМАТИЗАЦИЯ И ПРОЦЕССЫ
            # =================================================================
            r'автоматизир': "автоматизация",
            r'систематизир': "систематизация",
            r'(?:навести|нужен)\s*порядок': "навести порядок",
            r'(?:оптимиз|улучш)\w*\s*процесс': "оптимизация процессов",
            r'(?:выстро|постро|настро)\w*\s*(?:процесс|систем|работ)': "выстроить процессы",
            r'(?:нет|отсутств)\w*\s*(?:процесс|регламент|стандарт)': "нет процессов",
            r'(?:всё|все)\s*(?:вручную|руками|делаем\s*вручную)': "всё делается вручную",
            r'(?:делаем|делают|работаем)\s*(?:всё\s*)?вручную': "всё делается вручную",
            r'(?:автоматич|автомат)\w*\s*(?:напоминан|задач|уведомлен)': "нужна автоматизация",
            r'(?:нужн|хотим|надо)\s*(?:crm|црм|систем)': "нужна CRM",
            r'(?:внедр|запуст)\w*\s*(?:crm|црм|систем)': "внедрение CRM",
            # Дополнительные паттерны
            r'(?:триггер|автомат)\w*\s*(?:действ|задач|напоминан)\w*\s*(?:нет|нужн)': "нужны триггеры",
            r'(?:авто|автомат)\w*\s*(?:рассылк|письм|уведомлен)\w*\s*(?:нет|нужн)': "нужны авторассылки",
            r'(?:напомина|уведомлен)\w*\s*(?:нет|забыва|не\s*приход)': "нет напоминаний",
            r'(?:шаблон|темплейт)\w*\s*(?:нет|мало|устарел)': "нет шаблонов",
            r'(?:кажд|постоянн)\w*\s*раз\w*\s*(?:с\s*нуля|заново|писать|создава)': "каждый раз с нуля",
            r'(?:типов|стандартн|однотипн)\w*\s*(?:задач|действ|операц)\w*\s*(?:много|куча|вручную)': "много типовых задач",
            r'(?:бизнес|рабоч)\w*\s*(?:процесс)\w*\s*(?:не\s*)?(?:описан|формализ|стандартиз)': "процессы не описаны",

            # =================================================================
            # МАСШТАБИРОВАНИЕ И РОСТ
            # =================================================================
            r'(?:не\s*)?(?:мож|получа)\w*\s*(?:масштаб|расти|вырасти)': "проблемы масштабирования",
            r'(?:рост|развити)\w*\s*(?:ограничен|невозможен|сложн)': "ограничения роста",
            r'(?:упир|упёрл|упер)\w*\s*(?:в\s*)?(?:потолок|стену|границ)': "упёрлись в потолок",
            r'(?:бизнес|компани)\w*\s*(?:не\s*)?(?:раст|развива)': "бизнес не растёт",
            r'(?:больше|много)\s*(?:клиент|заказ)\w*\s*(?:не\s*)?(?:справля|обрабат)': "не справляемся с потоком",
            # Дополнительные паттерны
            r'(?:расшир|нанима|набира)\w*\s*(?:команд|штат|персонал)\w*\s*(?:сложн|не\s*мож)': "сложно расширяться",
            r'(?:новый|нов)\w*\s*(?:клиент|направлен|продукт)\w*\s*(?:не\s*мож|сложн)': "сложно добавить новое",
            r'(?:систем|процесс)\w*\s*(?:не\s*)?(?:готов|рассчитан)\w*\s*(?:на\s*)?рост': "система не готова к росту",
            r'(?:узк|бутылочн)\w*\s*(?:место|горл|горлышк)': "бутылочное горлышко",
            r'(?:предел|лимит|ограничен)\w*\s*(?:возможност|мощност|ёмкост)': "предел возможностей",
            r'(?:людей|рук|человек)\w*\s*(?:не\s*хватает|мало)': "не хватает людей",
            r'(?:перегруж|загруж|заваленн)\w*\s*(?:команд|сотрудник|менеджер)': "перегруженная команда",

            # =================================================================
            # ЖЕЛАНИЯ И ПОТРЕБНОСТИ (косвенные)
            # =================================================================
            r'(?:хочу|хотим|нужн|надо)\s*(?:видеть|знать)\s*(?:статистик|аналитик|цифр)': "нужна аналитика",
            r'(?:хочу|хотим|нужн|надо)\s*(?:контролир|отслежива|мониторить)': "нужен контроль",
            r'(?:хочу|хотим|нужн|надо)\s*(?:понима|знать)\s*(?:что|как|где)': "нужна прозрачность",
            r'(?:хочу|хотим|нужн|надо)\s*(?:автоматиз|упростить|ускорить)': "нужна автоматизация",
            r'(?:хочу|хотим|нужн|надо)\s*(?:порядок|систем|структур)': "нужна систематизация",
            r'(?:хочу|хотим|нужн\w*|надо)\s+(?:един|общ)\w*\s+(?:баз|систем|место)': "нужна единая система",
            r'нужн\w*\s+(?:един|общ)\w*\s+баз': "нужна единая база",
            r'(?:един|общ)\w*\s+(?:баз|систем)\w*\s+(?:нет|нужн)': "нужна единая система",
            r'(?:устал|надоел)\w*\s*(?:от\s*)?(?:бардак|хаос|беспоряд|рутин)': "устали от хаоса",
            r'(?:хочу|хотим)\s*(?:как\s*у\s*)?(?:нормальн|взросл|больш)': "хотим нормальные процессы",
            # Дополнительные паттерны
            r'(?:хочу|хотим|нужн|надо)\s*(?:сэконом|сберечь|оптимизир)\w*\s*(?:врем|ресурс)': "хотим экономить время",
            r'(?:хочу|хотим|нужн|надо)\s*(?:больше|увеличить|поднять)\s*(?:продаж|выручк|прибыл)': "хотим больше продаж",
            r'(?:хочу|хотим|нужн|надо)\s*(?:понятн|прозрачн)\w*\s*(?:процесс|систем|картин)': "хотим прозрачность",
            r'(?:хочу|хотим|нужн|надо)\s*(?:быстр|оперативн)\w*\s*(?:реагир|обрабат|отвеча)': "хотим быстрее работать",
            r'(?:хочу|хотим|нужн|надо)\s*(?:избав|уйти)\w*\s*(?:от\s*)?(?:рутин|ручн|excel)': "хотим избавиться от рутины",
            r'(?:хочу|хотим|нужн|надо)\s*(?:собрать|объединить|консолидир)\w*\s*(?:всё|все|данн|информац)': "хотим собрать всё в одном месте",

            # =================================================================
            # АБСТРАКТНЫЕ ЖАЛОБЫ
            # =================================================================
            r'всё\s*плохо': "всё плохо",
            r'ничего\s*не\s*работ': "ничего не работает",
            r'не\s*работает\s*(?:нормальн|как\s*надо)': "не работает нормально",
            r'полный\s*(?:бардак|хаос|трэш|треш|пипец|капец)': "полный бардак",
            r'(?:сплошн|одни)\s*(?:проблем|головн\w*\s*бол)': "сплошные проблемы",
            r'(?:замуч|задолб|достал)': "замучились",
            r'(?:невозможн|нереальн|нельзя)\s*(?:работ|так\s*дальше)': "невозможно работать",
            r'(?:тонем|зашива|захлёб)': "захлёбываемся",
            r'(?:горим|пожар|срочн|аврал)': "постоянные авралы",
            # Дополнительные паттерны
            r'(?:ад|кошмар|ужас)': "кошмар",
            r'(?:надоело|достало|заколебало)': "надоело",
            r'(?:бесит|раздражает|выводит\s*из\s*себя)': "бесит",
            r'(?:нервы|стресс|выгорание)\w*\s*(?:на\s*)?пред': "стресс",
            r'(?:сплошн|постоянн|вечн)\w*\s*(?:стресс|напряг|нервы)': "постоянный стресс",
            r'(?:устал|вымотал|измотал)\w*\s*(?:все|весь\s*отдел|команд)': "все устали",
            r'(?:так|это)\s*больше\s*(?:не\s*мож|продолжа)\w*\s*(?:нельзя|не\s*будет)': "так дальше нельзя",
            r'(?:нужн|пора|давно\s*пора)\s*что.то\s*(?:менять|делать|решать)': "пора что-то менять",

            # =================================================================
            # СПЕЦИФИЧНЫЕ ОТРАСЛЕВЫЕ БОЛИ
            # =================================================================
            r'(?:сервис|поддержк|support)\w*\s*(?:плох|медленн|не\s*отвеча)': "плохой сервис",
            r'(?:клиент\w*\s*)?(?:ждут|ожида)\w*\s*(?:долго|часами)': "клиенты долго ждут",
            r'(?:время|срок)\w*\s*(?:ответ|реакц|обработк)\w*\s*(?:большое|долг|медленн)': "долгое время ответа",
            r'(?:sla|слa|времен\w*\s*норматив)\w*\s*(?:не\s*)?(?:выполня|соблюда|нарушае)': "нарушаем SLA",
            r'(?:тикет|заявк|обращен)\w*\s*(?:копят|накаплива|не\s*закрыва)': "копятся тикеты",
            r'(?:повторн|одинаков)\w*\s*(?:вопрос|проблем|обращен)': "повторные обращения",
            r'(?:faq|база\s*знаний|документац)\w*\s*(?:нет|устарел|не\s*полн)': "нет базы знаний",
        }

        for pattern, pain in pain_patterns.items():
            if re.search(pattern, message_lower):
                extracted["pain_point"] = pain
                break

        # Контекстное: если спрашивали о проблемах, а клиент ответил коротко
        if "pain_point" not in extracted and "pain_point" in missing_data:
            # Короткие ответы о сфере деятельности = проблема в этой сфере
            short_answers = {
                # =================================================================
                # СФЕРЫ ДЕЯТЕЛЬНОСТИ
                # =================================================================
                # Продажи
                "продажи": "улучшение продаж",
                "продажами": "улучшение продаж",
                "сейлз": "улучшение продаж",
                "sales": "улучшение продаж",
                "продажниками": "контроль продавцов",
                "продавцами": "контроль продавцов",
                "выручка": "рост выручки",
                "выручкой": "рост выручки",
                "прибыль": "рост прибыли",
                "прибылью": "рост прибыли",
                "доход": "рост дохода",
                "доходом": "рост дохода",

                # Маркетинг
                "маркетинг": "маркетинг и лиды",
                "маркетингом": "маркетинг и лиды",
                "реклама": "работа с рекламой",
                "рекламой": "работа с рекламой",
                "трафик": "управление трафиком",
                "трафиком": "управление трафиком",
                "лидогенерация": "генерация лидов",
                "лидген": "генерация лидов",
                "контент": "контент-маркетинг",
                "контентом": "контент-маркетинг",
                "smm": "SMM продвижение",
                "соцсети": "работа с соцсетями",
                "соцсетями": "работа с соцсетями",
                "рассылки": "email-маркетинг",
                "рассылками": "email-маркетинг",

                # Клиенты
                "клиенты": "работа с клиентами",
                "клиентами": "работа с клиентами",
                "заказчики": "работа с заказчиками",
                "заказчиками": "работа с заказчиками",
                "покупатели": "работа с покупателями",
                "покупателями": "работа с покупателями",
                "клиентская база": "ведение базы клиентов",
                "клиентской базой": "ведение базы клиентов",
                "отток": "удержание клиентов",
                "оттоком": "удержание клиентов",
                "удержание": "удержание клиентов",
                "удержанием": "удержание клиентов",
                "лояльность": "повышение лояльности",
                "лояльностью": "повышение лояльности",

                # HR и персонал
                "hr": "управление персоналом",
                "кадры": "работа с кадрами",
                "кадрами": "работа с кадрами",
                "персонал": "управление персоналом",
                "персоналом": "управление персоналом",
                "сотрудники": "управление сотрудниками",
                "сотрудниками": "управление сотрудниками",
                "менеджеры": "контроль менеджеров",
                "менеджерами": "контроль менеджеров",
                "команда": "управление командой",
                "командой": "управление командой",
                "найм": "подбор персонала",
                "наймом": "подбор персонала",
                "онбординг": "адаптация сотрудников",
                "онбордингом": "адаптация сотрудников",
                "адаптация": "адаптация сотрудников",
                "адаптацией": "адаптация сотрудников",
                "обучение": "обучение сотрудников",
                "обучением": "обучение сотрудников",
                "мотивация": "мотивация сотрудников",
                "мотивацией": "мотивация сотрудников",

                # Логистика и склад
                "логистика": "управление логистикой",
                "логистикой": "управление логистикой",
                "доставка": "управление доставкой",
                "доставкой": "управление доставкой",
                "склад": "учёт склада",
                "складом": "учёт склада",
                "остатки": "учёт остатков",
                "остатками": "учёт остатков",
                "запасы": "управление запасами",
                "запасами": "управление запасами",
                "отгрузки": "контроль отгрузок",
                "отгрузками": "контроль отгрузок",
                "поставки": "контроль поставок",
                "поставками": "контроль поставок",

                # Финансы
                "финансы": "финансовый учёт",
                "финансами": "финансовый учёт",
                "деньги": "учёт финансов",
                "деньгами": "учёт финансов",
                "оплаты": "контроль оплат",
                "оплатами": "контроль оплат",
                "дебиторка": "контроль дебиторки",
                "дебиторкой": "контроль дебиторки",
                "долги": "контроль задолженностей",
                "долгами": "контроль задолженностей",
                "платежи": "контроль платежей",
                "платежами": "контроль платежей",
                "бюджет": "контроль бюджета",
                "бюджетом": "контроль бюджета",
                "расходы": "контроль расходов",
                "расходами": "контроль расходов",
                "касса": "учёт кассы",
                "кассой": "учёт кассы",

                # Сервис и поддержка
                "поддержка": "клиентская поддержка",
                "поддержкой": "клиентская поддержка",
                "сервис": "клиентский сервис",
                "сервисом": "клиентский сервис",
                "саппорт": "клиентская поддержка",
                "саппортом": "клиентская поддержка",
                "тикеты": "обработка тикетов",
                "тикетами": "обработка тикетов",
                "жалобы": "работа с жалобами",
                "жалобами": "работа с жалобами",
                "рекламации": "работа с рекламациями",
                "рекламациями": "работа с рекламациями",

                # =================================================================
                # ДЕЙСТВИЯ И ПРОЦЕССЫ
                # =================================================================
                # Коммуникации
                "звонки": "учёт звонков",
                "звонками": "учёт звонков",
                "переговоры": "ведение переговоров",
                "переговорами": "ведение переговоров",
                "общение": "коммуникация с клиентами",
                "общением": "коммуникация с клиентами",
                "переписка": "ведение переписки",
                "перепиской": "ведение переписки",
                "телефония": "телефония и звонки",
                "телефонией": "телефония и звонки",
                "чаты": "работа с чатами",
                "чатами": "работа с чатами",
                "мессенджеры": "работа с мессенджерами",
                "мессенджерами": "работа с мессенджерами",
                "email": "email-коммуникация",
                "почта": "email-коммуникация",
                "почтой": "email-коммуникация",

                # Заявки и лиды
                "заявки": "обработка заявок",
                "заявками": "обработка заявок",
                "лиды": "обработка лидов",
                "лидами": "обработка лидов",
                "обращения": "обработка обращений",
                "обращениями": "обработка обращений",
                "запросы": "обработка запросов",
                "запросами": "обработка запросов",
                "входящие": "обработка входящих",
                "входящими": "обработка входящих",
                "холодные": "работа с холодными",
                "холодными": "работа с холодными",
                "тёплые": "работа с тёплыми",
                "теплыми": "работа с тёплыми",

                # Сделки
                "сделки": "ведение сделок",
                "сделками": "ведение сделок",
                "заказы": "обработка заказов",
                "заказами": "обработка заказов",
                "договоры": "ведение договоров",
                "договорами": "ведение договоров",
                "контракты": "ведение контрактов",
                "контрактами": "ведение контрактов",
                "счета": "выставление счетов",
                "счетами": "выставление счетов",
                "документы": "документооборот",
                "документами": "документооборот",
                "акты": "работа с актами",
                "актами": "работа с актами",

                # Задачи
                "задачи": "управление задачами",
                "задачами": "управление задачами",
                "дела": "управление делами",
                "делами": "управление делами",
                "напоминания": "система напоминаний",
                "напоминаниями": "система напоминаний",
                "планирование": "планирование задач",
                "планированием": "планирование задач",
                "дедлайны": "контроль дедлайнов",
                "дедлайнами": "контроль дедлайнов",
                "расписание": "управление расписанием",
                "расписанием": "управление расписанием",
                "календарь": "ведение календаря",
                "календарём": "ведение календаря",
                "календарем": "ведение календаря",

                # =================================================================
                # УЧЁТ И ОТЧЁТНОСТЬ
                # =================================================================
                "учёт": "учёт клиентов",
                "учет": "учёт клиентов",
                "учётом": "учёт клиентов",
                "учетом": "учёт клиентов",
                "контроль": "контроль менеджеров",
                "контролем": "контроль менеджеров",
                "отчёты": "отчётность",
                "отчеты": "отчётность",
                "отчётами": "отчётность",
                "отчетами": "отчётность",
                "отчётность": "отчётность",
                "отчетность": "отчётность",
                "аналитика": "аналитика продаж",
                "аналитикой": "аналитика продаж",
                "статистика": "статистика продаж",
                "статистикой": "статистика продаж",
                "метрики": "отслеживание метрик",
                "метриками": "отслеживание метрик",
                "kpi": "контроль KPI",
                "кпи": "контроль KPI",
                "дашборд": "визуализация данных",
                "дашбордом": "визуализация данных",
                "dashboard": "визуализация данных",
                "графики": "визуализация данных",
                "графиками": "визуализация данных",
                "цифры": "работа с данными",
                "цифрами": "работа с данными",
                "показатели": "контроль показателей",
                "показателями": "контроль показателей",

                # Воронка
                "воронка": "воронка продаж",
                "воронкой": "воронка продаж",
                "конверсия": "повышение конверсии",
                "конверсией": "повышение конверсии",
                "пайплайн": "управление пайплайном",
                "пайплайном": "управление пайплайном",
                "pipeline": "управление пайплайном",
                "стадии": "настройка стадий",
                "стадиями": "настройка стадий",
                "этапы": "настройка этапов",
                "этапами": "настройка этапов",

                # =================================================================
                # СОСТОЯНИЯ И ПРОБЛЕМЫ
                # =================================================================
                "бардак": "наведение порядка",
                "хаос": "устранение хаоса",
                "беспорядок": "наведение порядка",
                "путаница": "устранение путаницы",
                "неразбериха": "устранение неразберихи",
                "каша": "наведение порядка",
                "бедлам": "наведение порядка",
                "завал": "разбор завалов",
                "завалом": "разбор завалов",
                "трэш": "наведение порядка",
                "треш": "наведение порядка",
                "кошмар": "решение проблем",
                "кошмаром": "решение проблем",
                "ужас": "решение проблем",
                "ужасом": "решение проблем",
                "стресс": "снижение стресса",
                "стрессом": "снижение стресса",
                "выгорание": "предотвращение выгорания",
                "выгоранием": "предотвращение выгорания",

                # Потери
                "потери": "сокращение потерь",
                "потерями": "сокращение потерь",
                "упущения": "сокращение упущений",
                "упущениями": "сокращение упущений",
                "утечки": "устранение утечек",
                "утечками": "устранение утечек",
                "дубли": "устранение дублей",
                "дублями": "устранение дублей",
                "дублирование": "устранение дублирования",
                "дублированием": "устранение дублирования",
                "ошибки": "сокращение ошибок",
                "ошибками": "сокращение ошибок",
                "косяки": "устранение косяков",
                "косяками": "устранение косяков",
                "факапы": "устранение факапов",
                "факапами": "устранение факапов",

                # Эффективность
                "эффективность": "повышение эффективности",
                "эффективностью": "повышение эффективности",
                "производительность": "повышение производительности",
                "производительностью": "повышение производительности",
                "скорость": "увеличение скорости работы",
                "скоростью": "увеличение скорости работы",
                "оптимизация": "оптимизация процессов",
                "оптимизацией": "оптимизация процессов",
                "рутина": "сокращение рутины",
                "рутиной": "сокращение рутины",
                "время": "экономия времени",
                "временем": "экономия времени",
                "ресурсы": "экономия ресурсов",
                "ресурсами": "экономия ресурсов",

                # Автоматизация
                "автоматизация": "автоматизация процессов",
                "автоматизацией": "автоматизация процессов",
                "систематизация": "систематизация работы",
                "систематизацией": "систематизация работы",
                "стандартизация": "стандартизация процессов",
                "стандартизацией": "стандартизация процессов",
                "регламенты": "создание регламентов",
                "регламентами": "создание регламентов",
                "процессы": "выстраивание процессов",
                "процессами": "выстраивание процессов",
                "порядок": "наведение порядка",
                "порядком": "наведение порядка",

                # =================================================================
                # ИНСТРУМЕНТЫ И БАЗА
                # =================================================================
                "база": "ведение базы клиентов",
                "базой": "ведение базы клиентов",
                "crm": "внедрение CRM",
                "црм": "внедрение CRM",
                "система": "внедрение системы",
                "системой": "внедрение системы",
                "excel": "уход от Excel",
                "эксель": "уход от Excel",
                "экселем": "уход от Excel",
                "таблицы": "уход от таблиц",
                "таблицами": "уход от таблиц",
                "блокноты": "уход от блокнотов",
                "блокнотами": "уход от блокнотов",
                "бумажки": "уход от бумаг",
                "бумажками": "уход от бумаг",
                "интеграция": "настройка интеграций",
                "интеграцией": "настройка интеграций",
                "интеграции": "настройка интеграций",
                "интеграциями": "настройка интеграций",
                "1с": "интеграция с 1С",
                "телефония": "интеграция телефонии",
                "телефонией": "интеграция телефонии",

                # =================================================================
                # МАСШТАБИРОВАНИЕ
                # =================================================================
                "рост": "масштабирование бизнеса",
                "ростом": "масштабирование бизнеса",
                "масштаб": "масштабирование бизнеса",
                "масштабом": "масштабирование бизнеса",
                "масштабирование": "масштабирование бизнеса",
                "масштабированием": "масштабирование бизнеса",
                "расширение": "расширение бизнеса",
                "расширением": "расширение бизнеса",
                "развитие": "развитие бизнеса",
                "развитием": "развитие бизнеса",
            }
            if message_lower in short_answers:
                extracted["pain_point"] = short_answers[message_lower]

        # === Контактная информация ===
        # Email
        email_match = re.search(r'[\w\.-]+@[\w\.-]+\.\w{2,}', message)
        if email_match:
            extracted["contact_info"] = email_match.group(0)

        # Телефон (если email не найден)
        if "contact_info" not in extracted:
            phone_patterns = [
                # +7 с разными разделителями: +7 999 123-45-67, +7(999)123-45-67, +79991234567
                r'\+7[\s\-\.]?\(?\d{3}\)?[\s\-\.]?\d{3}[\s\-\.]?\d{2}[\s\-\.]?\d{2}',
                # 8 с разными разделителями: 8 999 123-45-67, 8(999)123-45-67
                r'8[\s\-\.]?\(?\d{3}\)?[\s\-\.]?\d{3}[\s\-\.]?\d{2}[\s\-\.]?\d{2}',
                # 10 цифр подряд (без кода страны): 9991234567
                r'\b\d{10}\b',
                # Формат XXX-XXX-XX-XX или XXX XXX XX XX
                r'\d{3}[\s\-\.]\d{3}[\s\-\.]\d{2}[\s\-\.]\d{2}',
            ]
            for pattern in phone_patterns:
                phone_match = re.search(pattern, message)
                if phone_match:
                    extracted["contact_info"] = phone_match.group(0).strip()
                    break

        # === Имя клиента ===
        name_patterns = [
            r'(?:меня\s*зовут|я\s+)\s*([А-ЯЁ][а-яё]+)',
            r'(?:это\s+)?([А-ЯЁ][а-яё]+)\s*(?:на связи|пишу|беспокоит)',
        ]
        for pattern in name_patterns:
            name_match = re.search(pattern, message)
            if name_match:
                extracted["client_name"] = name_match.group(1)
                break

        return extracted


class HybridClassifier:
    """
    Гибридный классификатор: быстрый + точный

    1. Нормализация текста (TextNormalizer)
    2. Пробуем быструю классификацию по корням
    3. Если confidence >= threshold → возвращаем
    4. Иначе → fallback на pymorphy2
    5. Выбираем лучший результат
    """

    def __init__(self):
        self.normalizer = TextNormalizer()
        self.root_classifier = RootClassifier()
        self.lemma_classifier = LemmaClassifier()
        self.data_extractor = DataExtractor()
        self.config = CLASSIFIER_CONFIG

    def classify(self, message: str, context: Dict = None) -> Dict:
        """
        Полная классификация сообщения

        Args:
            message: Сообщение пользователя
            context: Контекст диалога (missing_data, collected_data)

        Returns:
            {
                "intent": str,
                "confidence": float,
                "extracted_data": dict,
                "method": str  # "root" | "lemma" | "data"
            }
        """
        # 0. Нормализация текста (опечатки, слипшиеся слова, ё→е и т.д.)
        message = self.normalizer.normalize(message)

        # 1. Извлекаем данные (с учётом контекста)
        extracted = self.data_extractor.extract(message, context)

        # Если есть данные — это info_provided (высокий приоритет)
        if extracted.get("company_size") or extracted.get("pain_point"):
            return {
                "intent": "info_provided",
                "confidence": 0.95,
                "extracted_data": extracted,
                "method": "data"
            }

        # Если есть контакт — contact_provided
        if extracted.get("contact_info"):
            return {
                "intent": "contact_provided",
                "confidence": 0.95,
                "extracted_data": extracted,
                "method": "data"
            }

        # 2. Быстрая классификация по корням
        root_intent, root_conf, root_scores = self.root_classifier.classify(message)

        # Если уверенность высокая — возвращаем сразу
        if root_conf >= self.config["high_confidence_threshold"]:
            return {
                "intent": root_intent,
                "confidence": root_conf,
                "extracted_data": extracted,
                "method": "root",
                "debug_scores": root_scores
            }

        # 3. Fallback на лемматизацию
        lemma_intent, lemma_conf, lemma_scores = self.lemma_classifier.classify(message)

        # 4. Выбираем лучший результат
        if lemma_conf > root_conf:
            return {
                "intent": lemma_intent,
                "confidence": lemma_conf,
                "extracted_data": extracted,
                "method": "lemma",
                "debug_scores": lemma_scores
            }

        # Если оба метода дали низкую уверенность
        if root_conf < self.config["min_confidence"]:
            return {
                "intent": "unclear",
                "confidence": root_conf,
                "extracted_data": extracted,
                "method": "root",
                "debug_scores": root_scores
            }

        return {
            "intent": root_intent,
            "confidence": root_conf,
            "extracted_data": extracted,
            "method": "root",
            "debug_scores": root_scores
        }


# =============================================================================
# ТЕСТИРОВАНИЕ
# =============================================================================


def test_normalizer() -> bool:
    """Тест нормализатора текста"""
    n = TextNormalizer()

    tests = [
        # (input, expected_output)

        # Повторы букв
        ("приииивет", "привет"),
        ("скооолько стоооит", "сколько стоит"),
        ("даааа", "да"),
        ("неееет", "нет"),

        # Опечатки
        ("скока стоит", "сколько стоит"),
        ("ценик какой", "ценник какой"),
        ("прайслист скинь", "прайс скинь"),
        ("чё почём", "что почем"),

        # Слипшиеся слова
        ("сколькостоит", "сколько стоит"),
        ("какаяцена", "какая цена"),

        # Ё → Е
        ("подскажёте", "подскажете"),
        ("почём", "почем"),

        # Комбинированные
        ("приииив скока ценик", "привет сколько ценник"),
        ("здрааасте какаяцена", "здравствуйте какая цена"),

        # Приветствия с опечатками
        ("хаюшки", "привет"),
        ("здрасте", "здравствуйте"),
        ("дратути", "здравствуйте"),

        # Разговорные формы
        ("щас посмотрю", "сейчас посмотрю"),
        ("норм всё", "нормально все"),
        ("спс за инфу", "спасибо за инфу"),

        # Не должно ломать нормальный текст
        ("привет как дела", "привет как дела"),
        ("сколько стоит на 10 человек", "сколько стоит на 10 человек"),
        ("добрый день", "добрый день"),
    ]

    passed = 0
    for inp, expected in tests:
        result = n.normalize(inp)
        status = "✓" if result == expected else "✗"
        if result == expected:
            passed += 1
        else:
            print(f"{status} '{inp}' → '{result}' (ожидали: '{expected}')")

    print(f"\nНормализатор: {passed}/{len(tests)} тестов пройдено")
    return passed == len(tests)


def test_classifier() -> bool:
    """Тест классификатора (существующие тесты)"""
    classifier = HybridClassifier()

    test_cases = [
        # Приветствия
        ("Привет!", "greeting"),
        ("Здравствуйте, подскажите пожалуйста", "greeting"),
        ("Добрый день", "greeting"),

        # Вопросы о цене (разные формулировки)
        ("Сколько стоит?", "price_question"),
        ("Какая цена?", "price_question"),
        ("Подскажите по стоимости", "price_question"),
        ("Ценник какой?", "price_question"),
        ("А прайс есть?", "price_question"),
        ("Какие тарифы?", "price_question"),
        ("Во сколько обойдётся?", "price_question"),

        # Возражения
        ("Дорого", "objection_price"),
        ("Слишком дорого для нас", "objection_price"),
        ("Нет бюджета на это", "objection_price"),
        ("Нет времени сейчас", "objection_no_time"),
        ("Занят, перезвоните позже", "objection_no_time"),
        ("У нас уже есть CRM", "objection_competitor"),
        ("Используем Битрикс24", "objection_competitor"),

        # Согласие
        ("Да, интересно", "agreement"),
        ("Давайте попробуем", "agreement"),
        ("Расскажите подробнее", "agreement"),
        ("Хочу демо", "agreement"),

        # Отказ
        ("Не интересно", "rejection"),
        ("Нет, спасибо", "rejection"),
        ("Не нужно", "rejection"),

        # Данные
        ("У нас 15 человек в отделе", "info_provided"),
        ("Постоянно теряем клиентов", "info_provided"),
        ("Работаем в Excel, всё теряется", "info_provided"),
        ("Мой email: test@company.ru", "contact_provided"),
        ("+7 999 123-45-67", "contact_provided"),
    ]

    passed = 0
    failed = 0

    for message, expected in test_cases:
        result = classifier.classify(message)
        actual = result["intent"]
        conf = result["confidence"]
        method = result["method"]

        status = "✓" if actual == expected else "✗"
        if actual == expected:
            passed += 1
        else:
            failed += 1
            print(f"{status} '{message}'")
            print(f"   Ожидали: {expected}, Получили: {actual} ({conf:.2f}) [{method}]")
            if result.get("extracted_data"):
                print(f"   Данные: {result['extracted_data']}")

    print(f"\nКлассификатор: {passed}/{passed+failed} тестов пройдено")
    return passed == len(test_cases)


def test_full_pipeline() -> bool:
    """Тест полного пайплайна: нормализация → классификация → извлечение"""
    classifier = HybridClassifier()

    tests = [
        # (message, expected_intent, expected_data_key, expected_data_value)

        # Опечатки в вопросах о цене
        ("скока стоит", "price_question", None, None),
        ("ценик какой", "price_question", None, None),
        ("прайсик скиньте", "price_question", None, None),
        ("скока ваш прайс", "price_question", None, None),

        # Приветствия с ошибками
        ("приииивет", "greeting", None, None),
        ("здрааасте", "greeting", None, None),
        ("хаюшки", "greeting", None, None),
        ("дратути", "greeting", None, None),

        # Слипшиеся слова
        ("сколькостоит", "price_question", None, None),
        ("какаяцена", "price_question", None, None),

        # Данные с опечатками (размер команды)
        ("у нас 15 чел", "info_provided", "company_size", 15),
        ("команда 8 человеек", "info_provided", "company_size", 8),

        # Боли с опечатками
        ("менеджеры забыыывают звонить", "info_provided", "pain_point", "забывают задачи"),
        ("теряеем клиентов", "info_provided", "pain_point", "потеря клиентов"),

        # Возражения с опечатками
        ("дорга очень", "objection_price", None, None),
        ("дорага для нас", "objection_price", None, None),

        # Нормальные сообщения (не должны ломаться)
        ("сколько стоит на 10 человек", "info_provided", "company_size", 10),
        ("привет", "greeting", None, None),
        ("дорого", "objection_price", None, None),
        ("да, интересно", "agreement", None, None),
        ("какая цена", "price_question", None, None),
    ]

    passed = 0
    for msg, exp_intent, exp_key, exp_value in tests:
        result = classifier.classify(msg)

        intent_ok = result["intent"] == exp_intent
        data_ok = True
        if exp_key:
            data_ok = result.get("extracted_data", {}).get(exp_key) == exp_value

        if intent_ok and data_ok:
            passed += 1
        else:
            print(f"✗ '{msg}'")
            print(f"   Ожидали: intent={exp_intent}, {exp_key}={exp_value}")
            print(f"   Получили: intent={result['intent']}, data={result.get('extracted_data')}")

    print(f"\nПолный пайплайн: {passed}/{len(tests)} тестов пройдено")
    return passed == len(tests)


if __name__ == "__main__":
    print("=" * 60)
    print("ТЕСТИРОВАНИЕ КЛАССИФИКАТОРА")
    print("=" * 60)

    # 1. Тест нормализатора
    print("\n### ТЕСТ НОРМАЛИЗАТОРА ###\n")
    norm_ok = test_normalizer()

    # 2. Тест классификатора (существующие тесты)
    print("\n### ТЕСТ КЛАССИФИКАТОРА ###\n")
    class_ok = test_classifier()

    # 3. End-to-end тест
    print("\n### END-TO-END ТЕСТ ###\n")
    e2e_ok = test_full_pipeline()

    # Итог
    print("\n" + "=" * 60)
    all_passed = norm_ok and class_ok and e2e_ok
    if all_passed:
        print("✓ ВСЕ ТЕСТЫ ПРОЙДЕНЫ")
    else:
        print("✗ ЕСТЬ ОШИБКИ")
        if not norm_ok:
            print("  - Ошибки в нормализаторе")
        if not class_ok:
            print("  - Ошибки в классификаторе")
        if not e2e_ok:
            print("  - Ошибки в end-to-end тестах")
    print("=" * 60)
