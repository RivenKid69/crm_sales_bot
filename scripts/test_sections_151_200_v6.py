#!/usr/bin/env python3
"""
Шестой альтернативный тест покрытия секций 151-200.
Использует сценарные/ситуативные запросы.
"""

import sys
sys.path.insert(0, 'src')

from knowledge.retriever import KnowledgeRetriever
from knowledge.data import WIPON_KNOWLEDGE


def test_sections_v6():
    """Шестой альтернативный тест - сценарные запросы"""
    print("=" * 70)
    print("ТЕСТ V6: СЦЕНАРНЫЕ ЗАПРОСЫ (151-200)")
    print("=" * 70)
    print()

    retriever = KnowledgeRetriever(use_embeddings=False)

    # Сценарные запросы с контекстом
    test_cases = [
        # 151 - подставка
        (151, "хочу держатель чтобы сканер не валялся", ["3 000", "10 000"]),

        # 152 - комплекты
        (152, "мне нужно всё сразу одним заказом", ["168 000", "Standard"]),

        # 153 - ТСД
        (153, "на складе надо сканировать товар", ["25 000", "30 000"]),

        # 154 - свет
        (154, "у нас часто вырубает электричество", ["ИБП", "сети"]),

        # 155 - интернет
        (155, "у меня есть только вайфай роутер", ["Wi-Fi", "LAN"]),

        # 156 - симка
        (156, "хочу через телефонный интернет работать", ["роутер", "4G"]),

        # 157 - софт
        (157, "у меня уже есть своя учётная система", ["совместим", "ПО"]),

        # 158 - предустановка
        (158, "надо ещё софт докупать отдельно?", ["предустановлен", "готов"]),

        # 159 - весы отдельно
        (159, "мне нужны только весы и ничего больше", ["можно", "Wipon"]),

        # 160 - весы и этикетки
        (160, "весы сами наклейки делают?", ["не печата", "Rongta"]),

        # 161 - настройка
        (161, "сам не разберусь, кто поможет?", ["AnyDesk", "удалённо"]),

        # 162 - мастер
        (162, "вы можете прислать человека?", ["Выезд не требуется", "удалённо"]),

        # 163 - мышка
        (163, "хочу обычную мышку подключить", ["USB", "можно"]),

        # 164 - цвет
        (164, "у меня интерьер светлый, есть светлые?", ["бел", "чёрн"]),

        # 165 - характеристики
        (165, "какое железо внутри стоит?", ["i3", "i5", "RAM"]),

        # 166 - сканер specs
        (166, "у меня большой поток, сканер успеет?", ["скан/сек", "1D"]),

        # 167 - принтер specs
        (167, "очереди большие, принтер не будет тормозить?", ["мм/сек", "dpi"]),

        # 168 - бумага чеки
        (168, "какие рулоны брать в магазине?", ["58 мм", "80 мм"]),

        # 169 - бумага этикетки
        (169, "наклейки какого формата покупать?", ["80 мм", "85"]),

        # 170 - блютуз
        (170, "хочу без проводов принтер", ["Bluetooth", "USB"]),

        # 171 - гарантия
        (171, "если сломается через полгода?", ["1 год", "5 лет"]),

        # 172 - аренда
        (172, "можно попробовать потом вернуть?", ["Аренды нет", "рассрочк"]),

        # 173 - доставка
        (173, "я в другом городе живу", ["InDriver", "Казахстан"]),

        # 174 - возврат
        (174, "если не понравится могу отдать назад?", ["14", "дней"]),

        # 175 - разница моноблоков
        (175, "почему один дороже другого?", ["DUO", "Premium"]),

        # 176 - подбор
        (176, "не знаю что брать, помогите выбрать", ["Подбер", "формат"]),

        # 177 - 5 в 1
        (177, "что внутри этого моноблока?", ["сканер", "принтер", "экран"]),

        # 178 - весы работа
        (178, "вес сам появляется в программе?", ["кассу", "автоматически"]),

        # 179 - экран клиента
        (179, "клиент может сам что-то выбирать на экране?", ["Нет", "клиент"]),

        # 180 - что такое ТИС
        (180, "объясните простым языком про тис", ["ИП", "упрощёнк"]),

        # 181 - работа ТИС
        (181, "как всё это устроено технически?", ["учёт", "касс", "терминал"]),

        # 182 - отличие ТИС
        (182, "в чём смысл если касса и так есть?", ["государств", "лимит"]),

        # 183 - малый оборот
        (183, "у меня небольшой бизнес пока", ["рост", "оборот"]),

        # 184 - новый ИП
        (184, "только открылся, ещё ничего не продал", ["сразу", "лимит"]),

        # 185 - ТОО
        (185, "мы не ип а товарищество", ["Нет", "ИП"]),

        # 186 - законность
        (186, "налоговая не придерётся потом?", ["реестр", "официальн"]),

        # 187 - другие варианты
        (187, "ничего не подходит что делать?", ["специалист", "свяж"]),

        # 188 - НДС порог
        (188, "уже попал под ндс в этом году", ["НДС", "полугод"]),

        # 189 - общий режим
        (189, "почему все боятся общего режима?", ["налогов", "бухгалтер"]),

        # 190 - кому подходит
        (190, "мне вообще это нужно?", ["ИП", "упрощёнк"]),

        # 191 - большие обороты
        (191, "уже много зарабатываю, не поздно?", ["лимит", "НДС"]),

        # 192 - услуги
        (192, "я не товары продаю а услуги", ["Можно", "касс"]),

        # 193 - ОКЭД
        (193, "у меня специфичный бизнес подойдёт?", ["Любые", "ограничен"]),

        # 194 - ресторан
        (194, "у нас айко стоит будет работать?", ["IIKO", "поддержив"]),

        # 195 - Kaspi
        (195, "уже есть каспи что с ней делать?", ["снять", "задвоен"]),

        # 196 - для ТОО
        (196, "мы юрлицо что нам взять?", ["Розниц", "ЭСФ"]),

        # 197 - порог
        (197, "на сколько больше можно заработать?", ["НДС", "повышает"]),

        # 198 - заработок
        (198, "какой потолок по деньгам?", ["лимит", "порог"]),

        # 199 - налоги
        (199, "как это помогает платить меньше?", ["упрощёнк", "систем"]),

        # 200 - прибыль
        (200, "реально ли экономить на налогах?", ["налогов", "прибыль"]),
    ]

    passed = 0
    failed = 0
    failed_cases = []

    for num, query, expected_words in test_cases:
        facts = retriever.retrieve(query, top_k=3)
        facts_lower = facts.lower()

        found_count = sum(1 for word in expected_words if word.lower() in facts_lower)
        min_required = max(1, len(expected_words) // 2)
        found = found_count >= min_required

        if found:
            passed += 1
            status = "✓"
        else:
            failed += 1
            status = "✗"
            failed_cases.append((num, query, expected_words, facts[:200]))

        print(f"{status} [{num}] '{query[:45]}...' ({found_count}/{len(expected_words)})")

    print()
    print("=" * 70)
    print(f"РЕЗУЛЬТАТ: {passed}/{passed+failed} тестов пройдено")
    print(f"ПОКРЫТИЕ: {passed/(passed+failed)*100:.1f}%")
    print("=" * 70)

    if failed_cases:
        print()
        print("ПРОВАЛЕННЫЕ ТЕСТЫ:")
        print("-" * 70)
        for num, query, expected, facts in failed_cases:
            print(f"\n[{num}] {query}")
            print(f"  Ожидалось: {expected}")
            print(f"  Получено: {facts}...")

    return passed, failed


if __name__ == "__main__":
    passed, failed = test_sections_v6()
    sys.exit(0 if failed == 0 else 1)
