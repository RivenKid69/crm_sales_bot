#!/usr/bin/env python3
"""
Пятый альтернативный тест покрытия секций 151-200.
Использует вопросительные формулировки и смешанный стиль.
"""

import sys
sys.path.insert(0, 'src')

from knowledge.retriever import KnowledgeRetriever
from knowledge.data import WIPON_KNOWLEDGE


def test_sections_v5():
    """Пятый альтернативный тест - вопросительные формулировки"""
    print("=" * 70)
    print("ТЕСТ V5: ВОПРОСИТЕЛЬНЫЕ ФОРМУЛИРОВКИ (151-200)")
    print("=" * 70)
    print()

    retriever = KnowledgeRetriever(use_embeddings=False)

    # Вопросительные формулировки
    test_cases = [
        # 151 - подставка
        (151, "есть ли подставки для сканеров?", ["3 000", "10 000"]),

        # 152 - комплекты
        (152, "какие есть готовые наборы оборудования?", ["168 000", "Standard"]),

        # 153 - ТСД
        (153, "есть ли мобильные сканеры для склада?", ["25 000", "30 000"]),

        # 154 - свет
        (154, "что делать если отключат свет?", ["ИБП", "сети"]),

        # 155 - интернет
        (155, "как подключается к интернету?", ["Wi-Fi", "LAN"]),

        # 156 - симка
        (156, "можно вставить симку?", ["роутер", "4G"]),

        # 157 - софт
        (157, "работает ли с другими программами?", ["совместим", "ПО"]),

        # 158 - предустановка
        (158, "программа идёт в комплекте?", ["предустановлен", "готов"]),

        # 159 - весы отдельно
        (159, "можно взять одни весы?", ["можно", "Wipon"]),

        # 160 - весы и этикетки
        (160, "печатают ли весы ценники?", ["не печата", "Rongta"]),

        # 161 - настройка
        (161, "как происходит настройка?", ["AnyDesk", "удалённо"]),

        # 162 - мастер
        (162, "приедет ли специалист?", ["Выезд не требуется", "удалённо"]),

        # 163 - мышка
        (163, "есть ли разъёмы для мыши?", ["USB", "можно"]),

        # 164 - цвет
        (164, "можно выбрать цвет?", ["бел", "чёрн"]),

        # 165 - характеристики
        (165, "какая начинка у моноблоков?", ["i3", "i5", "RAM"]),

        # 166 - сканер specs
        (166, "насколько быстрые сканеры?", ["скан/сек", "1D"]),

        # 167 - принтер specs
        (167, "какая скорость печати чеков?", ["мм/сек", "dpi"]),

        # 168 - бумага чеки
        (168, "какая бумага для чеков нужна?", ["58 мм", "80 мм"]),

        # 169 - бумага этикетки
        (169, "какой размер этикеток?", ["80 мм", "85"]),

        # 170 - блютуз
        (170, "есть ли беспроводные принтеры?", ["Bluetooth", "USB"]),

        # 171 - гарантия
        (171, "какая гарантия даётся?", ["1 год", "5 лет"]),

        # 172 - аренда
        (172, "можно взять напрокат?", ["Аренды нет", "рассрочк"]),

        # 173 - доставка
        (173, "как доставите в регион?", ["InDriver", "Казахстан"]),

        # 174 - возврат
        (174, "какие условия возврата?", ["14", "дней"]),

        # 175 - разница моноблоков
        (175, "какая разница между pos моделями?", ["DUO", "Premium"]),

        # 176 - подбор
        (176, "что посоветуете для магазина?", ["Подбер", "формат"]),

        # 177 - 5 в 1
        (177, "из чего состоит 5 в 1?", ["сканер", "принтер", "экран"]),

        # 178 - весы работа
        (178, "как весы связаны с кассой?", ["кассу", "автоматически"]),

        # 179 - экран клиента
        (179, "можно ли нажимать на второй экран?", ["Нет", "клиент"]),

        # 180 - что такое ТИС
        (180, "расскажите про ТИС", ["ИП", "упрощёнк"]),

        # 181 - работа ТИС
        (181, "как функционирует ТИС?", ["учёт", "касс", "терминал"]),

        # 182 - отличие ТИС
        (182, "зачем ТИС если есть касса?", ["государств", "лимит"]),

        # 183 - малый оборот
        (183, "нужен ли ТИС при малых продажах?", ["рост", "оборот"]),

        # 184 - новый ИП
        (184, "стоит ли брать ТИС новичку?", ["сразу", "лимит"]),

        # 185 - ТОО
        (185, "подойдёт ли ТИС для ТОО?", ["Нет", "ИП"]),

        # 186 - законность
        (186, "ТИС это официально?", ["реестр", "официальн"]),

        # 187 - другие варианты
        (187, "что ещё можете предложить?", ["специалист", "свяж"]),

        # 188 - НДС порог
        (188, "можно ли ТИС после превышения НДС?", ["НДС", "полугод"]),

        # 189 - общий режим
        (189, "чем плох общий режим?", ["налогов", "бухгалтер"]),

        # 190 - кому подходит
        (190, "для кого создан ТИС?", ["ИП", "упрощёнк"]),

        # 191 - большие обороты
        (191, "спасёт ли ТИС от НДС?", ["лимит", "НДС"]),

        # 192 - услуги
        (192, "подходит ли ТИС для услуг?", ["Можно", "касс"]),

        # 193 - ОКЭД
        (193, "есть ли ограничения по видам деятельности?", ["Любые", "ограничен"]),

        # 194 - ресторан
        (194, "совместимо ли с iiko?", ["IIKO", "поддержив"]),

        # 195 - Kaspi
        (195, "что делать с каспи кассой?", ["снять", "задвоен"]),

        # 196 - для ТОО
        (196, "какое решение для ТОО?", ["Розниц", "ЭСФ"]),

        # 197 - порог
        (197, "насколько ТИС поднимает лимиты?", ["НДС", "повышает"]),

        # 198 - заработок
        (198, "сколько можно зарабатывать с ТИС?", ["лимит", "порог"]),

        # 199 - налоги
        (199, "в чём выгода ТИС по налогам?", ["упрощёнк", "систем"]),

        # 200 - прибыль
        (200, "как ТИС влияет на прибыль?", ["налогов", "прибыль"]),
    ]

    passed = 0
    failed = 0
    failed_cases = []

    for num, query, expected_words in test_cases:
        facts = retriever.retrieve(query, top_k=3)
        facts_lower = facts.lower()

        found_count = sum(1 for word in expected_words if word.lower() in facts_lower)
        min_required = max(1, len(expected_words) // 2)
        found = found_count >= min_required

        if found:
            passed += 1
            status = "✓"
        else:
            failed += 1
            status = "✗"
            failed_cases.append((num, query, expected_words, facts[:200]))

        print(f"{status} [{num}] '{query[:45]}...' ({found_count}/{len(expected_words)})")

    print()
    print("=" * 70)
    print(f"РЕЗУЛЬТАТ: {passed}/{passed+failed} тестов пройдено")
    print(f"ПОКРЫТИЕ: {passed/(passed+failed)*100:.1f}%")
    print("=" * 70)

    if failed_cases:
        print()
        print("ПРОВАЛЕННЫЕ ТЕСТЫ:")
        print("-" * 70)
        for num, query, expected, facts in failed_cases:
            print(f"\n[{num}] {query}")
            print(f"  Ожидалось: {expected}")
            print(f"  Получено: {facts}...")

    return passed, failed


if __name__ == "__main__":
    passed, failed = test_sections_v5()
    sys.exit(0 if failed == 0 else 1)
