#!/usr/bin/env python3
"""
Третий альтернативный тест покрытия секций 151-200.
Использует разговорные/клиентские формулировки запросов.
"""

import sys
sys.path.insert(0, 'src')

from knowledge.retriever import KnowledgeRetriever
from knowledge.data import WIPON_KNOWLEDGE


def test_sections_v3():
    """Третий альтернативный тест - разговорные запросы"""
    print("=" * 70)
    print("ТЕСТ V3: РАЗГОВОРНЫЕ ЗАПРОСЫ (151-200)")
    print("=" * 70)
    print()

    retriever = KnowledgeRetriever(use_embeddings=False)

    # Разговорные запросы как от реальных клиентов
    test_cases = [
        # 151 - подставка
        (151, "почём подставка?", ["3 000", "10 000"]),

        # 152 - комплекты
        (152, "хочу сразу всё в сборе, есть готовые наборы?", ["168 000", "Standard"]),

        # 153 - ТСД
        (153, "нужен портативный сканер для склада", ["25 000", "30 000"]),

        # 154 - свет
        (154, "а если электричество вырубят?", ["ИБП", "сети"]),

        # 155 - интернет
        (155, "к интернету как подрубить?", ["Wi-Fi", "LAN"]),

        # 156 - симка
        (156, "можно через мобильный интернет работать?", ["роутер", "4G"]),

        # 157 - софт
        (157, "я могу свою программу поставить?", ["совместим", "ПО"]),

        # 158 - предустановка
        (158, "программа уже стоит или надо ставить?", ["предустановлен", "готов"]),

        # 159 - весы отдельно
        (159, "только весы продаёте без всего остального?", ["можно", "Wipon"]),

        # 160 - весы и этикетки
        (160, "весы сами этикетку напечатают?", ["не печата", "Rongta"]),

        # 161 - настройка
        (161, "кто мне всё настроит?", ["AnyDesk", "удалённо"]),

        # 162 - мастер
        (162, "к нам кто-то приедет?", ["Выезд не требуется", "удалённо"]),

        # 163 - мышка
        (163, "мышку можно подключить?", ["USB", "можно"]),

        # 164 - цвет
        (164, "в белом цвете есть?", ["бел", "чёрн"]),

        # 165 - характеристики
        (165, "какой процессор в моноблоке?", ["i3", "i5", "RAM"]),

        # 166 - сканер specs
        (166, "сканер быстро считывает?", ["скан/сек", "1D"]),

        # 167 - принтер specs
        (167, "принтер чеков быстрый?", ["мм/сек", "dpi"]),

        # 168 - бумага чеки
        (168, "какую ленту покупать для чеков?", ["58 мм", "80 мм"]),

        # 169 - бумага этикетки
        (169, "какие этикетки подходят?", ["80 мм", "85"]),

        # 170 - блютуз
        (170, "принтер по блютузу подключается?", ["Bluetooth", "USB"]),

        # 171 - гарантия
        (171, "сколько гарантия?", ["1 год", "5 лет"]),

        # 172 - аренда
        (172, "в аренду даёте?", ["Аренды нет", "рассрочк"]),

        # 173 - доставка
        (173, "как получить если я не в Астане?", ["InDriver", "Казахстан"]),

        # 174 - возврат
        (174, "можно вернуть если не подойдёт?", ["14", "дней"]),

        # 175 - разница моноблоков
        (175, "в чём разница между моноблоками?", ["DUO", "Premium"]),

        # 176 - подбор
        (176, "какой мне подойдёт для небольшого магазина?", ["Подбер", "формат"]),

        # 177 - 5 в 1
        (177, "что значит 5 в 1?", ["сканер", "принтер", "экран"]),

        # 178 - весы работа
        (178, "весы сами вес передают?", ["кассу", "автоматически"]),

        # 179 - экран клиента
        (179, "покупатель может тыкать в экран?", ["Нет", "клиент"]),

        # 180 - что такое ТИС
        (180, "объясните что такое ТИС простыми словами", ["ИП", "упрощёнк"]),

        # 181 - работа ТИС
        (181, "как это всё работает технически?", ["учёт", "касс", "терминал"]),

        # 182 - отличие ТИС
        (182, "чем это лучше обычной кассы?", ["государств", "лимит"]),

        # 183 - малый оборот
        (183, "у меня пока мало продаж, нужен ли мне ТИС?", ["рост", "оборот"]),

        # 184 - новый ИП
        (184, "я только зарегистрировался как ИП", ["сразу", "лимит"]),

        # 185 - ТОО
        (185, "у меня ТОО, могу подключить?", ["Нет", "ИП"]),

        # 186 - законность
        (186, "это вообще легально?", ["реестр", "официальн"]),

        # 187 - другие варианты
        (187, "ничего из этого мне не подходит, есть ещё что-то?", ["специалист", "свяж"]),

        # 188 - НДС порог
        (188, "я уже превысил НДС в этом году", ["НДС", "полугод"]),

        # 189 - общий режим
        (189, "что будет если перейду на общую систему?", ["налогов", "бухгалтер"]),

        # 190 - кому подходит
        (190, "я вообще подхожу под ТИС?", ["ИП", "упрощёнк"]),

        # 191 - большие обороты
        (191, "обороты уже большие, поможет ли ТИС?", ["лимит", "НДС"]),

        # 192 - услуги
        (192, "я оказываю услуги, не торгую", ["Можно", "касс"]),

        # 193 - ОКЭД
        (193, "любой ОКЭД подойдёт?", ["Любые", "ограничен"]),

        # 194 - ресторан
        (194, "у меня кафе, работаете с iiko?", ["IIKO", "поддержив"]),

        # 195 - Kaspi
        (195, "у меня уже стоит каспи касса", ["снять", "задвоен"]),

        # 196 - для ТОО
        (196, "я ТОО, что мне взять вместо ТИС?", ["Розниц", "ЭСФ"]),

        # 197 - порог
        (197, "на сколько повышается лимит?", ["НДС", "повышает"]),

        # 198 - заработок
        (198, "сколько можно оборота делать с ТИС?", ["лимит", "порог"]),

        # 199 - налоги
        (199, "какая выгода по налогам?", ["упрощёнк", "систем"]),

        # 200 - прибыль
        (200, "реально больше зарабатывать?", ["налогов", "прибыль"]),
    ]

    passed = 0
    failed = 0
    failed_cases = []

    for num, query, expected_words in test_cases:
        facts = retriever.retrieve(query, top_k=3)
        facts_lower = facts.lower()

        found_count = sum(1 for word in expected_words if word.lower() in facts_lower)
        min_required = max(1, len(expected_words) // 2)
        found = found_count >= min_required

        if found:
            passed += 1
            status = "✓"
        else:
            failed += 1
            status = "✗"
            failed_cases.append((num, query, expected_words, facts[:200]))

        print(f"{status} [{num}] '{query[:45]}...' ({found_count}/{len(expected_words)})")

    print()
    print("=" * 70)
    print(f"РЕЗУЛЬТАТ: {passed}/{passed+failed} тестов пройдено")
    print(f"ПОКРЫТИЕ: {passed/(passed+failed)*100:.1f}%")
    print("=" * 70)

    if failed_cases:
        print()
        print("ПРОВАЛЕННЫЕ ТЕСТЫ:")
        print("-" * 70)
        for num, query, expected, facts in failed_cases:
            print(f"\n[{num}] {query}")
            print(f"  Ожидалось: {expected}")
            print(f"  Получено: {facts}...")

    return passed, failed


if __name__ == "__main__":
    passed, failed = test_sections_v3()
    sys.exit(0 if failed == 0 else 1)
