#!/usr/bin/env python3
"""
Четвёртый альтернативный тест покрытия секций 151-200.
Использует короткие/прямые запросы как в чате.
"""

import sys
sys.path.insert(0, 'src')

from knowledge.retriever import KnowledgeRetriever
from knowledge.data import WIPON_KNOWLEDGE


def test_sections_v4():
    """Четвёртый альтернативный тест - короткие запросы"""
    print("=" * 70)
    print("ТЕСТ V4: КОРОТКИЕ ЗАПРОСЫ (151-200)")
    print("=" * 70)
    print()

    retriever = KnowledgeRetriever(use_embeddings=False)

    # Короткие запросы как в реальном чате
    test_cases = [
        # 151 - подставка
        (151, "подставка сканер цена", ["3 000", "10 000"]),

        # 152 - комплекты
        (152, "готовые комплекты стоимость", ["168 000", "Standard"]),

        # 153 - ТСД
        (153, "тсд pocket smart цена", ["25 000", "30 000"]),

        # 154 - свет
        (154, "без электричества работает?", ["ИБП", "сети"]),

        # 155 - интернет
        (155, "wifi lan подключение", ["Wi-Fi", "LAN"]),

        # 156 - симка
        (156, "симка 4g роутер", ["роутер", "4G"]),

        # 157 - софт
        (157, "другое по совместимость", ["совместим", "ПО"]),

        # 158 - предустановка
        (158, "wipon уже установлен?", ["предустановлен", "готов"]),

        # 159 - весы отдельно
        (159, "весы отдельно купить", ["можно", "Wipon"]),

        # 160 - весы и этикетки
        (160, "весы wipon печатают?", ["не печата", "Rongta"]),

        # 161 - настройка
        (161, "настройка anydesk удалённо", ["AnyDesk", "удалённо"]),

        # 162 - мастер
        (162, "выезд мастера нужен?", ["Выезд не требуется", "удалённо"]),

        # 163 - мышка
        (163, "usb мышь клавиатура", ["USB", "можно"]),

        # 164 - цвет
        (164, "моноблок белый чёрный", ["бел", "чёрн"]),

        # 165 - характеристики
        (165, "pos i3 i5 характеристики", ["i3", "i5", "RAM"]),

        # 166 - сканер specs
        (166, "сканер скорость 1d 2d", ["скан/сек", "1D"]),

        # 167 - принтер specs
        (167, "принтер dpi скорость", ["мм/сек", "dpi"]),

        # 168 - бумага чеки
        (168, "термолента 58 80 мм", ["58 мм", "80 мм"]),

        # 169 - бумага этикетки
        (169, "этикетки ширина размер", ["80 мм", "85"]),

        # 170 - блютуз
        (170, "bluetooth принтер нет?", ["Bluetooth", "USB"]),

        # 171 - гарантия
        (171, "гарантия 1 год zebra", ["1 год", "5 лет"]),

        # 172 - аренда
        (172, "аренда рассрочка есть?", ["Аренды нет", "рассрочк"]),

        # 173 - доставка
        (173, "доставка indriver астана", ["InDriver", "Казахстан"]),

        # 174 - возврат
        (174, "возврат 14 дней условия", ["14", "дней"]),

        # 175 - разница моноблоков
        (175, "duo premium отличия", ["DUO", "Premium"]),

        # 176 - подбор
        (176, "подобрать моноблок магазин", ["Подбер", "формат"]),

        # 177 - 5 в 1
        (177, "wipon 5 в 1 комплектация", ["сканер", "принтер", "экран"]),

        # 178 - весы работа
        (178, "весы показания касса", ["кассу", "автоматически"]),

        # 179 - экран клиента
        (179, "экран покупателя сенсорный?", ["Нет", "клиент"]),

        # 180 - что такое ТИС
        (180, "тис упрощёнка ип", ["ИП", "упрощёнк"]),

        # 181 - работа ТИС
        (181, "тис касса терминал учёт", ["учёт", "касс", "терминал"]),

        # 182 - отличие ТИС
        (182, "тис преимущества лимит", ["государств", "лимит"]),

        # 183 - малый оборот
        (183, "маленький оборот тис стоит?", ["рост", "оборот"]),

        # 184 - новый ИП
        (184, "новый ип тис сразу", ["сразу", "лимит"]),

        # 185 - ТОО
        (185, "тоо тис подходит?", ["Нет", "ИП"]),

        # 186 - законность
        (186, "тис реестр официально", ["реестр", "официальн"]),

        # 187 - другие варианты
        (187, "консультация специалист связь", ["специалист", "свяж"]),

        # 188 - НДС порог
        (188, "ндс превысил полугодие", ["НДС", "полугод"]),

        # 189 - общий режим
        (189, "общий режим налоги бухгалтер", ["налогов", "бухгалтер"]),

        # 190 - кому подходит
        (190, "тис требования кому", ["ИП", "упрощёнк"]),

        # 191 - большие обороты
        (191, "высокий оборот ндс лимит", ["лимит", "НДС"]),

        # 192 - услуги
        (192, "услуги тис касса", ["Можно", "касс"]),

        # 193 - ОКЭД
        (193, "окэд ограничения тис", ["Любые", "ограничен"]),

        # 194 - ресторан
        (194, "ресторан iiko тис", ["IIKO", "поддержив"]),

        # 195 - Kaspi
        (195, "kaspi касса снять тис", ["снять", "задвоен"]),

        # 196 - для ТОО
        (196, "тоо розница эсф снт", ["Розниц", "ЭСФ"]),

        # 197 - порог
        (197, "тис порог ндс повышает", ["НДС", "повышает"]),

        # 198 - заработок
        (198, "тис максимум доход лимит", ["лимит", "порог"]),

        # 199 - налоги
        (199, "тис налоги упрощёнка выгода", ["упрощёнк", "систем"]),

        # 200 - прибыль
        (200, "тис прибыль налоги экономия", ["налогов", "прибыль"]),
    ]

    passed = 0
    failed = 0
    failed_cases = []

    for num, query, expected_words in test_cases:
        facts = retriever.retrieve(query, top_k=3)
        facts_lower = facts.lower()

        found_count = sum(1 for word in expected_words if word.lower() in facts_lower)
        min_required = max(1, len(expected_words) // 2)
        found = found_count >= min_required

        if found:
            passed += 1
            status = "✓"
        else:
            failed += 1
            status = "✗"
            failed_cases.append((num, query, expected_words, facts[:200]))

        print(f"{status} [{num}] '{query[:45]}...' ({found_count}/{len(expected_words)})")

    print()
    print("=" * 70)
    print(f"РЕЗУЛЬТАТ: {passed}/{passed+failed} тестов пройдено")
    print(f"ПОКРЫТИЕ: {passed/(passed+failed)*100:.1f}%")
    print("=" * 70)

    if failed_cases:
        print()
        print("ПРОВАЛЕННЫЕ ТЕСТЫ:")
        print("-" * 70)
        for num, query, expected, facts in failed_cases:
            print(f"\n[{num}] {query}")
            print(f"  Ожидалось: {expected}")
            print(f"  Получено: {facts}...")

    return passed, failed


if __name__ == "__main__":
    passed, failed = test_sections_v4()
    sys.exit(0 if failed == 0 else 1)
