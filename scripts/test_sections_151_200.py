#!/usr/bin/env python3
"""
Тест покрытия секций 151-200 базы знаний.
"""

import sys
sys.path.insert(0, 'src')

from knowledge.retriever import KnowledgeRetriever
from knowledge.data import WIPON_KNOWLEDGE


def test_sections_151_200():
    """Тест покрытия секций 151-200"""
    print("=" * 70)
    print("ТЕСТ ПОКРЫТИЯ СЕКЦИЙ 151-200")
    print("=" * 70)
    print()

    retriever = KnowledgeRetriever(use_embeddings=False)

    # Тестовые запросы для секций 151-200
    # Формат: (номер, запрос, ожидаемые слова в ответе)
    test_cases = [
        # 151 - подставка под сканер
        (151, "Сколько стоит подставка под сканер?", ["3 000", "10 000", "ZEBRA"]),

        # 152 - комплекты
        (152, "Сколько стоят комплекты?", ["168 000", "219 000", "Standard"]),

        # 153 - ТСД
        (153, "Сколько стоит ТСД?", ["25 000", "30 000", "Pocket"]),

        # 154 - отключение света
        (154, "Если свет выключится, оборудование будет работать?", ["ИБП", "сети", "перебо"]),

        # 155 - интернет
        (155, "Какое подключение к интернету?", ["Wi-Fi", "LAN", "кабел"]),

        # 156 - сим-карта
        (156, "А сим-карта вставляется?", ["Сим-карта", "4G", "роутер"]),

        # 157 - другая программа
        (157, "Можно ли подключить другую программу?", ["совместим", "ПО", "Wipon"]),

        # 158 - программа встроена
        (158, "Программа учёта встроена уже?", ["предустановлен", "готов", "подключ"]),

        # 159 - весы без программы
        (159, "Можно ли купить просто весы без программы?", ["можно", "Wipon", "вручную"]),

        # 160 - умные весы печатают
        (160, "А умные весы печатают штрих-код?", ["не печата", "Rongta", "принтер"]),

        # 161 - настройка оборудования
        (161, "Кто настроит оборудование?", ["AnyDesk", "удалённо", "настро"]),

        # 162 - выезд
        (162, "Вы сами приходите настраиваете?", ["Выезд не требуется", "удалённо", "AnyDesk"]),

        # 163 - клавиатура и мышь
        (163, "Можно ли подключить клавиатуру и мышь?", ["USB", "можно", "сенсорн"]),

        # 164 - цвета моноблоков
        (164, "Каких цветов есть моноблоки?", ["чёрн", "бел", "POS i"]),

        # 165 - характеристики моноблоков
        (165, "Какие характеристики у моноблоков?", ["i3", "i5", "SSD", "RAM"]),

        # 166 - характеристики сканеров
        (166, "Какие характеристики у сканеров?", ["скан/сек", "1D", "2D"]),

        # 167 - характеристики принтеров
        (167, "Какие характеристики у принтеров чеков?", ["dpi", "мм/сек", "X-printer"]),

        # 168 - размер бумаги для чеков
        (168, "Какой нужен размер бумаги для принтера чеков?", ["58 мм", "80 мм", "лента"]),

        # 169 - размер бумаги для этикеток
        (169, "Какой нужен размер бумаги для принтера этикеток?", ["80 мм", "85 мм", "Термо"]),

        # 170 - bluetooth принтер
        (170, "Я могу подключить принтер чеков по Bluetooth?", ["Нет", "Bluetooth", "USB"]),

        # 171 - гарантия
        (171, "Есть ли гарантия на оборудование?", ["1 год", "5 лет", "Zebra"]),

        # 172 - аренда
        (172, "В аренду оборудование сдаёте?", ["Аренды нет", "рассрочк", "12 месяцев"]),

        # 173 - доставка
        (173, "Доставка как осуществляется?", ["InDriver", "Астан", "40 000"]),

        # 174 - возврат
        (174, "Как делается возврат?", ["14", "дней", "комплект"]),

        # 175 - отличия моноблоков
        (175, "Чем отличаются моноблоки между собой?", ["DUO", "Premium", "экран"]),

        # 176 - моноблок для бизнеса
        (176, "Какие моноблоки подходят для разных видов деятельности?", ["Подбер", "формат", "нагрузк"]),

        # 177 - что входит в 5 в 1
        (177, "Что входит в 5 в 1?", ["экран", "сканер", "принтер"]),

        # 178 - как работают весы
        (178, "Как работают весы?", ["кассу", "Показания", "ввод"]),

        # 179 - второй экран сенсорный
        (179, "Второй экран сенсорный?", ["Нет", "клиент", "кассир"]),

        # 180 - что такое ТИС
        (180, "Что такое ТИС и зачем он нужен?", ["ИП", "упрощёнк", "лимит"]),

        # 181 - как работает ТИС
        (181, "Как работает ТИС?", ["учёт", "касс", "терминал"]),

        # 182 - ТИС vs обычная касса
        (182, "Чем ТИС отличается от обычной кассы?", ["государств", "лимит", "упрощёнк"]),

        # 183 - ТИС при малых оборотах
        (183, "А если у меня небольшие обороты — стоит ли подключать ТИС?", ["рост", "оборот", "защит"]),

        # 184 - ТИС для нового ИП
        (184, "А если я только открываю ИП — стоит ли сразу подключить ТИС?", ["сразу", "лимит", "схем"]),

        # 185 - ТИС для ТОО
        (185, "А если я зарегистрирован как ТОО — смогу ли использовать ТИС?", ["Нет", "ИП", "упрощёнк"]),

        # 186 - ТИС законно
        (186, "Есть ли у ТИС юридическое обоснование?", ["реестр", "2021", "официальн"]),

        # 187 - консультация
        (187, "Мне не подходит ни розничный налог, ни ТИС", ["специалист", "свяж", "решени"]),

        # 188 - ТИС и порог НДС
        (188, "Я могу подключить ТИС если превысил порог по НДС?", ["НДС", "полугод", "упрощёнк"]),

        # 189 - опасность общего режима
        (189, "Чем опасен переход на общеустановленный режим?", ["налогов", "бухгалтер", "штраф"]),

        # 190 - кому подходит ТИС
        (190, "Кому подходит ТИС?", ["ИП", "упрощёнк", "ТОО"]),

        # 191 - ТИС при больших оборотах
        (191, "Если у меня уже большие обороты — поможет ли ТИС?", ["лимит", "НДС", "превышен"]),

        # 192 - ТИС для услуг
        (192, "У нас услуги, можно ли подключить ТИС?", ["Можно", "касс", "терминал"]),

        # 193 - какие ОКЭД
        (193, "Какие ОКЭД могут подключить ТИС?", ["Любые", "ИП", "ограничен"]),

        # 194 - ресторан и IIKO
        (194, "У меня ресторан, могу ли подключить ТИС и интегрировать с IIKO?", ["ИП", "IIKO", "поддержив"]),

        # 195 - Kaspi касса
        (195, "У меня есть Kaspi касса — могу ли подключить ТИС?", ["снять", "учёт", "задвоен"]),

        # 196 - альтернатива для ТОО
        (196, "У меня ТОО, ТИС не подходит. Что предложите?", ["Розниц", "ЭСФ", "СНТ"]),

        # 197 - ТИС увеличивает порог
        (197, "Я слышал, что ТИС увеличивает порог. Насколько?", ["НДС", "повышает", "норм"]),

        # 198 - сколько можно зарабатывать
        (198, "Сколько я смогу зарабатывать с ТИС?", ["лимит", "порог", "переход"]),

        # 199 - налоговые преимущества
        (199, "Какие преимущества ТИС даёт в плане налогообложения?", ["упрощёнк", "оборот", "систем"]),

        # 200 - увеличить прибыль
        (200, "А реально ли увеличить чистую прибыль в 5 раз?", ["налогов", "оборот", "прибыль"]),
    ]

    passed = 0
    failed = 0
    failed_cases = []

    for num, query, expected_words in test_cases:
        facts = retriever.retrieve(query, top_k=3)
        facts_lower = facts.lower()

        found_count = sum(1 for word in expected_words if word.lower() in facts_lower)
        # Считаем успехом если найдено хотя бы 2 из ожидаемых слов
        found = found_count >= 2

        if found:
            passed += 1
            status = "✓"
        else:
            failed += 1
            status = "✗"
            failed_cases.append((num, query, expected_words, facts[:200]))

        print(f"{status} [{num}] '{query[:50]}...' ({found_count}/{len(expected_words)} слов)")

    print()
    print("=" * 70)
    print(f"РЕЗУЛЬТАТ: {passed}/{passed+failed} тестов пройдено")
    print(f"ПОКРЫТИЕ: {passed/(passed+failed)*100:.1f}%")
    print("=" * 70)

    if failed_cases:
        print()
        print("ПРОВАЛЕННЫЕ ТЕСТЫ:")
        print("-" * 70)
        for num, query, expected, facts in failed_cases:
            print(f"\n[{num}] {query}")
            print(f"  Ожидалось: {expected}")
            print(f"  Получено: {facts}...")

    return passed, failed


def check_sections_exist():
    """Проверяем что все секции 151-200 существуют"""
    print("=" * 70)
    print("ПРОВЕРКА НАЛИЧИЯ СЕКЦИЙ 151-200")
    print("=" * 70)
    print()

    expected_topics = [
        "pricing_scanner_stand_151",
        "pricing_bundles_152",
        "pricing_tsd_153",
        "equipment_power_outage_154",
        "equipment_internet_connection_155",
        "equipment_sim_card_156",
        "equipment_other_software_157",
        "equipment_preinstalled_software_158",
        "equipment_scales_without_software_159",
        "equipment_smart_scales_printing_160",
        "support_equipment_setup_161",
        "support_onsite_setup_162",
        "equipment_keyboard_mouse_163",
        "equipment_monoblock_colors_164",
        "equipment_monoblock_specs_165",
        "equipment_scanner_specs_166",
        "equipment_printer_specs_167",
        "equipment_receipt_paper_size_168",
        "equipment_label_paper_size_169",
        "equipment_bluetooth_printer_170",
        "equipment_warranty_171",
        "pricing_rental_172",
        "regions_delivery_173",
        "faq_return_policy_174",
        "equipment_monoblock_differences_175",
        "equipment_monoblock_for_business_176",
        "equipment_5in1_contents_177",
        "equipment_scales_how_work_178",
        "equipment_second_screen_touch_179",
        "tis_what_is_180",
        "tis_how_works_181",
        "tis_vs_regular_182",
        "tis_small_turnover_183",
        "tis_new_ip_184",
        "tis_too_185",
        "tis_legal_186",
        "support_consultation_187",
        "tis_nds_threshold_188",
        "tis_general_regime_danger_189",
        "tis_who_suits_190",
        "tis_high_turnover_191",
        "tis_services_192",
        "tis_oked_193",
        "tis_restaurant_iiko_194",
        "tis_kaspi_kassa_195",
        "tis_too_alternative_196",
        "tis_threshold_increase_197",
        "tis_earning_limit_198",
        "tis_tax_benefits_199",
        "tis_profit_increase_200",
    ]

    all_topics = [s.topic for s in WIPON_KNOWLEDGE.sections]

    found = 0
    missing = []

    for topic in expected_topics:
        if topic in all_topics:
            found += 1
            print(f"✓ {topic}")
        else:
            missing.append(topic)
            print(f"✗ {topic} - НЕ НАЙДЕН!")

    print()
    print(f"Найдено: {found}/{len(expected_topics)} секций")

    if missing:
        print(f"\nОтсутствуют: {missing}")

    return found == len(expected_topics)


if __name__ == "__main__":
    # Сначала проверяем наличие секций
    sections_ok = check_sections_exist()
    print()

    if sections_ok:
        # Затем тестируем поиск
        passed, failed = test_sections_151_200()

        # Код выхода
        sys.exit(0 if failed == 0 else 1)
    else:
        print("ОШИБКА: Не все секции найдены в базе!")
        sys.exit(1)
